<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="theme-color" content="#e91e63" />
        <title>Chu Kỳ 🌸</title>
        <!-- Manifest placeholder - sẽ được tạo động bởi JavaScript -->
        <link id="manifest-placeholder" rel="manifest" />
        <!-- Critical CSS inline for better performance -->
        <style>
            /* ===== ENHANCED CSS VARIABLES ===== */
            :root {
                /* Enhanced Color Palette */
                --primary-gradient: linear-gradient(135deg, #ff9ec7 0%, #ffb6d9 50%, #ffc9e6 100%);
                --dark-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
                --glass-gradient: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
                --glass-gradient-dark: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
                /* Enhanced Text Colors */
                --text-primary: #2d3748;
                --text-secondary: #4a5568;
                --text-light: #718096;
                --text-dark-primary: #f7fafc;
                --text-dark-secondary: #e2e8f0;
                --text-dark-light: #a0aec0;
                /* Enhanced Background Colors */
                --bg-card: rgba(255, 255, 255, 0.95);
                --bg-card-dark: rgba(255, 255, 255, 0.08);
                --bg-glass: rgba(255, 255, 255, 0.2);
                --bg-glass-dark: rgba(255, 255, 255, 0.05);
                --bg-overlay: rgba(0, 0, 0, 0.6);
                --bg-input: #f8fafc;
                --bg-input-dark: rgba(255, 255, 255, 0.1);
                /* Enhanced Brand Colors */
                --accent-color: #e91e63;
                --accent-hover: #d81b60;
                --accent-light: #f8bbd9;
                --secondary-color: #9c27b0;
                --secondary-hover: #7b1fa2;
                --success-color: #10b981;
                --warning-color: #f59e0b;
                --danger-color: #ef4444;
                --info-color: #3b82f6;
                /* Enhanced Cycle Colors with gradients */
                --period-color: #e91e63;
                --period-gradient: linear-gradient(135deg, #e91e63, #d81b60);
                --fertile-color: #10b981;
                --fertile-gradient: linear-gradient(135deg, #10b981, #059669);
                --ovulation-color: #9c27b0;
                --ovulation-gradient: linear-gradient(135deg, #9c27b0, #7b1fa2);
                --expected-period: rgba(233, 30, 99, 0.15);
                --expected-border: #e91e63;
                /* Enhanced Shadows */
                --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
                --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
                --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
                --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
                --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
                --shadow-2xl: 0 25px 50px rgba(0, 0, 0, 0.25);
                --shadow-focus: 0 0 0 3px rgba(233, 30, 99, 0.1);
                --shadow-glow: 0 0 20px rgba(233, 30, 99, 0.3);
                /* Enhanced Transitions */
                --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
                --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                --transition-slow: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                --transition-bounce: 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                /* Enhanced Spacing Scale */
                --space-0: 0;
                --space-1: 0.25rem;
                --space-2: 0.5rem;
                --space-3: 0.75rem;
                --space-4: 1rem;
                --space-5: 1.25rem;
                --space-6: 1.5rem;
                --space-8: 2rem;
                --space-10: 2.5rem;
                --space-12: 3rem;
                --space-16: 4rem;
                --space-20: 5rem;
                /* Enhanced Border Radius */
                --radius-none: 0;
                --radius-sm: 0.125rem;
                --radius-md: 0.375rem;
                --radius-lg: 0.5rem;
                --radius-xl: 0.75rem;
                --radius-2xl: 1rem;
                --radius-3xl: 1.5rem;
                --radius-full: 9999px;
                /* Enhanced Typography */
                --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                --font-mono: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
                /* Enhanced Z-Index Scale */
                --z-dropdown: 1000;
                --z-sticky: 1020;
                --z-fixed: 1030;
                --z-modal-backdrop: 1040;
                --z-modal: 1050;
                --z-popover: 1060;
                --z-tooltip: 1070;
                --z-toast: 3000;
            }

            /* ===== ENHANCED RESET & BASE STYLES ===== */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            /* Critical CSS for initial render */
            body {
                margin: 0;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #ff9ec7, #ffb6d9, #ffc9e6);
                min-height: 100vh;
            }

            .loading-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #e91e63, #9c27b0);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                color: white;
            }

            .loading-spinner {
                width: 60px;
                height: 60px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top: 4px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            .loading-text {
                font-size: 1.2rem;
                font-weight: 500;
                text-align: center;
            }

            html {
                font-size: 16px;
                scroll-behavior: smooth;
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                font-family: var(--font-family);
                background: var(--primary-gradient);
                color: var(--text-primary);
                line-height: 1.6;
                padding-bottom: 80px;
                min-height: 100vh;
                transition: all var(--transition-normal);
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                overflow-x: hidden;
                position: relative;
            }

            body::before {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle at 20% 50%, rgba(233, 30, 99, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(156, 39, 176, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 40% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
                pointer-events: none;
                z-index: -1;
            }

            body.theme-dark {
                background: var(--dark-gradient);
                color: var(--text-dark-primary);
            }

            body.theme-dark::before {
                background: radial-gradient(circle at 20% 50%, rgba(233, 30, 99, 0.05) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(156, 39, 176, 0.05) 0%, transparent 50%),
                    radial-gradient(circle at 40% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            }

            @media (prefers-color-scheme: dark) {
                body.theme-auto {
                    background: var(--dark-gradient);
                    color: var(--text-dark-primary);
                }

                body.theme-auto::before {
                    background: radial-gradient(circle at 20% 50%, rgba(233, 30, 99, 0.05) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(156, 39, 176, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
                }
            }

            /* ===== ENHANCED CONTAINER ===== */
            .container {
                max-width: min(420px, 100vw);
                margin: 0 auto;
                padding: 0 var(--space-4);
                position: relative;
            }

            /* ===== ENHANCED APP HEADER ===== */
            .app-header {
                text-align: center;
                padding: var(--space-8) var(--space-6);
                background: var(--glass-gradient);
                border-radius: var(--radius-3xl);
                margin: var(--space-6) 0;
                position: relative;
                overflow: hidden;
                box-shadow: var(--shadow-xl);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                transform: translateY(0);
                transition: all var(--transition-normal);
            }

            .app-header:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-2xl);
            }

            body.theme-dark .app-header {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .app-title {
                font-size: clamp(2rem, 6vw, 2.5rem);
                font-weight: 800;
                background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: var(--space-2);
                letter-spacing: -0.02em;
                text-shadow: 0 0 30px rgba(233, 30, 99, 0.3);
            }

            .app-subtitle {
                font-size: clamp(0.9rem, 3vw, 1.1rem);
                color: var(--text-secondary);
                font-weight: 500;
                margin-bottom: var(--space-6);
                opacity: 0.9;
            }

            body.theme-dark .app-subtitle {
                color: var(--text-dark-secondary);
            }

            /* Enhanced Header Stats */
            .header-stats {
                display: flex;
                justify-content: center;
                gap: var(--space-8);
                margin-top: var(--space-4);
            }

            .header-stat-item {
                text-align: center;
                padding: var(--space-3) var(--space-4);
                background: rgba(255, 255, 255, 0.2);
                border-radius: var(--radius-xl);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                transition: all var(--transition-fast);
            }

            .header-stat-item:hover {
                transform: translateY(-2px);
                background: rgba(255, 255, 255, 0.3);
            }

            body.theme-dark .header-stat-item {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .stat-number {
                display: block;
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--accent-color);
                line-height: 1;
            }

            .stat-label {
                display: block;
                font-size: 0.75rem;
                color: var(--text-secondary);
                margin-top: var(--space-1);
                font-weight: 500;
            }

            body.theme-dark .stat-label {
                color: var(--text-dark-secondary);
            }

            /* ===== ENHANCED FLOWER DECORATIONS ===== */
            .flower-decoration {
                position: absolute;
                font-size: clamp(1.5rem, 4vw, 2rem);
                opacity: 0.6;
                pointer-events: none;
                will-change: transform;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            }

            .flower-1 {
                top: 10%;
                left: 8%;
                animation: float 6s ease-in-out infinite;
            }

            .flower-2 {
                top: 15%;
                right: 12%;
                animation: float 6s ease-in-out infinite 1s;
            }

            .flower-3 {
                bottom: 20%;
                left: 15%;
                animation: float 6s ease-in-out infinite 2s;
            }

            .flower-4 {
                bottom: 15%;
                right: 10%;
                animation: float 6s ease-in-out infinite 3s;
            }

            .flower-5 {
                top: 50%;
                left: 5%;
                animation: float 6s ease-in-out infinite 4s;
            }

            .flower-6 {
                top: 60%;
                right: 8%;
                animation: float 6s ease-in-out infinite 5s;
            }

            @keyframes float {

                0%,
                100% {
                    transform: translateY(0px) rotate(0deg) scale(1);
                }

                25% {
                    transform: translateY(-8px) rotate(2deg) scale(1.05);
                }

                50% {
                    transform: translateY(-4px) rotate(-1deg) scale(0.95);
                }

                75% {
                    transform: translateY(-12px) rotate(1deg) scale(1.02);
                }
            }

            /* ===== ENHANCED MAIN CONTENT ===== */
            .main-content {
                background: var(--glass-gradient);
                border-radius: var(--radius-3xl);
                padding: var(--space-8);
                margin: var(--space-6) 0;
                box-shadow: var(--shadow-xl);
                transition: all var(--transition-normal);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                position: relative;
                overflow: hidden;
            }

            .main-content::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            }

            body.theme-dark .main-content {
                background: var(--glass-gradient-dark) !important;
                border-color: rgba(255, 255, 255, 0.1) !important;
            }

            /* ===== SECTION MANAGEMENT ===== */
            .section {
                display: none;
            }

            .section.active {
                display: block;
            }

            .section-title {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: var(--space-6);
                display: flex;
                align-items: center;
                gap: var(--space-3);
            }

            body.theme-dark .section-title {
                color: var(--text-dark-primary);
            }

            .section-title i {
                color: var(--accent-color);
                font-size: 1.3rem;
            }

            /* ===== ENHANCED COUNTDOWN CIRCLE ===== */
            .countdown-container {
                display: flex;
                justify-content: center;
                align-items: center;
                margin: var(--space-10) 0;
                position: relative;
            }

            .countdown-circle {
                width: clamp(200px, 50vw, 240px);
                height: clamp(200px, 50vw, 240px);
                border-radius: var(--radius-full);
                background: var(--glass-gradient);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                box-shadow: var(--shadow-2xl);
                position: relative;
                cursor: pointer;
                transition: all var(--transition-normal);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 3px solid rgba(255, 255, 255, 0.3);
                overflow: hidden;
            }

            .countdown-circle::before {
                content: "";
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: conic-gradient(from 0deg, var(--accent-color), var(--secondary-color), var(--accent-color));
                animation: rotate 10s linear infinite;
                opacity: 0.1;
            }

            @keyframes rotate {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }
            }

            .countdown-circle:hover {
                transform: scale(1.02);
                box-shadow: var(--shadow-glow), var(--shadow-2xl);
            }

            .countdown-circle:active {
                transform: scale(0.98);
            }

            body.theme-dark .countdown-circle {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.2);
            }

            /* Enhanced Progress Ring */
            .countdown-progress-ring {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transform: rotate(-90deg);
            }

            .progress-ring {
                width: 100%;
                height: 100%;
            }

            .progress-ring-circle {
                fill: none;
                stroke: var(--accent-color);
                stroke-width: 4;
                stroke-linecap: round;
                stroke-dasharray: 565;
                stroke-dashoffset: 565;
                transition: stroke-dashoffset var(--transition-slow);
                filter: drop-shadow(0 0 6px rgba(233, 30, 99, 0.5));
            }

            /* Enhanced Countdown Content */
            .countdown-content {
                position: relative;
                z-index: 2;
                text-align: center;
            }

            .countdown-number {
                font-size: clamp(3rem, 12vw, 4rem);
                font-weight: 900;
                color: var(--text-primary);
                line-height: 1;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                margin-bottom: var(--space-2);
            }

            body.theme-dark .countdown-number {
                color: var(--text-dark-primary);
            }

            .countdown-text {
                font-size: clamp(0.8rem, 2.5vw, 0.9rem);
                color: var(--text-secondary);
                text-align: center;
                font-weight: 500;
                line-height: 1.3;
                margin-bottom: var(--space-3);
            }

            body.theme-dark .countdown-text {
                color: var(--text-dark-secondary);
            }

            .countdown-phase {
                font-size: 0.75rem;
                color: var(--accent-color);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                padding: var(--space-1) var(--space-3);
                background: rgba(233, 30, 99, 0.1);
                border-radius: var(--radius-full);
                border: 1px solid rgba(233, 30, 99, 0.2);
            }

            /* Enhanced Log Period Button */
            .log-period-btn {
                background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
                color: white;
                border: none;
                padding: var(--space-3) var(--space-6);
                border-radius: var(--radius-full);
                font-size: 0.85rem;
                font-weight: 600;
                cursor: pointer;
                transition: all var(--transition-normal);
                touch-action: manipulation;
                box-shadow: var(--shadow-lg);
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
                position: relative;
                overflow: hidden;
                margin-top: var(--space-4);
            }

            .log-period-btn::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left var(--transition-slow);
            }

            .log-period-btn:hover::before {
                left: 100%;
            }

            .log-period-btn:hover {
                background: linear-gradient(135deg, var(--accent-hover), #c2185b);
                transform: translateY(-2px);
                box-shadow: var(--shadow-glow), var(--shadow-xl);
            }

            .log-period-btn:active {
                transform: translateY(0);
            }

            /* Enhanced Pulse Animation */
            .pulse-animation {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.8;
                }
            }

            /* ===== ENHANCED QUICK ACTIONS CIRCLE ===== */
            .quick-actions-circle {
                position: absolute;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }

            .quick-action-btn {
                position: absolute;
                width: 48px;
                height: 48px;
                border-radius: var(--radius-full);
                background: var(--glass-gradient);
                border: 2px solid rgba(255, 255, 255, 0.3);
                color: var(--accent-color);
                cursor: pointer;
                transition: all var(--transition-normal);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                box-shadow: var(--shadow-lg);
                pointer-events: auto;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
            }

            .quick-action-btn:hover {
                transform: scale(1.1);
                background: var(--accent-color);
                color: white;
                box-shadow: var(--shadow-glow);
            }

            body.theme-dark .quick-action-btn {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.2);
            }

            /* Position quick action buttons */
            .quick-action-1 {
                top: 10%;
                right: 20%;
            }

            .quick-action-2 {
                right: 10%;
                top: 50%;
                transform: translateY(-50%);
            }

            .quick-action-3 {
                bottom: 10%;
                right: 20%;
            }

            .quick-action-4 {
                left: 10%;
                top: 50%;
                transform: translateY(-50%);
            }

            /* ===== ENHANCED CALENDAR SECTION ===== */
            .calendar-section {
                margin: var(--space-8) 0;
                background: var(--glass-gradient);
                border-radius: var(--radius-2xl);
                padding: var(--space-6);
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: var(--shadow-lg);
                position: relative;
                overflow: hidden;
            }

            .calendar-section::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(90deg, var(--accent-color), var(--secondary-color), var(--accent-color));
                opacity: 0.6;
            }

            body.theme-dark .calendar-section {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.1);
            }

            /* Enhanced Calendar Header */
            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--space-6);
                padding: 0 var(--space-2);
            }

            .calendar-title-container {
                text-align: center;
                flex: 1;
            }

            .calendar-title {
                font-size: clamp(1.3rem, 4vw, 1.6rem);
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: var(--space-1);
                background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            body.theme-dark .calendar-title {
                color: var(--text-dark-primary);
            }

            .calendar-subtitle {
                font-size: 0.8rem;
                color: var(--text-secondary);
                font-weight: 500;
                opacity: 0.8;
            }

            body.theme-dark .calendar-subtitle {
                color: var(--text-dark-secondary);
            }

            .calendar-nav-btn {
                background: var(--glass-gradient);
                border: 2px solid rgba(255, 255, 255, 0.3);
                font-size: 1.2rem;
                cursor: pointer;
                color: var(--accent-color);
                padding: var(--space-3);
                border-radius: var(--radius-full);
                transition: all var(--transition-fast);
                touch-action: manipulation;
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                box-shadow: var(--shadow-md);
            }

            .calendar-nav-btn:hover {
                background: var(--accent-color);
                color: white;
                transform: scale(1.05);
                box-shadow: var(--shadow-lg);
            }

            .calendar-nav-btn:active {
                transform: scale(0.95);
            }

            body.theme-dark .calendar-nav-btn {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.2);
            }

            /* Enhanced Calendar Grid */
            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: var(--space-2);
                margin-bottom: var(--space-6);
            }

            .weekday {
                text-align: center;
                font-weight: 600;
                padding: var(--space-3) 0;
                color: var(--text-secondary);
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-lg);
                margin-bottom: var(--space-2);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            body.theme-dark .weekday {
                color: var(--text-dark-secondary);
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .calendar-day {
                aspect-ratio: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border-radius: var(--radius-xl);
                cursor: pointer;
                transition: all var(--transition-fast);
                position: relative;
                background: var(--bg-input);
                font-weight: 500;
                font-size: clamp(0.8rem, 2.5vw, 0.9rem);
                min-height: 44px;
                touch-action: manipulation;
                border: 2px solid transparent;
                box-shadow: var(--shadow-sm);
                overflow: hidden;
            }

            .calendar-day::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
                opacity: 0;
                transition: opacity var(--transition-fast);
                z-index: 0;
            }

            .calendar-day>* {
                position: relative;
                z-index: 1;
            }

            body.theme-dark .calendar-day {
                background: var(--bg-input-dark);
                color: var(--text-dark-primary);
            }

            .calendar-day:hover:not(.other-month) {
                transform: scale(1.05);
                z-index: 2;
                box-shadow: var(--shadow-lg);
                border-color: var(--accent-color);
            }

            .calendar-day:hover:not(.other-month)::before {
                opacity: 0.1;
            }

            .calendar-day:active:not(.other-month) {
                transform: scale(0.95);
            }

            /* Enhanced Calendar Day States */
            .calendar-day.period {
                background: var(--period-gradient) !important;
                color: white !important;
                font-weight: 700;
                border: none !important;
                box-shadow: var(--shadow-lg), 0 0 20px rgba(233, 30, 99, 0.4);
                animation: periodGlow 3s ease-in-out infinite;
            }

            @keyframes periodGlow {

                0%,
                100% {
                    box-shadow: var(--shadow-lg), 0 0 20px rgba(233, 30, 99, 0.4);
                }

                50% {
                    box-shadow: var(--shadow-xl), 0 0 30px rgba(233, 30, 99, 0.6);
                }
            }

            .calendar-day.expected-period {
                background: var(--expected-period) !important;
                color: var(--accent-color) !important;
                border: 2px dashed var(--expected-border) !important;
                font-weight: 600;
                position: relative;
                animation: expectedPulse 2s ease-in-out infinite;
            }

            @keyframes expectedPulse {

                0%,
                100% {
                    border-color: var(--expected-border);
                    background: var(--expected-period);
                }

                50% {
                    border-color: var(--accent-color);
                    background: rgba(233, 30, 99, 0.25);
                }
            }

            .calendar-day.expected-period::after {
                content: "";
                position: absolute;
                top: 2px;
                left: 2px;
                right: 2px;
                bottom: 2px;
                background: radial-gradient(circle, rgba(233, 30, 99, 0.1), transparent 70%);
                border-radius: var(--radius-lg);
                z-index: 0;
            }

            .calendar-day.fertile {
                background: var(--fertile-gradient) !important;
                color: white !important;
                font-weight: 600;
                box-shadow: var(--shadow-lg), 0 0 15px rgba(16, 185, 129, 0.4);
                position: relative;
            }

            .calendar-day.fertile::before {
                content: "🌱";
                position: absolute;
                top: 2px;
                right: 2px;
                font-size: 0.7rem;
                opacity: 0.8;
            }

            .calendar-day.ovulation {
                background: var(--ovulation-gradient) !important;
                color: white !important;
                font-weight: 700;
                box-shadow: var(--shadow-lg), 0 0 20px rgba(156, 39, 176, 0.5);
                animation: ovulationPulse 2s ease-in-out infinite;
                position: relative;
            }

            .calendar-day.ovulation::before {
                content: "🥚";
                position: absolute;
                top: 2px;
                right: 2px;
                font-size: 0.7rem;
                opacity: 0.9;
            }

            @keyframes ovulationPulse {

                0%,
                100% {
                    transform: scale(1);
                    box-shadow: var(--shadow-lg), 0 0 20px rgba(156, 39, 176, 0.5);
                }

                50% {
                    transform: scale(1.02);
                    box-shadow: var(--shadow-xl), 0 0 25px rgba(156, 39, 176, 0.7);
                }
            }

            .calendar-day.today {
                border: 3px solid var(--accent-color) !important;
                font-weight: 700;
                box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.3), var(--shadow-lg);
                position: relative;
                z-index: 3;
            }

            .calendar-day.today::after {
                content: "";
                position: absolute;
                top: -3px;
                left: -3px;
                right: -3px;
                bottom: -3px;
                border: 2px solid var(--accent-color);
                border-radius: var(--radius-xl);
                animation: todayRing 2s ease-in-out infinite;
            }

            @keyframes todayRing {

                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }

                50% {
                    opacity: 0.7;
                    transform: scale(1.05);
                }
            }

            /* Combined states */
            .calendar-day.today.period {
                border: 3px solid white !important;
                box-shadow: 0 0 0 2px var(--accent-color), var(--shadow-xl);
            }

            .calendar-day.today.fertile {
                border: 3px solid #065f46 !important;
                box-shadow: 0 0 0 2px var(--fertile-color), var(--shadow-xl);
            }

            .calendar-day.today.ovulation {
                border: 3px solid white !important;
                box-shadow: 0 0 0 2px var(--secondary-color), var(--shadow-xl);
            }

            .calendar-day.other-month {
                opacity: 0.3;
                cursor: default;
                transform: none !important;
            }

            .calendar-day .symptoms-dot {
                position: absolute;
                bottom: 4px;
                right: 4px;
                width: 8px;
                height: 8px;
                border-radius: var(--radius-full);
                background: var(--warning-color);
                box-shadow: 0 0 4px rgba(245, 158, 11, 0.6);
                border: 1px solid white;
                z-index: 2;
            }

            .calendar-day.period .symptoms-dot {
                background: var(--warning-color);
                border-color: rgba(255, 255, 255, 0.8);
            }

            /* ===== ENHANCED CALENDAR LEGEND ===== */
            .calendar-legend {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-3);
                padding: var(--space-4);
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-xl);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                margin-top: var(--space-4);
            }

            body.theme-dark .calendar-legend {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: var(--space-2);
                font-size: 0.8rem;
                font-weight: 500;
                padding: var(--space-2) var(--space-3);
                border-radius: var(--radius-lg);
                transition: all var(--transition-fast);
                cursor: help;
                position: relative;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .legend-item:hover {
                background: rgba(233, 30, 99, 0.1);
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            body.theme-dark .legend-item {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .legend-color {
                width: 16px;
                height: 16px;
                border-radius: var(--radius-md);
                flex-shrink: 0;
                box-shadow: var(--shadow-sm);
                border: 1px solid rgba(255, 255, 255, 0.3);
                position: relative;
                overflow: hidden;
            }

            .period-color {
                background: var(--period-gradient);
            }

            .expected-color {
                background: var(--expected-period);
                border: 2px dashed var(--expected-border);
            }

            .expected-color::after {
                content: "";
                position: absolute;
                top: 1px;
                left: 1px;
                right: 1px;
                bottom: 1px;
                background: rgba(233, 30, 99, 0.1);
                border-radius: var(--radius-sm);
            }

            .ovulation-color {
                background: var(--ovulation-gradient);
            }

            .fertile-color {
                background: var(--fertile-gradient);
            }

            .legend-item span {
                color: var(--text-secondary);
                font-weight: 500;
            }

            body.theme-dark .legend-item span {
                color: var(--text-dark-secondary);
            }

            /* Enhanced tooltip for legend */
            .legend-item::before {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: var(--space-2) var(--space-3);
                border-radius: var(--radius-lg);
                font-size: 0.75rem;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity var(--transition-fast);
                z-index: var(--z-tooltip);
                margin-bottom: 8px;
                box-shadow: var(--shadow-lg);
            }

            .legend-item:hover::before {
                opacity: 1;
            }

            /* ===== ENHANCED INSIGHTS PANEL ===== */
            .insights-panel {
                margin: var(--space-8) 0;
            }

            .insight-card {
                background: var(--glass-gradient);
                border-radius: var(--radius-2xl);
                padding: var(--space-6);
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: var(--shadow-lg);
                display: flex;
                align-items: center;
                gap: var(--space-4);
                transition: all var(--transition-normal);
                cursor: pointer;
                position: relative;
                overflow: hidden;
            }

            .insight-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                transition: left var(--transition-slow);
            }

            .insight-card:hover::before {
                left: 100%;
            }

            .insight-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-xl);
            }

            body.theme-dark .insight-card {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .insight-icon {
                font-size: 2rem;
                padding: var(--space-3);
                background: rgba(233, 30, 99, 0.1);
                border-radius: var(--radius-full);
                border: 2px solid rgba(233, 30, 99, 0.2);
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 60px;
                height: 60px;
            }

            .insight-content {
                flex: 1;
            }

            .insight-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: var(--space-1);
            }

            body.theme-dark .insight-title {
                color: var(--text-dark-primary);
            }

            .insight-text {
                font-size: 0.9rem;
                color: var(--text-secondary);
                line-height: 1.4;
            }

            body.theme-dark .insight-text {
                color: var(--text-dark-secondary);
            }

            /* ===== ENHANCED STATS SECTION ===== */
            .stats-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: var(--space-4);
                margin-bottom: var(--space-8);
            }

            .stat-card {
                background: var(--glass-gradient);
                padding: var(--space-6);
                border-radius: var(--radius-2xl);
                box-shadow: var(--shadow-lg);
                text-align: center;
                transition: all var(--transition-normal);
                border: 1px solid rgba(255, 255, 255, 0.2);
                position: relative;
                overflow: hidden;
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                cursor: pointer;
            }

            .stat-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
                opacity: 0.8;
            }

            .stat-card::after {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                transition: left var(--transition-slow);
            }

            .stat-card:hover::after {
                left: 100%;
            }

            .stat-card:hover {
                transform: translateY(-4px);
                box-shadow: var(--shadow-xl);
                border-color: rgba(233, 30, 99, 0.3);
            }

            body.theme-dark .stat-card {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .stat-value {
                font-size: clamp(1.8rem, 6vw, 2.2rem);
                font-weight: 800;
                color: var(--accent-color);
                margin-bottom: var(--space-2);
                line-height: 1;
                text-shadow: 0 2px 4px rgba(233, 30, 99, 0.2);
            }

            .stat-label {
                font-size: 0.85rem;
                color: var(--text-secondary);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: var(--space-1);
            }

            body.theme-dark .stat-label {
                color: var(--text-dark-secondary);
            }

            .stat-status {
                font-size: 0.75rem;
                font-weight: 600;
                padding: var(--space-1) var(--space-2);
                border-radius: var(--radius-full);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                display: inline-block;
            }

            .stat-status.normal {
                background: rgba(16, 185, 129, 0.1);
                color: var(--success-color);
                border: 1px solid rgba(16, 185, 129, 0.3);
            }

            .stat-status.irregular {
                background: rgba(245, 158, 11, 0.1);
                color: var(--warning-color);
                border: 1px solid rgba(245, 158, 11, 0.3);
            }

            .stat-status.tracking {
                background: rgba(59, 130, 246, 0.1);
                color: var(--info-color);
                border: 1px solid rgba(59, 130, 246, 0.3);
            }

            /* ===== ENHANCED CHART CONTAINERS ===== */
            .chart-container {
                background: var(--glass-gradient);
                border-radius: var(--radius-2xl);
                padding: var(--space-6);
                margin-bottom: var(--space-6);
                box-shadow: var(--shadow-lg);
                position: relative;
                border: 1px solid rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(15px);
                -webkit-backdrop-filter: blur(15px);
                transition: all var(--transition-normal);
                overflow: hidden;
            }

            .chart-container::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(90deg, var(--accent-color), var(--secondary-color), var(--accent-color));
                opacity: 0.6;
            }

            .chart-container:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-xl);
            }

            body.theme-dark .chart-container {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .chart-title {
                font-size: 1.2rem;
                font-weight: 600;
                margin-bottom: var(--space-4);
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: var(--space-2);
            }

            body.theme-dark .chart-title {
                color: var(--text-dark-primary);
            }

            .chart-title i {
                color: var(--accent-color);
                font-size: 1.1rem;
            }

            .chart-wrapper {
                position: relative;
                width: 100%;
                margin: var(--space-4) 0;
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-xl);
                padding: var(--space-3);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            body.theme-dark .chart-wrapper {
                background: rgba(255, 255, 255, 0.02);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .chart-wrapper canvas {
                position: absolute !important;
                top: var(--space-3);
                left: var(--space-3);
                right: var(--space-3);
                bottom: var(--space-3);
                width: calc(100% - 24px) !important;
                height: calc(100% - 24px) !important;
                border-radius: var(--radius-lg);
            }

            /* Chart specific heights */
            .chart-wrapper.cycle-chart {
                height: 200px;
            }

            .chart-wrapper.period-chart {
                height: 180px;
            }

            .chart-wrapper.fertility-chart {
                height: 240px;
            }

            .chart-wrapper.symptoms-chart {
                height: 220px;
            }

            /* ===== RESPONSIVE DESIGN ===== */
            @media (max-width: 480px) {
                .calendar-legend {
                    grid-template-columns: 1fr;
                    gap: var(--space-2);
                }

                .legend-item {
                    justify-content: flex-start;
                    padding: var(--space-3);
                }

                .stats-container {
                    grid-template-columns: repeat(2, 1fr);
                    gap: var(--space-3);
                }

                .chart-wrapper.cycle-chart {
                    height: 160px;
                }

                .chart-wrapper.period-chart {
                    height: 140px;
                }

                .chart-wrapper.fertility-chart {
                    height: 180px;
                }

                .chart-wrapper.symptoms-chart {
                    height: 160px;
                }

                .quick-actions-circle {
                    display: none;
                    /* Hide on small screens */
                }
            }

            @media (max-width: 360px) {
                .calendar-legend {
                    padding: var(--space-3);
                }

                .legend-item {
                    font-size: 0.75rem;
                    padding: var(--space-2);
                }

                .legend-color {
                    width: 12px;
                    height: 12px;
                }
            }

            /* ===== ENHANCED BOTTOM NAVIGATION ===== */
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--glass-gradient);
                box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.12);
                display: flex;
                justify-content: space-around;
                align-items: center;
                padding: var(--space-3) var(--space-2);
                z-index: var(--z-fixed);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-top: 1px solid rgba(255, 255, 255, 0.2);
                transition: all var(--transition-normal);
            }

            .bottom-nav::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            }

            body.theme-dark .bottom-nav {
                background: var(--glass-gradient-dark);
                border-top-color: rgba(255, 255, 255, 0.1);
            }

            .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: var(--space-2) var(--space-3);
                color: var(--text-light);
                text-decoration: none;
                transition: all var(--transition-fast);
                border-radius: var(--radius-xl);
                min-width: 60px;
                touch-action: manipulation;
                position: relative;
                overflow: hidden;
            }

            .nav-item::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
                opacity: 0;
                transition: opacity var(--transition-fast);
                border-radius: var(--radius-xl);
            }

            .nav-item:hover::before {
                opacity: 0.1;
            }

            .nav-item i {
                font-size: 1.3rem;
                margin-bottom: var(--space-1);
                transition: all var(--transition-fast);
                position: relative;
                z-index: 1;
            }

            .nav-item span {
                font-size: 0.7rem;
                font-weight: 500;
                position: relative;
                z-index: 1;
                line-height: 1;
            }

            .nav-item:hover:not(.add-item) {
                color: var(--accent-color);
                background: rgba(233, 30, 99, 0.1);
                transform: translateY(-2px);
            }

            .nav-item.active {
                color: var(--accent-color);
                background: rgba(233, 30, 99, 0.15);
                border: 1px solid rgba(233, 30, 99, 0.3);
            }

            .nav-item.active::before {
                opacity: 0.15;
            }

            .nav-item.active i {
                transform: scale(1.1);
                filter: drop-shadow(0 2px 4px rgba(233, 30, 99, 0.3));
            }

            /* Enhanced Add Button */
            .nav-item.add-item {
                background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
                color: white;
                width: 64px;
                height: 64px;
                border-radius: var(--radius-full);
                margin-top: -24px;
                box-shadow: var(--shadow-xl), 0 0 20px rgba(233, 30, 99, 0.4);
                display: flex;
                justify-content: center;
                align-items: center;
                transition: all var(--transition-normal);
                flex-shrink: 0;
                border: 3px solid rgba(255, 255, 255, 0.3);
                position: relative;
                overflow: hidden;
            }

            .nav-item.add-item::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: conic-gradient(from 0deg, var(--accent-color), var(--secondary-color), var(--accent-color));
                animation: rotate 3s linear infinite;
                opacity: 0.3;
            }

            .nav-item.add-item::after {
                content: "";
                position: absolute;
                top: 3px;
                left: 3px;
                right: 3px;
                bottom: 3px;
                background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
                border-radius: var(--radius-full);
                z-index: 1;
            }

            .nav-item.add-item:hover {
                transform: translateY(-4px) scale(1.05);
                box-shadow: var(--shadow-2xl), 0 0 30px rgba(233, 30, 99, 0.6);
            }

            .nav-item.add-item:active {
                transform: translateY(-2px) scale(0.95);
            }

            .nav-item.add-item i {
                font-size: 1.8rem;
                margin: 0;
                position: relative;
                z-index: 2;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            }

            .nav-item.add-item span {
                display: none;
            }

            /* ===== ENHANCED QUICK ADD FORM ===== */
            .quick-add-form {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--glass-gradient);
                padding: var(--space-8) var(--space-6) var(--space-10);
                border-radius: 32px 32px 0 0;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
                transform: translateY(100%);
                transition: transform var(--transition-slow);
                z-index: var(--z-modal);
                max-height: 90vh;
                overflow-y: auto;
                border: 1px solid rgba(255, 255, 255, 0.3);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
            }

            .quick-add-form::before {
                content: "";
                position: absolute;
                top: 12px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: var(--radius-full);
            }

            body.theme-dark .quick-add-form {
                background: var(--glass-gradient-dark);
                color: var(--text-dark-primary);
                border-color: rgba(255, 255, 255, 0.1);
            }

            body.theme-dark .quick-add-form::before {
                background: rgba(255, 255, 255, 0.2);
            }

            .quick-add-form.active {
                transform: translateY(0);
            }

            /* Enhanced Form Header */
            .form-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--space-8);
                padding-bottom: var(--space-4);
                border-bottom: 2px solid rgba(233, 30, 99, 0.1);
                position: relative;
            }

            .form-header::after {
                content: "";
                position: absolute;
                bottom: -2px;
                left: 0;
                width: 60px;
                height: 2px;
                background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
                border-radius: var(--radius-full);
            }

            body.theme-dark .form-header {
                border-bottom-color: rgba(255, 255, 255, 0.1);
            }

            .form-title {
                font-size: 1.5rem;
                font-weight: 600;
                color: var(--accent-color);
                display: flex;
                align-items: center;
                gap: var(--space-3);
            }

            .form-title i {
                font-size: 1.3rem;
                padding: var(--space-2);
                background: rgba(233, 30, 99, 0.1);
                border-radius: var(--radius-full);
                border: 2px solid rgba(233, 30, 99, 0.2);
            }

            .close-btn {
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid rgba(255, 255, 255, 0.2);
                font-size: 1.4rem;
                cursor: pointer;
                color: var(--text-secondary);
                padding: var(--space-3);
                border-radius: var(--radius-full);
                transition: all var(--transition-fast);
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                touch-action: manipulation;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            .close-btn:hover {
                background: rgba(233, 30, 99, 0.1);
                color: var(--accent-color);
                transform: scale(1.05);
                border-color: rgba(233, 30, 99, 0.3);
            }

            .close-btn:active {
                transform: scale(0.95);
            }

            /* ===== ENHANCED FORM ELEMENTS ===== */
            .form-group {
                position: relative;
                margin-bottom: var(--space-6);
            }

            .form-label {
                display: block;
                margin-bottom: var(--space-3);
                font-weight: 600;
                color: var(--text-primary);
                font-size: 1rem;
                display: flex;
                align-items: center;
                gap: var(--space-2);
            }

            .form-label i {
                color: var(--accent-color);
                font-size: 1.1rem;
            }

            body.theme-dark .form-label {
                color: var(--text-dark-primary);
            }

            .form-control {
                width: 100%;
                padding: var(--space-4);
                border: 2px solid rgba(255, 255, 255, 0.2);
                border-radius: var(--radius-xl);
                font-size: 1rem;
                background: rgba(255, 255, 255, 0.1);
                color: var(--text-primary);
                transition: all var(--transition-fast);
                margin-bottom: var(--space-4);
                font-family: inherit;
                font-weight: 500;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            body.theme-dark .form-control {
                background: rgba(255, 255, 255, 0.05);
                color: var(--text-dark-primary);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .form-control:focus {
                border-color: var(--accent-color);
                outline: none;
                background: rgba(255, 255, 255, 0.2);
                box-shadow: var(--shadow-focus);
                transform: translateY(-1px);
            }

            body.theme-dark .form-control:focus {
                background: rgba(255, 255, 255, 0.1);
            }

            .form-control::placeholder {
                color: var(--text-light);
                opacity: 0.7;
            }

            body.theme-dark .form-control::placeholder {
                color: var(--text-dark-light);
            }

            /* Enhanced Week Selector */
            .week-selector {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: var(--space-2);
                margin: var(--space-6) 0;
                padding: var(--space-4);
                background: rgba(233, 30, 99, 0.05);
                border-radius: var(--radius-xl);
                border: 1px solid rgba(233, 30, 99, 0.1);
            }

            body.theme-dark .week-selector {
                background: rgba(255, 255, 255, 0.02);
                border-color: rgba(255, 255, 255, 0.05);
            }

            .week-day {
                text-align: center;
                padding: var(--space-3);
                border-radius: var(--radius-xl);
                cursor: pointer;
                transition: all var(--transition-fast);
                font-size: 0.85rem;
                background: rgba(255, 255, 255, 0.2);
                min-height: 70px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                touch-action: manipulation;
                border: 2px solid transparent;
                font-weight: 500;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                position: relative;
                overflow: hidden;
            }

            .week-day::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
                opacity: 0;
                transition: opacity var(--transition-fast);
            }

            .week-day>* {
                position: relative;
                z-index: 1;
            }

            body.theme-dark .week-day {
                background: rgba(255, 255, 255, 0.05);
                color: var(--text-dark-primary);
            }

            .week-day:hover:not(.future):not(.selected) {
                background: rgba(233, 30, 99, 0.1);
                border-color: var(--accent-color);
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .week-day:hover:not(.future):not(.selected)::before {
                opacity: 0.1;
            }

            .week-day.selected {
                background: var(--accent-color);
                color: white;
                border-color: var(--accent-hover);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg), 0 0 20px rgba(233, 30, 99, 0.4);
                font-weight: 600;
            }

            .week-day.selected::before {
                opacity: 0.2;
            }

            .week-day.future {
                opacity: 0.4;
                cursor: not-allowed;
                background: rgba(255, 255, 255, 0.05);
            }

            .week-day.today {
                border-color: var(--accent-color);
                box-shadow: 0 0 0 1px rgba(233, 30, 99, 0.3);
            }

            /* ===== ENHANCED ACTIVITY OPTIONS ===== */
            .activity-section {
                margin: var(--space-8) 0;
            }

            .activity-options {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: var(--space-4);
                margin: var(--space-4) 0;
            }

            .activity-option {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: var(--space-3);
                cursor: pointer;
                padding: var(--space-5);
                border-radius: var(--radius-2xl);
                transition: all var(--transition-fast);
                background: rgba(255, 255, 255, 0.1);
                min-height: 100px;
                justify-content: center;
                touch-action: manipulation;
                border: 2px solid transparent;
                position: relative;
                overflow: hidden;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            .activity-option::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
                opacity: 0;
                transition: opacity var(--transition-fast);
            }

            .activity-option>* {
                position: relative;
                z-index: 1;
            }

            body.theme-dark .activity-option {
                background: rgba(255, 255, 255, 0.05);
            }

            .activity-option:hover {
                border-color: var(--accent-color);
                transform: translateY(-3px);
                box-shadow: var(--shadow-lg);
            }

            .activity-option:hover::before {
                opacity: 0.05;
            }

            .activity-option.selected {
                background: rgba(233, 30, 99, 0.15);
                border-color: var(--accent-color);
                transform: translateY(-3px);
                box-shadow: var(--shadow-xl), 0 0 20px rgba(233, 30, 99, 0.3);
            }

            .activity-option.selected::before {
                opacity: 0.1;
            }

            .activity-icon {
                font-size: 2.5rem;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            }

            .activity-label {
                font-size: 0.9rem;
                text-align: center;
                color: var(--text-secondary);
                font-weight: 600;
                line-height: 1.3;
            }

            body.theme-dark .activity-label {
                color: var(--text-dark-secondary);
            }

            /* ===== ENHANCED SYMPTOMS & MOOD GRIDS ===== */
            .symptoms-section,
            .mood-section {
                margin: var(--space-8) 0;
            }

            .symptoms-grid,
            .mood-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
                gap: var(--space-3);
                margin: var(--space-4) 0;
            }

            .symptom-item,
            .mood-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: var(--space-2);
                cursor: pointer;
                padding: var(--space-3);
                border-radius: var(--radius-xl);
                transition: all var(--transition-fast);
                text-align: center;
                background: rgba(255, 255, 255, 0.1);
                min-height: 80px;
                justify-content: center;
                touch-action: manipulation;
                border: 2px solid transparent;
                position: relative;
                overflow: hidden;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            .symptom-item::before,
            .mood-item::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--accent-color);
                opacity: 0;
                transition: opacity var(--transition-fast);
            }

            .symptom-item>*,
            .mood-item>* {
                position: relative;
                z-index: 1;
            }

            body.theme-dark .symptom-item,
            body.theme-dark .mood-item {
                background: rgba(255, 255, 255, 0.05);
            }

            .symptom-item:hover,
            .mood-item:hover {
                border-color: var(--accent-color);
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .symptom-item:hover::before,
            .mood-item:hover::before {
                opacity: 0.05;
            }

            .symptom-item.selected,
            .mood-item.selected {
                background: rgba(233, 30, 99, 0.15);
                border-color: var(--accent-color);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg), 0 0 15px rgba(233, 30, 99, 0.2);
            }

            .symptom-item.selected::before,
            .mood-item.selected::before {
                opacity: 0.1;
            }

            .symptom-icon {
                width: 36px;
                height: 36px;
                border-radius: var(--radius-full);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
                background: rgba(255, 255, 255, 0.2);
                box-shadow: var(--shadow-sm);
                border: 1px solid rgba(255, 255, 255, 0.3);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
            }

            .symptom-label,
            .mood-label {
                font-size: 0.7rem;
                color: var(--text-secondary);
                font-weight: 600;
                line-height: 1.2;
            }

            body.theme-dark .symptom-label,
            body.theme-dark .mood-label {
                color: var(--text-dark-secondary);
            }

            .mood-emoji {
                font-size: 2rem;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            }

            .highlighted-entry {
                animation: highlightPulse 2s ease-in-out;
                box-shadow: 0 0 0 3px var(--accent-color);
                border-radius: var(--radius-lg);
            }

            @keyframes highlightPulse {

                0%,
                100% {
                    box-shadow: 0 0 0 3px var(--accent-color);
                }

                50% {
                    box-shadow: 0 0 0 8px rgba(233, 30, 99, 0.5);
                }
            }

            /* ===== ENHANCED SHOW ALL BUTTON ===== */
            .show-all-btn {
                background: rgba(233, 30, 99, 0.1);
                border: 2px solid var(--accent-color);
                color: var(--accent-color);
                font-size: 0.9rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
                margin: var(--space-4) 0;
                padding: var(--space-3) var(--space-5);
                border-radius: var(--radius-xl);
                transition: all var(--transition-fast);
                touch-action: manipulation;
                font-weight: 600;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                position: relative;
                overflow: hidden;
            }

            .show-all-btn::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left var(--transition-slow);
            }

            .show-all-btn:hover::before {
                left: 100%;
            }

            .show-all-btn:hover {
                background: var(--accent-color);
                color: white;
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            /* ===== ENHANCED BUTTONS ===== */
            .btn {
                padding: var(--space-4) var(--space-6);
                background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
                color: white;
                border: none;
                border-radius: var(--radius-full);
                cursor: pointer;
                font-size: 1rem;
                font-weight: 600;
                transition: all var(--transition-normal);
                width: 100%;
                margin-top: var(--space-3);
                font-family: inherit;
                touch-action: manipulation;
                min-height: 52px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: var(--space-2);
                box-shadow: var(--shadow-lg), 0 0 20px rgba(233, 30, 99, 0.3);
                position: relative;
                overflow: hidden;
            }

            .btn::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left var(--transition-slow);
            }

            .btn:hover::before {
                left: 100%;
            }

            .btn:hover {
                background: linear-gradient(135deg, var(--accent-hover), #c2185b);
                transform: translateY(-2px);
                box-shadow: var(--shadow-xl), 0 0 25px rgba(233, 30, 99, 0.4);
            }

            .btn:active {
                transform: translateY(0);
            }

            .btn-secondary {
                background: linear-gradient(135deg, var(--text-secondary), #5a6268);
                box-shadow: var(--shadow-lg), 0 0 20px rgba(108, 117, 125, 0.3);
            }

            .btn-secondary:hover {
                background: linear-gradient(135deg, #5a6268, #495057);
            }

            /* ===== ENHANCED DAY DETAIL MODAL ===== */
            .day-detail-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--bg-overlay);
                z-index: var(--z-modal);
                display: none;
                align-items: center;
                justify-content: center;
                padding: var(--space-6);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            .day-detail-modal.active {
                display: flex;
                animation: fadeIn 0.3s ease;
            }

            .day-detail-content {
                background: var(--glass-gradient);
                border-radius: var(--radius-3xl);
                padding: var(--space-8);
                max-width: 420px;
                width: 100%;
                max-height: 85vh;
                overflow-y: auto;
                position: relative;
                box-shadow: var(--shadow-2xl);
                border: 1px solid rgba(255, 255, 255, 0.3);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                animation: slideUp 0.4s ease;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(30px) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            body.theme-dark .day-detail-content {
                background: var(--glass-gradient-dark);
                color: var(--text-dark-primary);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .day-detail-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--space-6);
                padding-bottom: var(--space-4);
                border-bottom: 2px solid rgba(233, 30, 99, 0.1);
                position: relative;
            }

            .day-detail-header::after {
                content: "";
                position: absolute;
                bottom: -2px;
                left: 0;
                width: 80px;
                height: 2px;
                background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
                border-radius: var(--radius-full);
            }

            body.theme-dark .day-detail-header {
                border-bottom-color: rgba(255, 255, 255, 0.1);
            }

            .day-detail-title {
                font-size: 1.4rem;
                font-weight: 700;
                color: var(--accent-color);
                display: flex;
                align-items: center;
                gap: var(--space-2);
            }

            .day-detail-close {
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid rgba(255, 255, 255, 0.2);
                font-size: 1.4rem;
                cursor: pointer;
                color: var(--text-secondary);
                padding: var(--space-3);
                border-radius: var(--radius-full);
                transition: all var(--transition-fast);
                min-width: 48px;
                min-height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                touch-action: manipulation;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            .day-detail-close:hover {
                background: rgba(233, 30, 99, 0.1);
                color: var(--accent-color);
                transform: scale(1.05);
                border-color: rgba(233, 30, 99, 0.3);
            }

            /* DAY DETAIL MODAL STYLES */
            .day-detail-content {
                max-height: 85vh;
                overflow-y: auto;
            }

            .day-info {
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .day-date {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 5px;
            }

            .day-phase {
                font-size: 0.9rem;
                color: var(--accent-color);
                background: rgba(233, 30, 99, 0.1);
                padding: 5px 10px;
                border-radius: var(--radius-full);
                display: inline-block;
            }

            .day-activity {
                display: flex;
                padding: 15px;
                margin-bottom: 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-xl);
                align-items: flex-start;
            }

            .activity-icon {
                font-size: 1.5rem;
                margin-right: 15px;
            }

            .activity-details {
                flex: 1;
            }

            .activity-type {
                font-weight: 600;
                margin-bottom: 5px;
            }

            .activity-time {
                font-size: 0.8rem;
                color: var(--text-light);
                margin-bottom: 8px;
            }

            .activity-note,
            .activity-symptoms,
            .activity-moods,
            .activity-flow {
                font-size: 0.9rem;
                margin-top: 8px;
                padding: 8px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: var(--radius-lg);
            }

            .activity-actions {
                display: flex;
                gap: 5px;
            }

            .edit-activity-btn,
            .delete-activity-btn {
                background: none;
                border: none;
                color: var(--text-light);
                cursor: pointer;
                font-size: 1rem;
                padding: 5px;
            }

            .edit-activity-btn:hover {
                color: var(--accent-color);
            }

            .delete-activity-btn:hover {
                color: var(--danger-color);
            }

            #empty-day-state {
                text-align: center;
                padding: 40px 20px;
                color: var(--text-light);
            }

            #empty-day-state i {
                font-size: 3rem;
                margin-bottom: 15px;
                display: block;
                color: var(--accent-color);
            }

            .add-activity-btn {
                background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: var(--radius-full);
                font-size: 1rem;
                cursor: pointer;
                display: block;
                width: 100%;
                margin-top: 20px;
                text-align: center;
            }

            .quick-actions {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }

            .quick-actions button {
                flex: 1;
                padding: 10px;
                border-radius: var(--radius-full);
                border: none;
                background: rgba(255, 255, 255, 0.1);
                color: var(--text-primary);
                cursor: pointer;
            }

            .quick-actions button:hover {
                background: var(--accent-color);
                color: white;
            }

            /* ===== HIDDEN UTILITY CLASS ===== */
            .hidden {
                display: none !important;
            }

            /* ===== ENHANCED SETTINGS SECTION ===== */
            .settings-section {
                margin: var(--space-6) 0;
            }

            .settings-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: var(--space-4);
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-xl);
                margin-bottom: var(--space-3);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                transition: all var(--transition-fast);
            }

            .settings-item:hover {
                background: rgba(255, 255, 255, 0.15);
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            body.theme-dark .settings-item {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .settings-label {
                display: flex;
                align-items: center;
                gap: var(--space-3);
                font-weight: 500;
                color: var(--text-primary);
            }

            body.theme-dark .settings-label {
                color: var(--text-dark-primary);
            }

            .settings-label i {
                color: var(--accent-color);
                font-size: 1.1rem;
            }

            /* Enhanced Theme Toggle */
            .theme-toggle {
                position: relative;
                display: inline-block;
                width: 60px;
                height: 34px;
            }

            .theme-toggle input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.2);
                transition: var(--transition-normal);
                border-radius: 34px;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }

            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;
                left: 2px;
                bottom: 2px;
                background: white;
                transition: var(--transition-normal);
                border-radius: 50%;
                box-shadow: var(--shadow-md);
            }

            input:checked+.toggle-slider {
                background: var(--accent-color);
                border-color: var(--accent-hover);
            }

            input:checked+.toggle-slider:before {
                transform: translateX(26px);
            }

            .toggle-slider:hover {
                box-shadow: var(--shadow-lg);
            }

            /* Badge styling */
            .badge {
                background: rgba(233, 30, 99, 0.1);
                color: var(--accent-color);
                padding: var(--space-1) var(--space-3);
                border-radius: var(--radius-full);
                font-size: 0.8rem;
                font-weight: 600;
                border: 1px solid rgba(233, 30, 99, 0.3);
            }

            /* ===== TOAST NOTIFICATIONS ===== */
            .toast-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--glass-gradient);
                border-radius: var(--radius-xl);
                padding: var(--space-4);
                box-shadow: var(--shadow-xl);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                z-index: var(--z-toast);
                transform: translateX(400px);
                transition: all var(--transition-normal);
                max-width: 350px;
                min-width: 300px;
            }

            .toast-notification.toast-visible {
                transform: translateX(0);
            }

            .toast-notification.toast-removing {
                transform: translateX(400px);
                opacity: 0;
            }

            body.theme-dark .toast-notification {
                background: var(--glass-gradient-dark);
                border-color: rgba(255, 255, 255, 0.1);
            }

            .toast-content {
                display: flex;
                align-items: center;
                gap: var(--space-3);
            }

            .toast-icon {
                font-size: 1.5rem;
                flex-shrink: 0;
            }

            .toast-message {
                flex: 1;
                font-weight: 500;
                color: var(--text-primary);
            }

            body.theme-dark .toast-message {
                color: var(--text-dark-primary);
            }

            .toast-close {
                background: none;
                border: none;
                color: var(--text-light);
                cursor: pointer;
                padding: var(--space-1);
                border-radius: var(--radius-md);
                transition: all var(--transition-fast);
                flex-shrink: 0;
            }

            .toast-close:hover {
                background: rgba(255, 255, 255, 0.1);
                color: var(--accent-color);
            }

            .toast-progress {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 3px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 0 0 var(--radius-xl) var(--radius-xl);
                overflow: hidden;
            }

            .toast-progress-bar {
                height: 100%;
                background: var(--accent-color);
                width: 0%;
                transition: width 0ms linear;
            }

            /* Toast types */
            .toast-notification.success {
                border-left: 4px solid var(--success-color);
            }

            .toast-notification.warning {
                border-left: 4px solid var(--warning-color);
            }

            .toast-notification.error {
                border-left: 4px solid var(--danger-color);
            }

            .toast-notification.info {
                border-left: 4px solid var(--info-color);
            }

            /* ===== RESPONSIVE DESIGN FOR FORMS ===== */
            @media (max-width: 480px) {
                .quick-add-form {
                    padding: var(--space-6) var(--space-4) var(--space-8);
                    border-radius: 24px 24px 0 0;
                }

                .activity-options {
                    grid-template-columns: repeat(2, 1fr);
                    gap: var(--space-3);
                }

                .symptoms-grid,
                .mood-grid {
                    grid-template-columns: repeat(3, 1fr);
                    gap: var(--space-2);
                }

                .week-selector {
                    gap: var(--space-1);
                    padding: var(--space-3);
                }

                .week-day {
                    min-height: 60px;
                    padding: var(--space-2);
                    font-size: 0.8rem;
                }

                .day-detail-content {
                    margin: var(--space-4);
                    padding: var(--space-6);
                    max-height: 90vh;
                }

                .toast-notification {
                    right: 10px;
                    left: 10px;
                    max-width: none;
                    min-width: auto;
                }
            }

            @media (max-width: 360px) {

                .symptoms-grid,
                .mood-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .activity-options {
                    grid-template-columns: 1fr;
                }

                .bottom-nav {
                    padding: var(--space-2) var(--space-1);
                }

                .nav-item.add-item {
                    width: 56px;
                    height: 56px;
                    margin-top: -20px;
                }
            }

            body.theme-dark {
                background: var(--dark-gradient) !important;
                color: var(--text-dark-primary) !important;
            }

            body.theme-dark * {
                color: var(--text-dark-primary) !important;
                /* Nếu cần, có thể dùng inherit, hoặc override từng component */
            }

            body.theme-dark {
                background: var(--dark-gradient) !important;
                color: var(--text-dark-primary) !important;
            }

            body.theme-dark .main-content,
            body.theme-dark .container,
            body.theme-dark .app-header,
            body.theme-dark .calendar-section,
            body.theme-dark .chart-container,
            body.theme-dark .stat-card,
            body.theme-dark .insight-card,
            body.theme-dark .settings-item {
                background: var(--glass-gradient-dark) !important;
                color: var(--text-dark-primary) !important;
                border-color: rgba(255, 255, 255, 0.1) !important;
            }

            body.theme-dark input,
            body.theme-dark textarea,
            body.theme-dark select {
                background: rgba(255, 255, 255, 0.05) !important;
                color: var(--text-dark-primary) !important;
                border-color: rgba(255, 255, 255, 0.1) !important;
            }
        </style>
        <!-- Async load non-critical CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <!-- Loading Screen -->
        <div class="loading-screen" id="loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                <div>🌸 Chu Kỳ</div>
                <div style="font-size: 0.9rem; margin-top: 8px; opacity: 0.8;">Đang khởi tạo ứng dụng...</div>
            </div>
        </div>
        <!-- Main app container -->
        <div class="container" style="display: none;" id="main-app">
            <!-- Enhanced App Header with improved animations -->
            <div class="app-header">
                <div class="flower-decoration flower-1">🌸</div>
                <div class="flower-decoration flower-2">🌺</div>
                <div class="flower-decoration flower-3">🌷</div>
                <div class="flower-decoration flower-4">🌻</div>
                <div class="flower-decoration flower-5">🌼</div>
                <div class="flower-decoration flower-6">💐</div>
                <h1 class="app-title">Chu Kỳ</h1>
                <p class="app-subtitle">Theo dõi thông minh • Chăm sóc bản thân</p>
                <div class="header-stats">
                    <div class="header-stat-item">
                        <span class="stat-number" id="header-cycle-day">-</span>
                        <span class="stat-label">Ngày chu kỳ</span>
                    </div>
                    <div class="header-stat-item">
                        <span class="stat-number" id="header-next-period">-</span>
                        <span class="stat-label">Ngày đến kỳ</span>
                    </div>
                </div>
            </div>
            <!-- Enhanced Main Content with improved layout -->
            <div class="main-content">
                <!-- Dashboard Section -->
                <section class="section active" id="dashboard">
                    <div class="countdown-container">
                        <div class="countdown-circle" onclick="openQuickAddForm()">
                            <div class="countdown-background-ring"></div>
                            <div class="countdown-progress-ring">
                                <svg class="progress-ring" width="200" height="200">
                                    <circle class="progress-ring-circle" cx="100" cy="100" r="90"></circle>
                                </svg>
                            </div>
                            <div class="countdown-content">
                                <div class="countdown-number" id="countdown-days">-</div>
                                <div class="countdown-text">
                                    <span id="countdown-text">
                                        ngày đến<br />
                                        chu kỳ tiếp theo
                                    </span>
                                </div>
                                <div class="countdown-phase" id="countdown-phase">Đang tính toán...</div>
                            </div>
                            <button class="log-period-btn pulse-animation" id="log-period-btn">
                                <i class="fas fa-plus"></i>
                                <span>Ghi nhận</span>
                            </button>
                        </div>
                        <div class="quick-actions-circle">
                            <button class="quick-action-btn quick-action-1" data-action="period" title="Kinh nguyệt">
                                <i class="fas fa-droplet"></i>
                            </button>
                            <button class="quick-action-btn quick-action-2" data-action="symptoms" title="Triệu chứng">
                                <i class="fas fa-notes-medical"></i>
                            </button>
                            <button class="quick-action-btn quick-action-3" data-action="mood" title="Tâm trạng">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="quick-action-btn quick-action-4" data-action="ovulation" title="Rụng trứng">
                                <i class="fas fa-egg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="calendar-section">
                        <div class="calendar-header">
                            <button class="calendar-nav-btn" id="prev-month" aria-label="Tháng trước">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="calendar-title-container">
                                <div class="calendar-title" id="calendar-title">Tháng 11 2025</div>
                                <div class="calendar-subtitle" id="calendar-subtitle">Xem tổng quan chu kỳ</div>
                            </div>
                            <button class="calendar-nav-btn" id="next-month" aria-label="Tháng sau">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <div class="weekday">CN</div>
                            <div class="weekday">T2</div>
                            <div class="weekday">T3</div>
                            <div class="weekday">T4</div>
                            <div class="weekday">T5</div>
                            <div class="weekday">T6</div>
                            <div class="weekday">T7</div>
                        </div>
                        <div class="calendar-legend">
                            <div class="legend-item" data-tooltip="Những ngày trong kỳ kinh nguyệt">
                                <div class="legend-color period-color"></div>
                                <span>Ngày kinh</span>
                            </div>
                            <div class="legend-item" data-tooltip="Ngày dự kiến bắt đầu kỳ kinh tiếp theo">
                                <div class="legend-color expected-color"></div>
                                <span>Dự kiến</span>
                            </div>
                            <div class="legend-item" data-tooltip="Ngày rụng trứng - khả năng thụ thai cao nhất">
                                <div class="legend-color ovulation-color"></div>
                                <span>Rụng trứng</span>
                            </div>
                            <div class="legend-item" data-tooltip="Thời kỳ dễ thụ thai">
                                <div class="legend-color fertile-color"></div>
                                <span>Dễ thụ thai</span>
                            </div>
                        </div>
                    </div>
                    <div class="insights-panel">
                        <div class="insight-card">
                            <div class="insight-icon">📊</div>
                            <div class="insight-content">
                                <div class="insight-title">Nhận xét hôm nay</div>
                                <div class="insight-text" id="daily-insight">Đang phân tích dữ liệu...</div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Stats Section -->
                <section class="section" id="stats">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Thống Kê Chu Kỳ
                    </h2>
                    <!-- Stats Cards -->
                    <div class="stats-container">
                        <div class="stat-card card-hover">
                            <div class="stat-value" id="last-cycle-days">28</div>
                            <div class="stat-label">Chu kỳ cuối</div>
                            <div class="stat-status normal">BÌNH THƯỜNG</div>
                        </div>
                        <div class="stat-card card-hover">
                            <div class="stat-value" id="last-period-days">5</div>
                            <div class="stat-label">Kỳ kinh cuối</div>
                            <div class="stat-status normal">BÌNH THƯỜNG</div>
                        </div>
                        <div class="stat-card card-hover">
                            <div class="stat-value" id="avg-cycle-length">28</div>
                            <div class="stat-label">Chu kỳ TB</div>
                            <div class="stat-status normal">ĐỀU ĐẶN</div>
                        </div>
                        <div class="stat-card card-hover">
                            <div class="stat-value" id="total-cycles-tracked">0</div>
                            <div class="stat-label">Tổng chu kỳ</div>
                            <div class="stat-status tracking">ĐÃ THEO DÕI</div>
                        </div>
                    </div>
                    <!-- Charts -->
                    <div class="chart-container card-hover">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            Độ dài chu kỳ
                        </div>
                        <div class="chart-wrapper cycle-chart">
                            <canvas id="cycle-length-chart"></canvas>
                        </div>
                        <div class="stat-status normal text-center mt-20">ĐỀU ĐẶN</div>
                    </div>
                    <div class="chart-container card-hover">
                        <div class="chart-title">
                            <i class="fas fa-droplet"></i>
                            Thời gian kinh nguyệt
                        </div>
                        <div class="chart-wrapper period-chart">
                            <canvas id="period-length-chart"></canvas>
                        </div>
                        <div class="stat-status normal text-center mt-20">ĐỀU ĐẶN</div>
                    </div>
                    <div class="chart-container card-hover">
                        <div class="chart-title">
                            <i class="fas fa-heart"></i>
                            Khả năng thụ thai
                        </div>
                        <div class="chart-wrapper fertility-chart">
                            <canvas id="fertility-chart"></canvas>
                        </div>
                        <div class="text-center mt-20">
                            <small style="color: #666;">Dựa trên chu kỳ trung bình của bạn</small>
                        </div>
                    </div>
                    <!-- Doctor Report -->
                    <div class="chart-container text-center card-hover">
                        <div class="chart-title">
                            <i class="fas fa-file-medical"></i>
                            Báo cáo cho bác sĩ
                        </div>
                        <p style="margin-bottom: 15px; color: #666;">Chia sẻ triệu chứng, chu kỳ và dữ liệu khác với bác sĩ
                            của bạn</p>
                        <button class="btn" id="generate-report-btn">
                            <i class="fas fa-file-medical"></i>
                            Tạo báo cáo
                        </button>
                    </div>
                </section>
                <!-- Symptoms Analysis Section -->
                <section class="section" id="symptoms-analysis">
                    <h2 class="section-title">
                        <i class="fas fa-notes-medical"></i>
                        Phân Tích Triệu Chứng
                    </h2>
                    <!-- Trends Filter -->
                    <div class="form-group">
                        <label class="form-label">Thời gian phân tích:</label>
                        <select id="trends-filter" class="form-control">
                            <option value="3">3 tháng gần nhất</option>
                            <option value="6">6 tháng gần nhất</option>
                            <option value="12">12 tháng gần nhất</option>
                        </select>
                    </div>
                    <!-- Phase Filter -->
                    <div class="activity-section">
                        <label class="form-label">Giai đoạn chu kỳ:</label>
                        <div class="activity-options">
                            <div class="activity-option selected" data-phase="all">
                                <div class="activity-icon">🔄</div>
                                <div class="activity-label">Tất cả</div>
                            </div>
                            <div class="activity-option" data-phase="menstrual">
                                <div class="activity-icon">🔴</div>
                                <div class="activity-label">Kinh nguyệt</div>
                            </div>
                            <div class="activity-option" data-phase="follicular">
                                <div class="activity-icon">🌱</div>
                                <div class="activity-label">Nang trứng</div>
                            </div>
                        </div>
                    </div>
                    <!-- Symptoms Summary -->
                    <div class="chart-container card-hover">
                        <div class="chart-title">
                            <i class="fas fa-chart-pie"></i>
                            Tổng quan triệu chứng
                        </div>
                        <div id="symptoms-summary">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--accent-color);"
                                    id="total-symptoms">0</div>
                                <div style="color: #666; margin-top: 5px;">lần ghi nhận triệu chứng</div>
                                <div style="margin-top: 10px; font-size: 0.9rem; color: #666;" id="most-common-symptom">
                                    Chưa có dữ liệu
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Top Symptoms -->
                    <div class="chart-container card-hover">
                        <div class="chart-title">
                            <i class="fas fa-list-ol"></i>
                            Triệu chứng thường gặp
                        </div>
                        <div id="top-symptoms-list">
                            <!-- JS render -->
                        </div>
                    </div>
                    <!-- Symptoms Timeline -->
                    <div class="chart-container card-hover">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            Lịch sử triệu chứng
                        </div>
                        <div class="chart-wrapper symptoms-chart">
                            <canvas id="symptoms-timeline-chart"></canvas>
                        </div>
                    </div>
                </section>
                <!-- History Section -->
                <section class="section" id="history">
                    <h2 class="section-title">
                        <i class="fas fa-clock-rotate-left"></i>
                        Lịch Sử Chu Kỳ
                    </h2>
                    <!-- Filter Options -->
                    <div class="form-group">
                        <label class="form-label">Lọc theo loại hoạt động:</label>
                        <select id="history-filter" class="form-control">
                            <option value="all">Tất cả hoạt động</option>
                            <option value="period-start">Bắt đầu kinh nguyệt</option>
                            <option value="symptoms">Triệu chứng</option>
                            <option value="ovulation">Rụng trứng</option>
                            <option value="sexual-activity">Hoạt động tình dục</option>
                        </select>
                    </div>
                    <div id="history-timeline">
                        <!-- Sẽ được render bởi JS -->
                    </div>
                </section>
                <!-- Settings Section -->
                <section class="section" id="settings">
                    <h2 class="section-title">
                        <i class="fas fa-gear"></i>
                        Cài Đặt
                    </h2>
                    <div class="settings-section">
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-moon"></i>
                                <span>Chế độ tối</span>
                            </div>
                            <label class="theme-toggle">
                                <input type="checkbox" id="theme-switch" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-bell"></i>
                                <span>Thông báo chu kỳ</span>
                            </div>
                            <label class="theme-toggle">
                                <input type="checkbox" id="notification-switch" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-calendar-check"></i>
                                <span>Độ dài chu kỳ trung bình</span>
                            </div>
                            <input type="number" id="cycle-length-setting" min="21" max="35" value="28"
                                style="width: 80px; padding: 8px; margin: 0;" class="form-control" />
                        </div>
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-droplet"></i>
                                <span>Thời gian kinh trung bình</span>
                            </div>
                            <input type="number" id="period-length-setting" min="3" max="8" value="5"
                                style="width: 80px; padding: 8px; margin: 0;" class="form-control" />
                        </div>
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-download"></i>
                                <span>Sao lưu dữ liệu</span>
                            </div>
                            <button class="btn" id="export-btn" style="width: auto; padding: 8px 16px; margin: 0;">
                                <i class="fas fa-download"></i>
                                Xuất
                            </button>
                        </div>
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-upload"></i>
                                <span>Khôi phục dữ liệu</span>
                            </div>
                            <button class="btn" id="import-btn" style="width: auto; padding: 8px; margin: 0;">
                                <i class="fas fa-upload"></i>
                                Nhập
                            </button>
                        </div>
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-trash"></i>
                                <span>Xóa tất cả dữ liệu</span>
                            </div>
                            <button class="btn btn-secondary" id="clear-data-btn"
                                style="width: auto; padding: 8px 16px; margin: 0; background: linear-gradient(135deg, var(--danger-color), #ff1744);">
                                <i class="fas fa-trash"></i>
                                Xóa
                            </button>
                        </div>
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-info-circle"></i>
                                <span>Phiên bản ứng dụng</span>
                            </div>
                            <span class="badge">v2.2.0</span>
                        </div>
                        <div class="settings-item">
                            <div class="settings-label">
                                <i class="fas fa-shield-alt"></i>
                                <span>Bảo mật dữ liệu</span>
                            </div>
                            <span style="font-size: 0.8rem; color: var(--success-color);"> <i class="fas fa-check"></i> Dữ
                                liệu được lưu cục bộ </span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-section="dashboard" aria-label="Lịch">
                <i class="fas fa-calendar-days"></i>
                <span>Lịch</span>
            </a>
            <a href="#" class="nav-item" data-section="stats" aria-label="Thống kê">
                <i class="fas fa-chart-line"></i>
                <span>Thống kê</span>
            </a>
            <a href="#" class="nav-item add-item" id="add-cycle-btn" aria-label="Thêm hoạt động">
                <i class="fas fa-plus"></i>
            </a>
            <a href="#" class="nav-item" data-section="symptoms-analysis" aria-label="Triệu chứng">
                <i class="fas fa-notes-medical"></i>
                <span>Triệu chứng</span>
            </a>
            <a href="#" class="nav-item" data-section="settings" aria-label="Cài đặt">
                <i class="fas fa-gear"></i>
                <span>Cài đặt</span>
            </a>
        </nav>
        <!-- Quick Add Form -->
        <div class="quick-add-form" id="quick-add-form">
            <div class="form-header">
                <span class="form-title">
                    <i class="fas fa-plus-circle"></i>
                    Ghi nhận chu kỳ
                </span>
                <button type="button" class="close-btn" id="cancel-quick-form" aria-label="Đóng">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="quick-cycle-form">
                <!-- Chọn ngày -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i>
                        Chọn ngày:
                    </label>
                    <input type="date" id="cycle-date" class="form-control" required />
                </div>
                <!-- Week Selector -->
                <div class="week-selector" id="week-selector">
                    <!-- Sẽ được JS render 7 ngày trong tuần -->
                </div>
                <!-- Loại hoạt động -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-list"></i>
                        Loại hoạt động:
                    </label>
                    <select id="cycle-type" class="form-control" required>
                        <option value="" disabled selected>Chọn loại ghi nhận</option>
                        <option value="period-start">🔴 Bắt đầu kinh nguyệt</option>
                        <option value="period-end">⚪ Kết thúc kinh nguyệt</option>
                        <option value="symptoms">📝 Triệu chứng</option>
                        <option value="ovulation">🥚 Rụng trứng</option>
                        <option value="sexual-activity">💕 Hoạt động tình dục</option>
                    </select>
                </div>
                <!-- Sexual Activity -->
                <div class="activity-section hidden" id="sexual-activity-section">
                    <label class="form-label">
                        <i class="fas fa-heart"></i>
                        Hoạt động tình dục:
                    </label>
                    <div class="activity-options">
                        <div class="activity-option" data-activity="unprotected">
                            <div class="activity-icon">❤️</div>
                            <div class="activity-label">Không bảo vệ</div>
                        </div>
                        <div class="activity-option" data-activity="protected">
                            <div class="activity-icon">🛡️</div>
                            <div class="activity-label">Có bảo vệ</div>
                        </div>
                    </div>
                </div>
                <!-- Flow Intensity -->
                <div class="activity-section hidden" id="flow-intensity-section">
                    <label class="form-label">
                        <i class="fas fa-droplet"></i>
                        Lưu lượng kinh:
                    </label>
                    <div class="activity-options">
                        <div class="activity-option" data-flow="light">
                            <div class="activity-icon">💧</div>
                            <div class="activity-label">Nhẹ</div>
                        </div>
                        <div class="activity-option" data-flow="medium">
                            <div class="activity-icon">💧💧</div>
                            <div class="activity-label">Vừa</div>
                        </div>
                        <div class="activity-option" data-flow="heavy">
                            <div class="activity-icon">💧💧💧</div>
                            <div class="activity-label">Nhiều</div>
                        </div>
                    </div>
                </div>
                <!-- Symptoms Section -->
                <div class="symptoms-section hidden" id="symptoms-section">
                    <label class="form-label">
                        <i class="fas fa-notes-medical"></i>
                        Triệu chứng:
                    </label>
                    <button type="button" class="show-all-btn" id="show-all-symptoms">
                        <i class="fas fa-eye"></i>
                        Hiện tất cả
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="symptoms-grid" id="symptoms-grid">
                        <div class="symptom-item" data-symptom="cramps">
                            <div class="symptom-icon">🤕</div>
                            <div class="symptom-label">Đau bụng</div>
                        </div>
                        <div class="symptom-item" data-symptom="backache">
                            <div class="symptom-icon">🦴</div>
                            <div class="symptom-label">Đau lưng</div>
                        </div>
                        <div class="symptom-item" data-symptom="headache">
                            <div class="symptom-icon">🤯</div>
                            <div class="symptom-label">Đau đầu</div>
                        </div>
                        <div class="symptom-item" data-symptom="fatigue">
                            <div class="symptom-icon">😴</div>
                            <div class="symptom-label">Mệt mỏi</div>
                        </div>
                        <div class="symptom-item" data-symptom="acne">
                            <div class="symptom-icon">😖</div>
                            <div class="symptom-label">Mụn</div>
                        </div>
                        <div class="symptom-item" data-symptom="bloating">
                            <div class="symptom-icon">🤰</div>
                            <div class="symptom-label">Đầy hơi</div>
                        </div>
                        <div class="symptom-item" data-symptom="tender-breasts">
                            <div class="symptom-icon">😣</div>
                            <div class="symptom-label">Căng ngực</div>
                        </div>
                        <div class="symptom-item" data-symptom="nausea">
                            <div class="symptom-icon">🤢</div>
                            <div class="symptom-label">Buồn nôn</div>
                        </div>
                        <div class="symptom-item hidden" data-symptom="mood-swings">
                            <div class="symptom-icon">😤</div>
                            <div class="symptom-label">Thay đổi tâm trạng</div>
                        </div>
                        <div class="symptom-item hidden" data-symptom="cravings">
                            <div class="symptom-icon">🍫</div>
                            <div class="symptom-label">Thèm ăn</div>
                        </div>
                        <div class="symptom-item hidden" data-symptom="insomnia">
                            <div class="symptom-icon">😵</div>
                            <div class="symptom-label">Mất ngủ</div>
                        </div>
                        <div class="symptom-item hidden" data-symptom="dizziness">
                            <div class="symptom-icon">😵‍💫</div>
                            <div class="symptom-label">Chóng mặt</div>
                        </div>
                    </div>
                </div>
                <!-- Mood Section -->
                <div class="mood-section hidden" id="mood-section">
                    <label class="form-label">
                        <i class="fas fa-smile"></i>
                        Tâm trạng (có thể chọn nhiều):
                    </label>
                    <button type="button" class="show-all-btn" id="show-all-moods">
                        <i class="fas fa-eye"></i>
                        Hiện tất cả
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="mood-grid" id="mood-grid">
                        <div class="mood-item" data-mood="happy">
                            <div class="mood-emoji">😊</div>
                            <div class="mood-label">Vui vẻ</div>
                        </div>
                        <div class="mood-item" data-mood="sad">
                            <div class="mood-emoji">😢</div>
                            <div class="mood-label">Buồn</div>
                        </div>
                        <div class="mood-item" data-mood="angry">
                            <div class="mood-emoji">😠</div>
                            <div class="mood-label">Tức giận</div>
                        </div>
                        <div class="mood-item" data-mood="anxious">
                            <div class="mood-emoji">😰</div>
                            <div class="mood-label">Lo lắng</div>
                        </div>
                        <div class="mood-item hidden" data-mood="excited">
                            <div class="mood-emoji">🤩</div>
                            <div class="mood-label">Phấn khích</div>
                        </div>
                        <div class="mood-item hidden" data-mood="calm">
                            <div class="mood-emoji">😌</div>
                            <div class="mood-label">Bình tĩnh</div>
                        </div>
                        <div class="mood-item hidden" data-mood="tired">
                            <div class="mood-emoji">😪</div>
                            <div class="mood-label">Mệt mỏi</div>
                        </div>
                        <div class="mood-item hidden" data-mood="neutral">
                            <div class="mood-emoji">😐</div>
                            <div class="mood-label">Bình thường</div>
                        </div>
                    </div>
                </div>
                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Ghi chú (tùy chọn):
                    </label>
                    <textarea id="cycle-note" class="form-control"
                        placeholder="Thêm ghi chú về cảm giác, hoạt động, thuốc uống..." rows="3"></textarea>
                </div>
                <!-- Form Actions -->
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i>
                        Lưu
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancel-form-btn">
                        <i class="fas fa-times"></i>
                        Hủy
                    </button>
                </div>
            </form>
        </div>
        <!-- Day Detail Modal -->
        <div class="day-detail-modal" id="day-detail-modal">
            <div class="day-detail-content">
                <div class="day-detail-header">
                    <h3 class="day-detail-title" id="day-detail-title">
                        <i class="fas fa-calendar-day"></i>
                        Chi tiết ngày
                    </h3>
                    <button class="day-detail-close" id="day-detail-close" aria-label="Đóng">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="day-info">
                    <div class="day-date" id="day-detail-date">Ngày</div>
                    <div class="day-phase" id="day-detail-phase">Giai đoạn</div>
                </div>
                <div class="day-activities" id="day-activities-list">
                    <!-- Activities will be populated by JavaScript -->
                </div>
                <div class="empty-day" id="empty-day-state" style="display: none;">
                    <i class="fas fa-calendar-plus"></i>
                    <p>Chưa có hoạt động nào trong ngày này</p>
                    <p style="font-size: 0.9rem; color: #666;">Thêm dữ liệu để theo dõi chu kỳ tốt hơn</p>
                </div>
                <button class="add-activity-btn" id="add-activity-from-day">
                    <i class="fas fa-plus"></i>
                    Thêm hoạt động
                </button>
                <div class="quick-actions">
                    <button class="quick-action-btn" id="quick-add-period">
                        <i class="fas fa-droplet"></i>
                        Kinh nguyệt
                    </button>
                    <button class="quick-action-btn" id="quick-add-symptoms">
                        <i class="fas fa-notes-medical"></i>
                        Triệu chứng
                    </button>
                </div>
            </div>
        </div>
        <!-- Hidden File Input, Loading Indicator -->
        <input type="file" id="import-file" accept=".json" style="display: none;" />
        <div id="loading-indicator" class="loading-indicator" style="display: none;">
            <div class="loading-spinner"></div>
            <div>Đang xử lý...</div>
        </div>
        <script>
            // ===== ENHANCED APPLICATION CORE - iOS Shortcuts Compatible =====
            window.onerror = function (msg, url, line, col, error) {
                console.error("Error:", msg, "at", url, ":", line);
                return false;
            };

            function isIOSShortcuts() {
                return navigator.userAgent.includes("Shortcuts") || navigator.userAgent.includes("SafariViewService") || window.webkit?.messageHandlers;
            }

            function isNotificationSupported() {
                if (isIOSShortcuts()) return false;
                if (typeof Notification === "undefined") return false;
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) return false;
                return true;
            }

            class CycleTracker {
                constructor() {
                    this.version = "2.2.0";
                    this.performanceStart = performance.now();
                    this.isInitialized = false;
                    this.charts = {};
                    this.animations = {};
                    this.notifications = {};
                    this.ai = new AIInsights();

                    // Enhanced data structures
                    this.data = {
                        cycles: [],
                        settings: {
                            averageCycleLength: 28,
                            averagePeriodLength: 5,
                            theme: "auto",
                            notifications: false,
                            language: "vi",
                            aiInsights: true,
                            dataBackup: true,
                        },
                        preferences: {
                            animationsEnabled: !isIOSShortcuts(), // Disable animations in iOS Shortcuts
                            hapticFeedback: !isIOSShortcuts(), // Disable haptic in iOS Shortcuts
                            soundEffects: false,
                            privacyMode: false,
                        },
                        cache: {
                            lastCalculation: null,
                            predictions: {},
                            insights: {},
                        },
                    };

                    // Enhanced state management
                    this.state = {
                        currentMonth: new Date().getMonth(),
                        currentYear: new Date().getFullYear(),
                        selectedDate: new Date(),
                        selectedDayData: null,
                        isOnline: navigator.onLine,
                        activeSection: "dashboard",
                        formMode: "add",
                        editingId: null,
                    };

                    // Performance monitoring
                    this.performance = {
                        loadTime: 0,
                        renderTime: 0,
                        calculationTime: 0,
                        chartRenderTime: 0,
                    };

                    this.init();
                }

                // ===== ENHANCED INITIALIZATION =====
                async init() {
                    try {
                        console.log(`🌸 Initializing Chu Kỳ v${this.version}...`);

                        // Show loading screen
                        this.showLoadingScreen();

                        // Initialize data with validation
                        await this.initializeData();

                        // Setup enhanced event listeners
                        this.setupEventListeners();

                        // Initialize UI components
                        await this.initializeUI();

                        // Setup performance monitoring
                        this.setupPerformanceMonitoring();

                        // Initialize AI insights
                        if (this.data.settings.aiInsights) {
                            await this.ai.initialize(this.data.cycles);
                        }

                        // Setup PWA features (only if not in iOS Shortcuts)
                        if (!isIOSShortcuts()) {
                            this.setupPWA();
                        }

                        // Load cached data and predictions
                        this.loadCachedData();

                        // Initialize all sections
                        this.updateAllSections();

                        // Hide loading screen
                        this.hideLoadingScreen();

                        // Show welcome message
                        this.showWelcomeMessage();

                        this.isInitialized = true;
                        this.performance.loadTime = performance.now() - this.performanceStart;

                        console.log(`✅ Chu Kỳ initialized successfully in ${Math.round(this.performance.loadTime)}ms`);
                    } catch (error) {
                        console.error("❌ Failed to initialize application:", error);
                        this.handleInitializationError(error);
                    }
                }

                // ===== ENHANCED DATA MANAGEMENT =====
                async initializeData() {
                    try {
                        // Load existing data with validation
                        const savedCycles = localStorage.getItem("cycles");
                        const savedSettings = localStorage.getItem("cycleSettings");
                        const savedPreferences = localStorage.getItem("appPreferences");

                        if (savedCycles) {
                            this.data.cycles = this.validateCyclesData(JSON.parse(savedCycles));
                        }

                        if (savedSettings) {
                            this.data.settings = {
                                ...this.data.settings,
                                ...JSON.parse(savedSettings),
                            };
                        }

                        if (savedPreferences) {
                            this.data.preferences = {
                                ...this.data.preferences,
                                ...JSON.parse(savedPreferences),
                            };
                        }

                        // Migrate old data format if needed
                        this.migrateDataFormat();

                        // Setup auto-backup
                        if (this.data.settings.dataBackup) {
                            this.setupAutoBackup();
                        }

                        // Validate data integrity
                        this.validateDataIntegrity();
                    } catch (error) {
                        console.error("Failed to initialize data:", error);
                        this.handleDataError(error);
                    }
                }

                validateCyclesData(cycles) {
                    if (!Array.isArray(cycles)) return [];

                    return cycles
                        .filter((cycle) => {
                            return cycle && cycle.id && cycle.date && cycle.type && this.isValidDate(cycle.date) && ["period-start", "period-end", "symptoms", "ovulation", "sexual-activity"].includes(cycle.type);
                        })
                        .map((cycle) => ({
                            ...cycle,
                            id: cycle.id || Date.now() + Math.random(),
                            timestamp: cycle.timestamp || new Date().toISOString(),
                        }));
                }

                isValidDate(dateString) {
                    const date = new Date(dateString);
                    return date instanceof Date && !isNaN(date) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
                }

                migrateDataFormat() {
                    // Migrate from older versions
                    let needsSave = false;

                    this.data.cycles.forEach((cycle) => {
                        // Add missing properties for v2.2
                        if (!cycle.confidence) {
                            cycle.confidence = 0.5;
                            needsSave = true;
                        }

                        if (!cycle.tags) {
                            cycle.tags = [];
                            needsSave = true;
                        }

                        // Convert old mood format to new array format
                        if (cycle.mood && typeof cycle.mood === "string") {
                            cycle.moods = [cycle.mood];
                            delete cycle.mood;
                            needsSave = true;
                        }
                    });

                    if (needsSave) {
                        this.saveData();
                        console.log("📦 Data migrated to v2.2 format");
                    }
                }

                validateDataIntegrity() {
                    const issues = [];

                    // Check for duplicate entries
                    const dateTypeMap = new Map();
                    this.data.cycles.forEach((cycle, index) => {
                        const key = `${cycle.date}-${cycle.type}`;
                        if (dateTypeMap.has(key)) {
                            issues.push(`Duplicate entry found: ${key}`);
                        }
                        dateTypeMap.set(key, index);
                    });

                    // Check for impossible dates
                    const today = new Date().toISOString().split("T")[0];
                    this.data.cycles.forEach((cycle) => {
                        if (cycle.date > today) {
                            issues.push(`Future date found: ${cycle.date}`);
                        }
                    });

                    // Check cycle length consistency
                    const periodStarts = this.data.cycles.filter((c) => c.type === "period-start").sort((a, b) => new Date(a.date) - new Date(b.date));

                    for (let i = 1; i < periodStarts.length; i++) {
                        const daysDiff = Math.floor((new Date(periodStarts[i].date) - new Date(periodStarts[i - 1].date)) / (1000 * 60 * 60 * 24));
                        if (daysDiff < 15 || daysDiff > 45) {
                            issues.push(`Unusual cycle length: ${daysDiff} days between ${periodStarts[i - 1].date} and ${periodStarts[i].date}`);
                        }
                    }

                    if (issues.length > 0) {
                        console.warn("⚠️ Data integrity issues found:", issues);
                    }

                    return issues;
                }

                // ===== ENHANCED SAVE/LOAD METHODS =====
                saveData() {
                    try {
                        localStorage.setItem("cycles", JSON.stringify(this.data.cycles));
                        localStorage.setItem("cycleSettings", JSON.stringify(this.data.settings));
                        localStorage.setItem("appPreferences", JSON.stringify(this.data.preferences));

                        // Update cache timestamp
                        this.data.cache.lastSave = Date.now();

                        // Trigger auto-backup if enabled
                        if (this.data.settings.dataBackup) {
                            this.scheduleAutoBackup();
                        }

                        return true;
                    } catch (error) {
                        console.error("Failed to save data:", error);
                        this.showToast("Lỗi lưu dữ liệu! Dung lượng có thể đã đầy. 💾", "error");
                        return false;
                    }
                }

                // ===== ENHANCED CYCLE CALCULATIONS =====
                calculateCycleStats() {
                    const startTime = performance.now();

                    // Check cache first
                    const cacheKey = this.generateCacheKey();
                    if (this.data.cache.lastCalculation && this.data.cache.lastCalculation.key === cacheKey) {
                        return this.data.cache.lastCalculation.result;
                    }

                    const periodStarts = this.data.cycles.filter((c) => c.type === "period-start").sort((a, b) => new Date(a.date) - new Date(b.date));

                    if (periodStarts.length < 2) {
                        const result = {
                            averageCycleLength: this.data.settings.averageCycleLength,
                            averagePeriodLength: this.data.settings.averagePeriodLength,
                            daysSinceLastPeriod: 0,
                            totalCycles: periodStarts.length,
                            nextPeriodDate: null,
                            currentPhase: "unknown",
                            cycleLengths: [],
                            isRegular: false,
                            confidence: 0,
                            variability: 0,
                            trend: "stable",
                            predictions: {},
                        };

                        this.cacheCalculation(cacheKey, result);
                        return result;
                    }

                    // Enhanced cycle length calculation
                    const cycleLengths = [];
                    for (let i = 1; i < periodStarts.length; i++) {
                        const diff = Math.floor((new Date(periodStarts[i].date) - new Date(periodStarts[i - 1].date)) / (1000 * 60 * 60 * 24));
                        if (diff > 0 && diff <= 45) {
                            cycleLengths.push(diff);
                        }
                    }

                    const avgCycleLength = cycleLengths.length > 0 ? Math.round(cycleLengths.reduce((a, b) => a + b, 0) / cycleLengths.length) : this.data.settings.averageCycleLength;

                    // Enhanced regularity and confidence calculation
                    const variability = this.calculateVariability(cycleLengths);
                    const isRegular = variability <= 7 && cycleLengths.length >= 3;
                    const confidence = this.calculateConfidence(cycleLengths, variability);

                    // Trend analysis
                    const trend = this.analyzeTrend(cycleLengths);

                    // Enhanced predictions
                    const predictions = this.generatePredictions(periodStarts, avgCycleLength, confidence);

                    // Current phase calculation
                    const lastPeriod = new Date(periodStarts[periodStarts.length - 1].date);
                    const today = new Date();
                    const daysSince = Math.floor((today - lastPeriod) / (1000 * 60 * 60 * 24));
                    const currentPhase = this.determineCurrentPhase(daysSince, avgCycleLength);

                    // Next period prediction with confidence interval
                    const nextPeriod = new Date(lastPeriod);
                    nextPeriod.setDate(nextPeriod.getDate() + avgCycleLength);

                    const result = {
                        averageCycleLength,
                        averagePeriodLength: this.data.settings.averagePeriodLength,
                        daysSinceLastPeriod: daysSince,
                        totalCycles: periodStarts.length,
                        nextPeriodDate: nextPeriod,
                        currentPhase,
                        cycleLengths,
                        isRegular,
                        confidence,
                        variability,
                        trend,
                        predictions,
                        lastPeriodDate: lastPeriod,
                        cycleDay: daysSince + 1,
                    };

                    // Cache the result
                    this.cacheCalculation(cacheKey, result);

                    this.performance.calculationTime = performance.now() - startTime;
                    return result;
                }

                calculateVariability(cycleLengths) {
                    if (cycleLengths.length < 2) return 0;

                    const mean = cycleLengths.reduce((a, b) => a + b, 0) / cycleLengths.length;
                    const variance = cycleLengths.reduce((sum, length) => sum + Math.pow(length - mean, 2), 0) / cycleLengths.length;
                    return Math.sqrt(variance);
                }

                calculateConfidence(cycleLengths, variability) {
                    if (cycleLengths.length === 0) return 0;

                    // Base confidence on number of cycles and regularity
                    const cycleScore = Math.min(cycleLengths.length / 12, 1) * 60; // Max 60% for cycle count
                    const regularityScore = Math.max(0, (7 - variability) / 7) * 40; // Max 40% for regularity

                    return Math.round(cycleScore + regularityScore);
                }

                analyzeTrend(cycleLengths) {
                    if (cycleLengths.length < 6) return "stable";

                    const recent = cycleLengths.slice(-6);
                    const older = cycleLengths.slice(-12, -6);

                    if (older.length === 0) return "stable";

                    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                    const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;

                    const difference = recentAvg - olderAvg;

                    if (difference > 2) return "lengthening";
                    if (difference < -2) return "shortening";
                    return "stable";
                }

                determineCurrentPhase(daysSince, avgCycleLength) {
                    if (daysSince <= this.data.settings.averagePeriodLength) {
                        return "menstrual";
                    } else if (daysSince <= Math.floor(avgCycleLength * 0.5)) {
                        return "follicular";
                    } else if (daysSince <= Math.floor(avgCycleLength * 0.6)) {
                        return "ovulation";
                    } else {
                        return "luteal";
                    }
                }

                generatePredictions(periodStarts, avgCycleLength, confidence) {
                    if (periodStarts.length === 0) return {};

                    const lastPeriod = new Date(periodStarts[periodStarts.length - 1].date);
                    const predictions = {};

                    // Predict next 6 periods
                    for (let i = 1; i <= 6; i++) {
                        const predictedDate = new Date(lastPeriod);
                        predictedDate.setDate(predictedDate.getDate() + avgCycleLength * i);

                        // Add confidence interval
                        const earliestDate = new Date(predictedDate);
                        const latestDate = new Date(predictedDate);
                        const variance = Math.max(2, Math.floor((100 - confidence) / 20));

                        earliestDate.setDate(earliestDate.getDate() - variance);
                        latestDate.setDate(latestDate.getDate() + variance);

                        predictions[`period_${i}`] = {
                            date: predictedDate,
                            earliest: earliestDate,
                            latest: latestDate,
                            confidence: Math.max(10, confidence - i * 5),
                        };
                    }

                    // Predict ovulation dates
                    for (let i = 1; i <= 3; i++) {
                        const ovulationDate = new Date(predictions[`period_${i}`].date);
                        ovulationDate.setDate(ovulationDate.getDate() - 14);

                        predictions[`ovulation_${i}`] = {
                            date: ovulationDate,
                            confidence: predictions[`period_${i}`].confidence,
                        };
                    }

                    return predictions;
                }

                generateCacheKey() {
                    return `cycles_${this.data.cycles.length}_${this.data.settings.averageCycleLength}_${this.data.settings.averagePeriodLength}`;
                }

                cacheCalculation(key, result) {
                    this.data.cache.lastCalculation = {
                        key,
                        result,
                        timestamp: Date.now(),
                    };
                }

                // ===== ENHANCED UI MANAGEMENT =====
                async initializeUI() {
                    console.log("🎨 Initializing UI components...");

                    // Setup theme management
                    this.setupThemeManagement();

                    // Initialize enhanced navigation
                    this.setupEnhancedNavigation();

                    // Setup form management
                    this.setupFormManagement();

                    // Initialize calendar with animations
                    this.setupEnhancedCalendar();

                    // Setup touch gestures (if not iOS Shortcuts)
                    if (!isIOSShortcuts()) {
                        this.setupTouchGestures();
                    }

                    // Initialize tooltips and help system
                    this.setupTooltipsAndHelp();

                    // Setup accessibility features
                    this.setupAccessibility();

                    // Initialize performance monitoring UI
                    this.setupPerformanceUI();

                    // Setup settings handlers
                    this.setupSettingsHandlers();
                }

                // ===== ENHANCED THEME MANAGEMENT =====
                setupThemeManagement() {
                    const savedTheme = this.data.settings.theme || "auto";
                    this.applyTheme(savedTheme);

                    // Enhanced theme switch with smooth transitions
                    $("#theme-switch").prop("checked", savedTheme === "dark");

                    $("#theme-switch").change(() => {
                        const isChecked = $("#theme-switch").is(":checked");
                        const newTheme = isChecked ? "dark" : "light";

                        // Add transition class (only if animations enabled)
                        if (this.data.preferences.animationsEnabled) {
                            $("body").addClass("theme-transitioning");
                        }

                        // Apply theme with animation
                        this.applyTheme(newTheme);

                        // Save preference
                        this.data.settings.theme = newTheme;
                        this.saveData();

                        // Remove transition class after animation
                        setTimeout(() => {
                            $("body").removeClass("theme-transitioning");
                            this.updateAllCharts();
                        }, 300);

                        this.showToast(`Đã chuyển sang chế độ ${isChecked ? "tối" : "sáng"}! 🎨`, "success");
                    });

                    // Auto theme detection with enhanced logic
                    const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
                    mediaQuery.addEventListener("change", (e) => {
                        if (this.data.settings.theme === "auto") {
                            this.applyTheme("auto");
                            this.updateAllCharts();
                        }
                    });
                }

                applyTheme(theme) {
                    const body = document.body;

                    // Remove existing theme classes
                    body.classList.remove("theme-light", "theme-dark", "theme-auto");

                    // Apply new theme
                    body.classList.add(`theme-${theme}`);

                    // Update meta theme color
                    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
                    if (metaThemeColor) {
                        const isDark = theme === "dark" || (theme === "auto" && window.matchMedia("(prefers-color-scheme: dark)").matches);
                        metaThemeColor.content = isDark ? "#1a1a2e" : "#e91e63";
                    }

                    // Update CSS custom properties for dynamic theming
                    this.updateThemeProperties(theme);
                }

                updateThemeProperties(theme) {
                    const isDark = theme === "dark" || (theme === "auto" && window.matchMedia("(prefers-color-scheme: dark)").matches);

                    const root = document.documentElement;

                    if (isDark) {
                        root.style.setProperty("--current-bg", "var(--dark-gradient)");
                        root.style.setProperty("--current-text", "var(--text-dark-primary)");
                        root.style.setProperty("--current-card-bg", "var(--glass-gradient-dark)");
                    } else {
                        root.style.setProperty("--current-bg", "var(--primary-gradient)");
                        root.style.setProperty("--current-text", "var(--text-primary)");
                        root.style.setProperty("--current-card-bg", "var(--glass-gradient)");
                    }
                }

                // ===== ENHANCED NAVIGATION =====
                setupEnhancedNavigation() {
                    $(".nav-item")
                        .off("click")
                        .on("click", (e) => {
                            e.preventDefault();
                            const $item = $(e.currentTarget);

                            if ($item.hasClass("add-item")) {
                                this.openQuickAddForm();
                                return;
                            }

                            const section = $item.data("section");
                            if (!section || $item.hasClass("active")) return;

                            this.navigateToSection(section);
                        });

                    // Enhanced keyboard navigation
                    $(document).keydown((e) => {
                        if (e.altKey && e.key >= "1" && e.key <= "5") {
                            e.preventDefault();
                            const sections = ["dashboard", "stats", "", "symptoms-analysis", "settings"];
                            const sectionIndex = parseInt(e.key) - 1;
                            if (sections[sectionIndex] && sectionIndex !== 2) {
                                this.navigateToSection(sections[sectionIndex]);
                            }
                        }
                    });

                    $("#generate-report-btn")
                        .off("click")
                        .on("click", () => {
                            this.generateDoctorReport();
                        });

                    // Handle browser back/forward
                    window.addEventListener("popstate", (e) => {
                        const section = e.state?.section || "dashboard";
                        this.navigateToSection(section, false);
                    });
                }

                navigateToSection(section, updateHistory = true) {
                    // Add loading state for heavy sections
                    if (["stats", "symptoms-analysis"].includes(section)) {
                        this.showSectionLoading(section);
                    }

                    // Update navigation state
                    $(".nav-item").removeClass("active");
                    $(`.nav-item[data-section="${section}"]`).addClass("active");

                    // Animate section transition (only if animations enabled)
                    if (this.data.preferences.animationsEnabled) {
                        this.animateSectionTransition(section);
                    } else {
                        $(".section").removeClass("active");
                        $(`#${section}`).addClass("active");
                    }

                    // Update browser history
                    if (updateHistory) {
                        history.pushState(
                            {
                                section,
                            },
                            "",
                            `#${section}`
                        );
                    }

                    // Update state
                    this.state.activeSection = section;

                    // Load section content with delay for smooth animation
                    setTimeout(
                        () => {
                            this.updateSectionContent(section);
                            this.hideSectionLoading();
                        },
                        this.data.preferences.animationsEnabled ? 150 : 0
                    );
                }

                animateSectionTransition(targetSection) {
                    const $activeSection = $(".section.active");
                    const $targetSection = $(`#${targetSection}`);

                    // Fade out current section
                    $activeSection.removeClass("active").addClass("fading-out");

                    // Fade in target section after delay
                    setTimeout(() => {
                        $activeSection.removeClass("fading-out");
                        $targetSection.addClass("active");

                        // Add entrance animation
                        $targetSection.addClass("entering");
                        setTimeout(() => $targetSection.removeClass("entering"), 300);
                    }, 150);
                }

                showSectionLoading(section) {
                    const $section = $(`#${section}`);
                    if (!$section.find(".section-loading").length) {
                        $section.prepend(`
                        <div class="section-loading">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Đang tải dữ liệu...</div>
                        </div>
                    `);
                    }
                }

                hideSectionLoading() {
                    $(".section-loading").fadeOut(200, function () {
                        $(this).remove();
                    });
                }

                updateSectionContent(section) {
                    switch (section) {
                        case "dashboard":
                            this.updateDashboard();
                            break;
                        case "stats":
                            this.updateStats();
                            break;
                        case "symptoms-analysis":
                            this.updateSymptomsAnalysis();
                            break;
                        case "history":
                            this.updateHistory();
                            break;
                        case "settings":
                            this.updateSettings();
                            break;
                    }
                }

                // ===== ENHANCED FORM MANAGEMENT =====
                setupFormManagement() {
                    // Enhanced form opening
                    $("#log-period-btn, #add-cycle-btn, .countdown-circle")
                        .off("click")
                        .on("click", () => {
                            this.openQuickAddForm();
                        });

                    // Quick action buttons
                    $(".quick-action-btn")
                        .off("click")
                        .on("click", (e) => {
                            const action = $(e.currentTarget).data("action");
                            this.openQuickAddForm(action);
                        });

                    // Form closing
                    $("#cancel-quick-form, #cancel-form-btn")
                        .off("click")
                        .on("click", () => {
                            this.closeQuickAddForm();
                        });

                    // Enhanced form submission
                    $("#quick-cycle-form")
                        .off("submit")
                        .on("submit", (e) => {
                            e.preventDefault();
                            this.handleFormSubmission();
                        });

                    // Dynamic form sections
                    $("#cycle-type")
                        .off("change")
                        .on("change", (e) => {
                            this.updateFormSections($(e.target).val());
                        });

                    // Date change handling
                    $("#cycle-date")
                        .off("change")
                        .on("change", (e) => {
                            this.handleDateChange($(e.target).val());
                        });

                    // Auto-save draft
                    this.setupAutoSaveDraft();

                    // Form validation
                    this.setupFormValidation();
                }

                openQuickAddForm(quickAction = null) {
                    const $form = $("#quick-add-form");
                    const $body = $("body");

                    // Add opening animation
                    $form.addClass("active");
                    $body.css("overflow", "hidden");

                    // Set today's date
                    const today = new Date().toISOString().split("T")[0];
                    $("#cycle-date").val(today);
                    this.state.selectedDate = new Date();

                    // Update week selector
                    this.updateWeekSelector();

                    // Handle quick actions
                    if (quickAction) {
                        this.handleQuickAction(quickAction);
                    }

                    // Focus management for accessibility
                    setTimeout(() => {
                        $("#cycle-date").focus();
                    }, 300);

                    // Show contextual help
                    this.showFormHelp();

                    // Add haptic feedback (if enabled)
                    this.triggerHapticFeedback("light");

                    this.showToast("Hãy ghi nhận chu kỳ của bạn! 🌸", "info");
                }

                closeQuickAddForm() {
                    const $form = $("#quick-add-form");
                    const $body = $("body");

                    // Save draft before closing
                    this.saveDraft();

                    // Add closing animation
                    $form.removeClass("active");
                    $body.css("overflow", "auto");

                    // Reset form after animation
                    setTimeout(() => {
                        this.resetForm();
                    }, 300);

                    this.showToast("Đã hủy ghi nhận! 👋", "info");
                }

                handleQuickAction(action) {
                    const actionMap = {
                        period: "period-start",
                        symptoms: "symptoms",
                        mood: "symptoms",
                        ovulation: "ovulation",
                    };

                    const cycleType = actionMap[action];
                    if (cycleType) {
                        $("#cycle-type").val(cycleType).trigger("change");

                        // Pre-select relevant options for mood action
                        if (action === "mood") {
                            setTimeout(() => {
                                $("#mood-section").removeClass("hidden");
                            }, 100);
                        }
                    }
                }

                updateFormSections(cycleType) {
                    // Hide all sections first
                    $(".activity-section, .symptoms-section, .mood-section").addClass("hidden");

                    // Show relevant sections with smooth animation
                    const sectionsToShow = [];

                    switch (cycleType) {
                        case "period-start":
                            sectionsToShow.push("#flow-intensity-section");
                            break;
                        case "symptoms":
                            sectionsToShow.push("#symptoms-section", "#mood-section");
                            break;
                        case "sexual-activity":
                            sectionsToShow.push("#sexual-activity-section");
                            break;
                    }

                    // Animate sections appearing (only if animations enabled)
                    sectionsToShow.forEach((selector, index) => {
                        const delay = this.data.preferences.animationsEnabled ? index * 100 : 0;
                        setTimeout(() => {
                            $(selector).removeClass("hidden");
                            if (this.data.preferences.animationsEnabled) {
                                $(selector).addClass("section-entering");
                                setTimeout(() => $(selector).removeClass("section-entering"), 300);
                            }
                        }, delay);
                    });

                    // Check for duplicate data
                    this.checkForDuplicateData();
                }

                handleDateChange(dateString) {
                    const selectedDate = new Date(dateString);
                    const today = new Date();

                    // Validate date
                    if (selectedDate > today) {
                        this.showToast("Không thể ghi nhận dữ liệu cho ngày tương lai! 📅", "warning");
                        $("#cycle-date").val(today.toISOString().split("T")[0]);
                        return;
                    }

                    // Update state
                    this.state.selectedDate = selectedDate;
                    this.updateWeekSelector();
                    this.checkForDuplicateData();

                    // Show contextual information
                    this.showDateContextInfo(dateString);
                }

                showDateContextInfo(dateString) {
                    const stats = this.calculateCycleStats();
                    const phase = this.getCurrentPhaseForDate(new Date(dateString), stats);

                    if (phase !== "unknown") {
                        const phaseNames = {
                            menstrual: "Kỳ kinh nguyệt",
                            follicular: "Giai đoạn nang trứng",
                            ovulation: "Thời kỳ rụng trứng",
                            luteal: "Giai đoạn hoàng thể",
                        };

                        this.showToast(`${phaseNames[phase]} - Gợi ý ghi nhận phù hợp! 💡`, "info", 3000);
                    }
                }

                checkForDuplicateData() {
                    const dateString = $("#cycle-date").val();
                    const cycleType = $("#cycle-type").val();

                    if (!dateString || !cycleType) return;

                    const existingData = this.data.cycles.find((c) => c.date === dateString && c.type === cycleType);

                    if (existingData) {
                        const typeNames = {
                            "period-start": "bắt đầu kinh nguyệt",
                            "period-end": "kết thúc kinh nguyệt",
                            symptoms: "triệu chứng",
                            ovulation: "rụng trứng",
                            "sexual-activity": "hoạt động tình dục",
                        };

                        this.showDuplicateDataDialog(existingData, typeNames[cycleType]);
                    }
                }

                showDuplicateDataDialog(existingData, typeName) {
                    const confirmed = confirm(`Đã có dữ liệu ${typeName} cho ngày này. Bạn có muốn cập nhật?`);

                    if (confirmed) {
                        this.state.formMode = "edit";
                        this.state.editingId = existingData.id;
                        this.loadExistingDataToForm(existingData);
                        this.showToast("Chế độ cập nhật được kích hoạt! ✏️", "info");
                    } else {
                        $("#cycle-type").val("");
                        this.state.formMode = "add";
                        this.state.editingId = null;
                    }
                }

                loadExistingDataToForm(data) {
                    // Load basic data
                    $("#cycle-date").val(data.date);
                    $("#cycle-type").val(data.type).trigger("change");
                    $("#cycle-note").val(data.note || "");

                    // Load specific data based on type
                    setTimeout(() => {
                        if (data.flow) {
                            $(`.activity-option[data-flow="${data.flow}"]`).addClass("selected");
                        }

                        if (data.symptoms) {
                            data.symptoms.forEach((symptom) => {
                                $(`.symptom-item[data-symptom="${symptom}"]`).addClass("selected");
                            });
                            this.updateSymptomCount();
                        }

                        if (data.moods) {
                            data.moods.forEach((mood) => {
                                $(`.mood-item[data-mood="${mood}"]`).addClass("selected");
                            });
                            this.updateMoodCount();
                        }

                        if (data.activity) {
                            $(`.activity-option[data-activity="${data.activity}"]`).addClass("selected");
                        }
                    }, 200);
                }

                // ===== ENHANCED FORM VALIDATION =====
                setupFormValidation() {
                    // Real-time validation
                    $("#cycle-date, #cycle-type").on("blur change", () => {
                        this.validateFormField();
                    });

                    // Visual feedback for form state
                    $(".form-control")
                        .on("focus", function () {
                            $(this).closest(".form-group").addClass("focused");
                        })
                        .on("blur", function () {
                            $(this).closest(".form-group").removeClass("focused");
                        });
                }

                validateFormField() {
                    const date = $("#cycle-date").val();
                    const type = $("#cycle-type").val();

                    let isValid = true;
                    const errors = [];

                    // Date validation
                    if (!date) {
                        errors.push("Vui lòng chọn ngày");
                        isValid = false;
                    } else if (new Date(date) > new Date()) {
                        errors.push("Không thể chọn ngày tương lai");
                        isValid = false;
                    }

                    // Type validation
                    if (!type) {
                        errors.push("Vui lòng chọn loại hoạt động");
                        isValid = false;
                    }

                    // Update UI based on validation
                    this.updateFormValidationUI(isValid, errors);

                    return isValid;
                }

                updateFormValidationUI(isValid, errors) {
                    const $submitBtn = $('.btn[type="submit"]');

                    if (isValid) {
                        $submitBtn.prop("disabled", false).removeClass("btn-disabled");
                        $(".form-error").hide();
                    } else {
                        $submitBtn.prop("disabled", true).addClass("btn-disabled");

                        if (errors.length > 0) {
                            this.showFormErrors(errors);
                        }
                    }
                }

                showFormErrors(errors) {
                    // Remove existing error messages
                    $(".form-error").remove();

                    // Add new error messages
                    errors.forEach((error) => {
                        const $error = $(`<div class="form-error">${error}</div>`);
                        $(".form-header").after($error);
                    });
                }

                // ===== ENHANCED FORM SUBMISSION =====
                async handleFormSubmission() {
                    // Validate form
                    if (!this.validateFormField()) {
                        this.showToast("Vui lòng kiểm tra lại thông tin! ⚠️", "warning");
                        return;
                    }

                    // Show loading
                    this.showFormLoading();

                    try {
                        const formData = this.collectFormData();
                        const validationResult = this.validateFormData(formData);

                        if (!validationResult.isValid) {
                            throw new Error(validationResult.errors[0]);
                        }

                        // Save data
                        await this.saveFormData(formData);

                        // Success feedback
                        this.hideFormLoading();
                        const message = this.state.formMode === "edit" ? "Đã cập nhật thành công! 💖" : "Đã ghi nhận thành công! 💖";

                        this.showToast(message, "success");

                        // Close form and update UI
                        this.closeQuickAddForm();
                        this.updateAllSections();

                        // Trigger haptic feedback
                        this.triggerHapticFeedback("success");

                        // Check for achievements
                        this.checkAchievements();
                    } catch (error) {
                        this.hideFormLoading();
                        this.showToast(error.message || "Lỗi lưu dữ liệu! Vui lòng thử lại. 😔", "error");
                        console.error("Form submission error:", error);
                    }
                }

                collectFormData() {
                    const formData = {
                        id: this.state.editingId || Date.now() + Math.random(),
                        date: $("#cycle-date").val(),
                        type: $("#cycle-type").val(),
                        note: $("#cycle-note").val().trim(),
                        timestamp: new Date().toISOString(),
                        confidence: 1.0, // User entered data has high confidence
                        tags: [],
                    };

                    // Collect type-specific data
                    switch (formData.type) {
                        case "period-start":
                            formData.flow = $(".activity-option.selected[data-flow]").data("flow") || "medium";
                            break;

                        case "symptoms":
                            formData.symptoms = $(".symptom-item.selected")
                                .map(function () {
                                    return $(this).data("symptom");
                                })
                                .get();

                            formData.moods = $(".mood-item.selected")
                                .map(function () {
                                    return $(this).data("mood");
                                })
                                .get();
                            break;

                        case "sexual-activity":
                            formData.activity = $(".activity-option.selected[data-activity]").data("activity");
                            break;
                    }

                    return formData;
                }

                validateFormData(formData) {
                    const errors = [];

                    // Basic validation
                    if (!formData.date || !formData.type) {
                        errors.push("Vui lòng điền đầy đủ thông tin!");
                    }

                    // Date validation
                    const today = new Date().toISOString().split("T")[0];
                    if (formData.date > today) {
                        errors.push("Không thể ghi nhận dữ liệu cho ngày tương lai!");
                    }

                    // Type-specific validation
                    switch (formData.type) {
                        case "symptoms":
                            if (!formData.symptoms || formData.symptoms.length === 0) {
                                errors.push("Vui lòng chọn ít nhất một triệu chứng!");
                            }
                            break;

                        case "sexual-activity":
                            if (!formData.activity) {
                                errors.push("Vui lòng chọn loại hoạt động!");
                            }
                            break;
                    }

                    return {
                        isValid: errors.length === 0,
                        errors,
                    };
                }

                async saveFormData(formData) {
                    // Remove existing data if editing
                    if (this.state.formMode === "edit" && this.state.editingId) {
                        this.data.cycles = this.data.cycles.filter((c) => c.id !== this.state.editingId);
                    }

                    // Add new data
                    this.data.cycles.push(formData);

                    // Save to storage
                    const saved = this.saveData();
                    if (!saved) {
                        throw new Error("Không thể lưu dữ liệu!");
                    }

                    // Clear cache to force recalculation
                    this.data.cache.lastCalculation = null;

                    // Reset form state
                    this.state.formMode = "add";
                    this.state.editingId = null;

                    // Clear draft
                    this.clearDraft();
                }

                showFormLoading() {
                    const $submitBtn = $('.btn[type="submit"]');
                    $submitBtn.prop("disabled", true).html(`
                    <i class="fas fa-spinner fa-spin"></i>
                    Đang lưu...
                `);
                }

                hideFormLoading() {
                    const $submitBtn = $('.btn[type="submit"]');
                    $submitBtn.prop("disabled", false).html(`
                    <i class="fas fa-save"></i>
                    Lưu
                `);
                }

                // ===== AUTO-SAVE DRAFT FUNCTIONALITY =====
                setupAutoSaveDraft() {
                    const draftFields = ["#cycle-note", "#cycle-type"];

                    draftFields.forEach((selector) => {
                        $(selector).on(
                            "input change",
                            this.debounce(() => {
                                this.saveDraft();
                            }, 1000)
                        );
                    });
                }

                saveDraft() {
                    try {
                        const draft = {
                            date: $("#cycle-date").val(),
                            type: $("#cycle-type").val(),
                            note: $("#cycle-note").val(),
                            selectedSymptoms: $(".symptom-item.selected")
                                .map(function () {
                                    return $(this).data("symptom");
                                })
                                .get(),
                            selectedMoods: $(".mood-item.selected")
                                .map(function () {
                                    return $(this).data("mood");
                                })
                                .get(),
                            timestamp: Date.now(),
                        };

                        localStorage.setItem("cycleDraft", JSON.stringify(draft));
                    } catch (error) {
                        console.warn("Failed to save draft:", error);
                    }
                }

                loadDraft() {
                    try {
                        const draft = localStorage.getItem("cycleDraft");
                        if (!draft) return;

                        const draftData = JSON.parse(draft);

                        // Only load recent drafts (less than 24 hours old)
                        if (Date.now() - draftData.timestamp > 24 * 60 * 60 * 1000) {
                            this.clearDraft();
                            return;
                        }

                        // Load draft data
                        if (draftData.note && draftData.note.trim()) {
                            $("#cycle-note").val(draftData.note);
                            this.showToast("Đã khôi phục bản nháp! ✨", "info");
                        }

                        // Load selected items if any
                        if (draftData.selectedSymptoms) {
                            draftData.selectedSymptoms.forEach((symptom) => {
                                $(`.symptom-item[data-symptom="${symptom}"]`).addClass("selected");
                            });
                        }

                        if (draftData.selectedMoods) {
                            draftData.selectedMoods.forEach((mood) => {
                                $(`.mood-item[data-mood="${mood}"]`).addClass("selected");
                            });
                        }
                    } catch (error) {
                        console.warn("Failed to load draft:", error);
                        this.clearDraft();
                    }
                }

                clearDraft() {
                    localStorage.removeItem("cycleDraft");
                }

                resetForm() {
                    $("#quick-cycle-form")[0].reset();
                    $(".selected").removeClass("selected");
                    $(".hidden").addClass("hidden");
                    $("#show-all-symptoms, #show-all-moods").show();
                    this.state.formMode = "add";
                    this.state.editingId = null;
                }

                // ===== ENHANCED CALENDAR MANAGEMENT =====
                setupEnhancedCalendar() {
                    console.log("📅 Setting up enhanced calendar...");

                    // Initialize calendar state
                    this.calendar = {
                        currentMonth: new Date().getMonth(),
                        currentYear: new Date().getFullYear(),
                        animating: false,
                        touchStartX: 0,
                        touchEndX: 0,
                        swipeThreshold: 80,
                    };

                    // Setup calendar navigation
                    this.setupCalendarNavigation();

                    // Setup calendar interactions
                    this.setupCalendarInteractions();

                    // Setup week selector
                    this.setupWeekSelector();

                    // Setup touch gestures for calendar (if not iOS Shortcuts)
                    if (!isIOSShortcuts()) {
                        this.setupCalendarTouchGestures();
                    }

                    // Initialize calendar view
                    this.updateCalendar();
                }

                setupCalendarNavigation() {
                    $("#prev-month")
                        .off("click")
                        .on("click", () => {
                            if (this.calendar.animating) return;
                            this.navigateMonth(-1);
                        });

                    $("#next-month")
                        .off("click")
                        .on("click", () => {
                            if (this.calendar.animating) return;
                            this.navigateMonth(1);
                        });

                    // Enhanced keyboard navigation
                    $(document)
                        .off("keydown.calendar")
                        .on("keydown.calendar", (e) => {
                            if (e.altKey) {
                                switch (e.key) {
                                    case "ArrowLeft":
                                        e.preventDefault();
                                        this.navigateMonth(-1);
                                        break;
                                    case "ArrowRight":
                                        e.preventDefault();
                                        this.navigateMonth(1);
                                        break;
                                    case "Home":
                                        e.preventDefault();
                                        this.goToCurrentMonth();
                                        break;
                                }
                            }
                        });
                }

                navigateMonth(direction) {
                    if (this.calendar.animating) return;

                    this.calendar.animating = true;

                    // Update month/year
                    this.calendar.currentMonth += direction;
                    if (this.calendar.currentMonth < 0) {
                        this.calendar.currentMonth = 11;
                        this.calendar.currentYear--;
                    } else if (this.calendar.currentMonth > 11) {
                        this.calendar.currentMonth = 0;
                        this.calendar.currentYear++;
                    }

                    // Animate transition (only if animations enabled)
                    if (this.data.preferences.animationsEnabled) {
                        this.animateCalendarTransition(direction);
                    }

                    // Update calendar after animation
                    const delay = this.data.preferences.animationsEnabled ? 300 : 0;
                    setTimeout(() => {
                        this.updateCalendar();
                        this.calendar.animating = false;
                    }, delay);

                    // Show month info
                    const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];

                    this.showToast(`${monthNames[this.calendar.currentMonth]} ${this.calendar.currentYear}`, "info", 2000);

                    // Trigger haptic feedback
                    this.triggerHapticFeedback("light");
                }

                animateCalendarTransition(direction) {
                    const $calendarGrid = $("#calendar-grid");
                    const slideDirection = direction > 0 ? "slideInRight" : "slideInLeft";

                    // Add exit animation
                    $calendarGrid.addClass("calendar-transitioning");

                    // Apply entrance animation after delay
                    setTimeout(() => {
                        $calendarGrid.removeClass("calendar-transitioning").addClass(slideDirection);
                        setTimeout(() => $calendarGrid.removeClass(slideDirection), 300);
                    }, 150);
                }

                goToCurrentMonth() {
                    const now = new Date();
                    this.calendar.currentMonth = now.getMonth();
                    this.calendar.currentYear = now.getFullYear();
                    this.updateCalendar();
                    this.showToast("Đã chuyển về tháng hiện tại! 📅", "info");
                }

                // ===== ENHANCED CALENDAR RENDERING =====
                updateCalendar() {
                    const startTime = performance.now();

                    // Update calendar header
                    this.updateCalendarHeader();

                    // Clear existing calendar days
                    $("#calendar-grid .calendar-day").remove();

                    // Calculate calendar data
                    const calendarData = this.calculateCalendarData();

                    // Render calendar days with animation
                    this.renderCalendarDays(calendarData);

                    // Update progress ring if on current month
                    this.updateProgressRing();

                    this.performance.renderTime = performance.now() - startTime;
                }

                updateCalendarHeader() {
                    const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];

                    $("#calendar-title").text(`${monthNames[this.calendar.currentMonth]} ${this.calendar.currentYear}`);

                    // Update subtitle with cycle info
                    const stats = this.calculateCycleStats();
                    let subtitle = "Xem tổng quan chu kỳ";

                    if (stats.totalCycles > 0) {
                        const isCurrentMonth = this.calendar.currentMonth === new Date().getMonth() && this.calendar.currentYear === new Date().getFullYear();

                        if (isCurrentMonth) {
                            subtitle = `Ngày ${stats.cycleDay} của chu kỳ`;
                        } else {
                            subtitle = `${stats.totalCycles} chu kỳ đã theo dõi`;
                        }
                    }

                    $("#calendar-subtitle").text(subtitle);
                }

                calculateCalendarData() {
                    const firstDay = new Date(this.calendar.currentYear, this.calendar.currentMonth, 1);
                    const lastDay = new Date(this.calendar.currentYear, this.calendar.currentMonth + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay());

                    const stats = this.calculateCycleStats();
                    const today = new Date();
                    const todayString = this.getLocalDateString(today);

                    const calendarData = {
                        startDate,
                        firstDay,
                        lastDay,
                        stats,
                        today,
                        todayString,
                        days: [],
                    };

                    // Generate 42 days (6 weeks)
                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);

                        const dayData = this.calculateDayData(date, calendarData);
                        calendarData.days.push(dayData);
                    }

                    return calendarData;
                }

                calculateDayData(date, calendarData) {
                    const dateString = this.getLocalDateString(date);
                    const dayData = {
                        date,
                        dateString,
                        dayNumber: date.getDate(),
                        isCurrentMonth: date.getMonth() === this.calendar.currentMonth,
                        isToday: dateString === calendarData.todayString,
                        activities: this.data.cycles.filter((c) => c.date === dateString),
                        classes: ["calendar-day"],
                        phase: null,
                        predictions: {},
                    };

                    // Add month class
                    if (!dayData.isCurrentMonth) {
                        dayData.classes.push("other-month");
                    }

                    // Add today class
                    if (dayData.isToday) {
                        dayData.classes.push("today");
                    }

                    // Calculate cycle phase and predictions
                    this.calculateDayPhaseAndPredictions(dayData, calendarData.stats);

                    // Add activity indicators
                    if (dayData.activities.length > 0) {
                        dayData.hasActivities = true;
                    }

                    return dayData;
                }

                calculateDayPhaseAndPredictions(dayData, stats) {
                    if (!stats.nextPeriodDate || stats.confidence < 30) return;

                    const date = dayData.date;

                    // Check for actual period days
                    if (dayData.activities.some((a) => a.type === "period-start")) {
                        dayData.classes.push("period");
                        dayData.phase = "menstrual";
                        return;
                    }

                    // Calculate predictions
                    const ovulationDate = new Date(stats.nextPeriodDate);
                    ovulationDate.setDate(ovulationDate.getDate() - 14);

                    const fertileStart = new Date(ovulationDate);
                    fertileStart.setDate(fertileStart.getDate() - 5);

                    const fertileEnd = new Date(ovulationDate);
                    fertileEnd.setDate(fertileEnd.getDate() + 1);

                    const expectedPeriodEnd = new Date(stats.nextPeriodDate);
                    expectedPeriodEnd.setDate(expectedPeriodEnd.getDate() + stats.averagePeriodLength - 1);

                    // Apply predictions with confidence-based styling
                    if (date >= stats.nextPeriodDate && date <= expectedPeriodEnd) {
                        dayData.classes.push("expected-period");
                        dayData.phase = "expected-menstrual";
                        dayData.predictions.confidence = stats.confidence;
                    } else if (this.getLocalDateString(date) === this.getLocalDateString(ovulationDate)) {
                        dayData.classes.push("ovulation");
                        dayData.phase = "ovulation";
                        dayData.predictions.confidence = Math.max(50, stats.confidence - 10);
                    } else if (date >= fertileStart && date <= fertileEnd) {
                        dayData.classes.push("fertile");
                        dayData.phase = "fertile";
                        dayData.predictions.confidence = Math.max(40, stats.confidence - 20);
                    }

                    // Adjust opacity based on confidence
                    if (dayData.predictions.confidence && dayData.predictions.confidence < 60) {
                        dayData.lowConfidence = true;
                    }
                }

                renderCalendarDays(calendarData) {
                    const fragment = document.createDocumentFragment();

                    calendarData.days.forEach((dayData, index) => {
                        const dayElement = this.createCalendarDayElement(dayData, index);
                        fragment.appendChild(dayElement);
                    });

                    // Add all days at once for better performance
                    $("#calendar-grid")[0].appendChild(fragment);

                    // Animate days appearing (only if animations enabled)
                    if (this.data.preferences.animationsEnabled) {
                        this.animateCalendarDaysAppearance();
                    }
                }

                createCalendarDayElement(dayData, index) {
                    const dayElement = document.createElement("div");
                    dayElement.className = dayData.classes.join(" ");
                    dayElement.textContent = dayData.dayNumber;
                    dayElement.setAttribute("data-date", dayData.dateString);

                    // Add confidence indicator for predictions
                    if (dayData.predictions.confidence) {
                        dayElement.setAttribute("data-confidence", dayData.predictions.confidence);
                        if (dayData.lowConfidence) {
                            dayElement.style.opacity = "0.7";
                        }
                    }

                    // Add phase information for accessibility
                    if (dayData.phase) {
                        const phaseNames = {
                            menstrual: "Ngày kinh nguyệt",
                            "expected-menstrual": "Ngày dự kiến kinh nguyệt",
                            ovulation: "Ngày rụng trứng",
                            fertile: "Thời kỳ dễ thụ thai",
                        };
                        dayElement.setAttribute("aria-label", `${dayData.dayNumber} - ${phaseNames[dayData.phase]}`);
                    }

                    // Add activity indicators
                    if (dayData.hasActivities) {
                        const dot = document.createElement("div");
                        dot.className = "symptoms-dot";

                        // Color code based on activity type
                        const hasSymptoms = dayData.activities.some((a) => a.type === "symptoms");
                        const hasOvulation = dayData.activities.some((a) => a.type === "ovulation");

                        if (hasOvulation) {
                            dot.style.background = "var(--secondary-color)";
                        } else if (hasSymptoms) {
                            dot.style.background = "var(--warning-color)";
                        }

                        dayElement.appendChild(dot);
                    }

                    // Add click handler for current month days
                    if (dayData.isCurrentMonth) {
                        dayElement.style.cursor = "pointer";
                        dayElement.addEventListener("click", () => {
                            this.showDayDetail(dayData.dateString, dayData.date);
                        });

                        // Add hover effect data (only if not iOS Shortcuts)
                        if (!isIOSShortcuts()) {
                            dayElement.addEventListener("mouseenter", () => {
                                this.showDayPreview(dayData);
                            });

                            dayElement.addEventListener("mouseleave", () => {
                                this.hideDayPreview();
                            });
                        }
                    }

                    // Add animation delay for staggered appearance (only if animations enabled)
                    if (this.data.preferences.animationsEnabled) {
                        dayElement.style.animationDelay = `${index * 20}ms`;
                    }

                    return dayElement;
                }

                animateCalendarDaysAppearance() {
                    const $days = $("#calendar-grid .calendar-day");

                    $days.each(function (index) {
                        $(this).addClass("calendar-day-entering");
                        setTimeout(() => {
                            $(this).removeClass("calendar-day-entering");
                        }, 50 + index * 20);
                    });
                }

                // ===== CALENDAR INTERACTIONS =====
                setupCalendarInteractions() {
                    console.log("Calendar interactions initialized");

                    // 1. CLICK HANDLER - Mở chi tiết ngày
                    $(document).on("click", ".calendar-day:not(.other-month)", (e) => {
                        const $day = $(e.currentTarget);
                        const date = $day.data("date");

                        // Hiệu ứng visual khi click (only if animations enabled)
                        if (this.data.preferences.animationsEnabled) {
                            $day.addClass("day-clicked");
                            setTimeout(() => $day.removeClass("day-clicked"), 300);
                        }

                        this.showDayDetail(date);
                    });

                    // 2. HOVER HANDLER - Hiển thị preview ngày (only if not iOS Shortcuts)
                    if (!isIOSShortcuts()) {
                        let hoverTimer;
                        $(document)
                            .on("mouseenter", ".calendar-day:not(.other-month)", (e) => {
                                const $day = $(e.currentTarget);
                                const date = $day.data("date");

                                // Delay để tránh hiển thị quá nhanh
                                hoverTimer = setTimeout(() => {
                                    this.showDayPreview(date);
                                }, 300);
                            })
                            .on("mouseleave", ".calendar-day:not(.other-month)", () => {
                                clearTimeout(hoverTimer);
                                this.hideDayPreview();
                            });
                    }

                    // 3. KEYBOARD NAVIGATION - Điều hướng bằng bàn phím
                    $(document).on("keydown", (e) => {
                        if ($(".day-detail-modal.active").length) return; // Bỏ qua nếu modal đang mở

                        switch (e.key) {
                            case "ArrowLeft":
                                this.navigateMonth(-1);
                                break;
                            case "ArrowRight":
                                this.navigateMonth(1);
                                break;
                            case "Home":
                                this.goToCurrentMonth();
                                break;
                        }
                    });

                    // 4. LONG PRESS DETECTION - Cho mobile (only if not iOS Shortcuts)
                    if (!isIOSShortcuts()) {
                        let pressTimer;
                        $(document)
                            .on("touchstart", ".calendar-day:not(.other-month)", (e) => {
                                pressTimer = setTimeout(() => {
                                    const date = $(e.currentTarget).data("date");
                                    this.showQuickActions(date, e);
                                }, 500);
                            })
                            .on("touchend touchcancel", () => {
                                clearTimeout(pressTimer);
                            });
                    }
                }

                // ===== QUICK ACTIONS MENU =====
                showQuickActions(date, event) {
                    // Hiển thị menu hành động nhanh khi nhấn giữ
                    const $menu = $(`
                    <div class="quick-actions-menu">
                        <button data-action="add-period" class="action-btn">
                            <i class="fas fa-droplet"></i> Kinh nguyệt
                        </button>
                        <button data-action="add-symptoms" class="action-btn">
                            <i class="fas fa-notes-medical"></i> Triệu chứng
                        </button>
                        <button data-action="add-note" class="action-btn">
                            <i class="fas fa-sticky-note"></i> Ghi chú
                        </button>
                    </div>
                `);

                    $("body").append($menu);

                    // Đặt vị trí menu gần ngày được chọn
                    const rect = event.target.getBoundingClientRect();
                    $menu.css({
                        top: `${rect.top}px`,
                        left: `${rect.left}px`,
                    });

                    // Xử lý chọn hành động
                    $menu.find(".action-btn").on("click", (e) => {
                        const action = $(e.currentTarget).data("action");
                        this.handleQuickAction(action, date);
                        $menu.remove();
                    });

                    // Tự động đóng menu khi click ra ngoài
                    setTimeout(() => {
                        $(document).one("click", () => $menu.remove());
                    }, 10);
                }

                // ===== QUICK ACTION HANDLER =====
                handleQuickActionForDate(action, date) {
                    switch (action) {
                        case "add-period":
                            this.addPeriodEntry(date);
                            break;
                        case "add-symptoms":
                            this.addSymptomsEntry(date);
                            break;
                        case "add-note":
                            this.addNoteEntry(date);
                            break;
                    }
                }

                // ===== QUICK PERIOD ENTRY FUNCTION =====
                addPeriodEntry(date) {
                    // Tạo entry kinh nguyệt mặc định
                    const newEntry = {
                        id: Date.now() + Math.random(),
                        date: date,
                        type: "period-start",
                        flow: "medium", // Lưu lượng mặc định: vừa
                        note: "",
                        timestamp: new Date().toISOString(),
                        confidence: 1.0,
                    };

                    // Thêm vào dữ liệu
                    this.data.cycles.push(newEntry);
                    this.saveData();

                    // Cập nhật giao diện
                    this.updateCalendar();
                    this.updateDashboard();

                    // Hiển thị thông báo
                    this.showToast("Đã thêm ngày kinh nguyệt! 🔴", "success");

                    // Mở chi tiết để chỉnh sửa thêm
                    this.openDayDetailWithHighlight(date, newEntry.id);
                }

                // ===== QUICK SYMPTOMS ENTRY FUNCTION =====
                addSymptomsEntry(date) {
                    // Tạo entry triệu chứng mặc định
                    const newEntry = {
                        id: Date.now() + Math.random(),
                        date: date,
                        type: "symptoms",
                        symptoms: ["cramps"], // Triệu chứng mặc định: đau bụng
                        moods: ["neutral"], // Tâm trạng mặc định: bình thường
                        note: "",
                        timestamp: new Date().toISOString(),
                        confidence: 1.0,
                    };

                    // Thêm vào dữ liệu
                    this.data.cycles.push(newEntry);
                    this.saveData();

                    // Cập nhật giao diện
                    this.updateCalendar();
                    this.updateDashboard();

                    // Hiển thị thông báo
                    this.showToast("Đã thêm triệu chứng! 🤕", "success");

                    // Mở chi tiết để chỉnh sửa thêm
                    this.openDayDetailWithHighlight(date, newEntry.id);
                }

                // ===== QUICK NOTE ENTRY FUNCTION =====
                addNoteEntry(date) {
                    // Tạo entry ghi chú mặc định
                    const newEntry = {
                        id: Date.now() + Math.random(),
                        date: date,
                        type: "note",
                        note: "Ghi chú nhanh...",
                        timestamp: new Date().toISOString(),
                        confidence: 1.0,
                    };

                    // Thêm vào dữ liệu
                    this.data.cycles.push(newEntry);
                    this.saveData();

                    // Cập nhật giao diện
                    this.updateCalendar();

                    // Hiển thị thông báo
                    this.showToast("Đã thêm ghi chú! 📝", "success");

                    // Mở chi tiết để chỉnh sửa thêm
                    this.openDayDetailWithHighlight(date, newEntry.id);
                }

                // ===== OPEN DAY DETAIL WITH HIGHLIGHT =====
                openDayDetailWithHighlight(date, entryId) {
                    // Mở chi tiết ngày
                    this.showDayDetail(date);

                    // Highlight entry sau khi modal hiển thị
                    setTimeout(() => {
                        const $entry = $(`#activity-${entryId}`);
                        if ($entry.length) {
                            // Cuộn đến entry và highlight
                            $entry.addClass("highlighted-entry");
                            $entry[0].scrollIntoView({
                                behavior: "smooth",
                                block: "center",
                            });

                            // Tự động bỏ highlight sau 3 giây
                            setTimeout(() => {
                                $entry.removeClass("highlighted-entry");
                            }, 3000);
                        }
                    }, 500);
                }

                // ===== SHOW DAY DETAIL FUNCTION =====
                showDayDetail(date) {
                    // Lưu ngày được chọn vào state
                    this.state.selectedDate = date;

                    // Cập nhật tiêu đề modal
                    $("#day-detail-title").html(`<i class="fas fa-calendar-day"></i> Chi tiết ngày ${this.formatDateDisplay(date)}`);

                    // Tính toán giai đoạn chu kỳ
                    const stats = this.calculateCycleStats();
                    const phase = this.getPhaseForDate(new Date(date), stats);
                    const phaseName = this.getPhaseName(phase);
                    $("#day-detail-phase").text(phaseName);

                    // Hiển thị modal
                    $("#day-detail-modal").addClass("active");

                    // Cập nhật nội dung modal dựa trên ngày được chọn
                    this.updateDayDetailContent(date);

                    // Cuộn lên đầu modal
                    $(".day-detail-content").scrollTop(0);
                }

                // ===== GET PHASE FOR DATE =====
                getPhaseForDate(date, stats) {
                    if (!stats.lastPeriodDate) return "unknown";

                    const lastPeriod = new Date(stats.lastPeriodDate);
                    const daysSince = Math.floor((date - lastPeriod) / (1000 * 60 * 60 * 24));

                    if (daysSince <= this.data.settings.averagePeriodLength) {
                        return "menstrual";
                    } else if (daysSince <= Math.floor(stats.averageCycleLength * 0.5)) {
                        return "follicular";
                    } else if (daysSince <= Math.floor(stats.averageCycleLength * 0.6)) {
                        return "ovulation";
                    } else {
                        return "luteal";
                    }
                }

                // ===== GET PHASE NAME =====
                getPhaseName(phase) {
                    const phases = {
                        menstrual: "Kỳ kinh nguyệt",
                        follicular: "Giai đoạn nang trứng",
                        ovulation: "Thời kỳ rụng trứng",
                        luteal: "Giai đoạn hoàng thể",
                        unknown: "Chưa xác định",
                    };
                    return phases[phase] || "Chưa xác định";
                }

                // ===== UPDATE DAY DETAIL CONTENT =====
                updateDayDetailContent(date) {
                    // Lấy dữ liệu cho ngày cụ thể
                    const dayData = this.getDayData(date);

                    // Hiển thị các hoạt động
                    this.renderDayActivities(dayData.activities);

                    // Hiển thị trạng thái trống nếu không có hoạt động
                    if (dayData.activities.length === 0) {
                        $("#empty-day-state").show();
                    } else {
                        $("#empty-day-state").hide();
                    }
                }

                // ===== GET DAY DATA =====
                getDayData(date) {
                    // Lấy tất cả hoạt động cho ngày này
                    const activities = this.data.cycles.filter((activity) => activity.date === date);

                    // Tính toán giai đoạn chu kỳ
                    const stats = this.calculateCycleStats();
                    const phase = this.getPhaseForDate(new Date(date), stats);

                    return {
                        date: date,
                        activities: activities,
                        phase: phase,
                    };
                }

                // ===== RENDER DAY ACTIVITIES =====
                renderDayActivities(activities) {
                    const $container = $("#day-activities-list");
                    $container.empty();

                    if (activities.length === 0) {
                        $("#empty-day-state").show();
                        return;
                    }

                    $("#empty-day-state").hide();

                    activities.forEach((activity) => {
                        const activityHtml = this.generateActivityHtml(activity);
                        $container.append(activityHtml);
                    });

                    // Thêm sự kiện chỉnh sửa
                    $(".edit-activity-btn")
                        .off("click")
                        .on("click", (e) => {
                            const id = $(e.currentTarget).data("id");
                            this.editActivity(id);
                        });

                    // Thêm sự kiện xóa
                    $(".delete-activity-btn")
                        .off("click")
                        .on("click", (e) => {
                            const id = $(e.currentTarget).data("id");
                            this.deleteActivity(id);
                        });
                }

                // ===== GENERATE ACTIVITY HTML =====
                generateActivityHtml(activity) {
                    // Tạo HTML cho một hoạt động
                    return `
                    <div class="day-activity" id="activity-${activity.id}">
                        <div class="activity-icon">${this.getActivityIcon(activity.type)}</div>
                        <div class="activity-details">
                            <div class="activity-type">${this.getActivityTypeName(activity.type)}</div>
                            <div class="activity-time">${this.formatTime(activity.timestamp)}</div>
                            
                            ${activity.type === "period-start" && activity.flow
                            ? `
                                <div class="activity-flow">
                                    Lưu lượng: ${this.getFlowName(activity.flow)}
                                </div>
                            `
                            : ""
                        }
                            
                            ${activity.symptoms && activity.symptoms.length > 0
                            ? `
                                <div class="activity-symptoms">
                                    Triệu chứng: ${activity.symptoms.map((s) => this.getSymptomName(s)).join(", ")}
                                </div>
                            `
                            : ""
                        }
                            
                            ${activity.moods && activity.moods.length > 0
                            ? `
                                <div class="activity-moods">
                                    Tâm trạng: ${activity.moods.map((m) => this.getMoodName(m)).join(", ")}
                                </div>
                            `
                            : ""
                        }
                            
                            ${activity.note
                            ? `
                                <div class="activity-note">
                                    <i class="fas fa-comment"></i> ${activity.note}
                                </div>
                            `
                            : ""
                        }
                        </div>
                        
                        <div class="activity-actions">
                            <button class="edit-activity-btn" data-id="${activity.id}" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-activity-btn" data-id="${activity.id}" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                }

                // ===== EDIT ACTIVITY =====
                editActivity(id) {
                    // Tìm activity
                    const activity = this.data.cycles.find((a) => a.id === id);
                    if (!activity) return;

                    // Đóng modal chi tiết
                    $("#day-detail-modal").removeClass("active");

                    // Mở form chỉnh sửa
                    this.openEditForm(activity);
                }

                // ===== OPEN EDIT FORM =====
                openEditForm(activity) {
                    // Mở form nhanh
                    this.openQuickAddForm();

                    // Chọn ngày
                    $("#cycle-date").val(activity.date);
                    this.state.selectedDate = activity.date;

                    // Cập nhật form theo activity
                    setTimeout(() => {
                        // Chọn loại hoạt động
                        $("#cycle-type").val(activity.type).trigger("change");

                        // Điền các trường dữ liệu tương ứng
                        switch (activity.type) {
                            case "period-start":
                                if (activity.flow) {
                                    $(`.activity-option[data-flow="${activity.flow}"]`).addClass("selected");
                                }
                                break;

                            case "symptoms":
                                if (activity.symptoms) {
                                    activity.symptoms.forEach((symptom) => {
                                        $(`.symptom-item[data-symptom="${symptom}"]`).addClass("selected");
                                    });
                                }
                                if (activity.moods) {
                                    activity.moods.forEach((mood) => {
                                        $(`.mood-item[data-mood="${mood}"]`).addClass("selected");
                                    });
                                }
                                break;

                            case "sexual-activity":
                                if (activity.activity) {
                                    $(`.activity-option[data-activity="${activity.activity}"]`).addClass("selected");
                                }
                                break;

                            case "note":
                                // No additional fields
                                break;
                        }

                        // Điền ghi chú nếu có
                        if (activity.note) {
                            $("#cycle-note").val(activity.note);
                        }

                        // Chuyển sang chế độ chỉnh sửa
                        this.state.formMode = "edit";
                        this.state.editingId = activity.id;
                    }, 300);
                }

                // ===== DELETE ACTIVITY =====
                deleteActivity(id) {
                    if (!confirm("Bạn có chắc muốn xóa hoạt động này?")) return;

                    // Xóa khỏi dữ liệu
                    this.data.cycles = this.data.cycles.filter((a) => a.id !== id);
                    this.saveData();

                    // Cập nhật giao diện
                    this.updateCalendar();
                    this.updateDashboard();

                    // Hiển thị thông báo
                    this.showToast("Đã xóa hoạt động! 🗑️", "success");

                    // Cập nhật lại nội dung modal
                    this.updateDayDetailContent(this.state.selectedDate);
                }

                // ===== CLOSE DAY DETAIL MODAL =====
                closeDayDetailModal() {
                    $("#day-detail-modal").removeClass("active");
                }

                // ===== ENHANCED WEEK SELECTOR =====
                setupWeekSelector() {
                    // Initialize week selector state
                    this.weekSelector = {
                        selectedDate: new Date(),
                        touchStartX: 0,
                        touchEndX: 0,
                    };
                }

                updateWeekSelector() {
                    const weekSelector = $("#week-selector");
                    weekSelector.empty();

                    const inputDate = $("#cycle-date").val();
                    let currentDate;

                    if (inputDate) {
                        currentDate = this.createLocalDate(inputDate);
                    } else {
                        currentDate = new Date();
                        $("#cycle-date").val(this.getLocalDateString(currentDate));
                    }

                    this.weekSelector.selectedDate = currentDate;

                    // Calculate week start (Sunday)
                    const startOfWeek = new Date(currentDate);
                    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

                    const weekDays = ["CN", "T2", "T3", "T4", "T5", "T6", "T7"];
                    const today = new Date();
                    const fragment = document.createDocumentFragment();

                    for (let i = 0; i < 7; i++) {
                        const day = new Date(startOfWeek);
                        day.setDate(startOfWeek.getDate() + i);

                        const dayElement = this.createWeekDayElement(day, weekDays[i], currentDate, today, i);
                        fragment.appendChild(dayElement);
                    }

                    weekSelector[0].appendChild(fragment);

                    // Add swipe gestures to week selector (only if not iOS Shortcuts)
                    if (!isIOSShortcuts()) {
                        this.setupWeekSelectorGestures();
                    }
                }

                createWeekDayElement(day, dayLabel, selectedDate, today, index) {
                    const dayString = this.getLocalDateString(day);
                    const selectedString = this.getLocalDateString(selectedDate);
                    const todayString = this.getLocalDateString(today);

                    const isSelected = dayString === selectedString;
                    const isToday = dayString === todayString;
                    const isFuture = day > today;

                    const weekDay = document.createElement("div");
                    weekDay.className = `week-day ${isSelected ? "selected" : ""} ${isFuture ? "future" : ""}`;
                    weekDay.setAttribute("data-date", dayString);

                    if (isFuture) {
                        weekDay.setAttribute("title", "Không thể chọn ngày tương lai");
                    }

                    // Add day content with enhanced styling
                    weekDay.innerHTML = `
                    <div class="week-day-label">${dayLabel}</div>
                    <div class="week-day-number ${isToday ? "today-number" : ""}">${day.getDate()}</div>
                    ${isToday ? '<div class="today-indicator">Hôm nay</div>' : ""}
                `;

                    // Add click handler for non-future days
                    if (!isFuture) {
                        weekDay.addEventListener("click", () => {
                            this.selectWeekDay(dayString);
                        });

                        // Add hover effects (only if not iOS Shortcuts)
                        if (!isIOSShortcuts()) {
                            weekDay.addEventListener("mouseenter", () => {
                                if (!isSelected) {
                                    weekDay.classList.add("week-day-hover");
                                }
                            });

                            weekDay.addEventListener("mouseleave", () => {
                                weekDay.classList.remove("week-day-hover");
                            });
                        }
                    }

                    // Add animation delay (only if animations enabled)
                    if (this.data.preferences.animationsEnabled) {
                        weekDay.style.animationDelay = `${index * 50}ms`;
                        weekDay.classList.add("week-day-entering");
                        setTimeout(() => weekDay.classList.remove("week-day-entering"), 100 + index * 50);
                    }

                    return weekDay;
                }

                selectWeekDay(dateString) {
                    // Update form date
                    $("#cycle-date").val(dateString);

                    // Update week selector
                    this.updateWeekSelector();

                    // Check for duplicate data
                    this.checkForDuplicateData();

                    // Show contextual info
                    this.showDateContextInfo(dateString);

                    // Trigger haptic feedback
                    this.triggerHapticFeedback("light");
                }

                setupWeekSelectorGestures() {
                    const weekSelector = $("#week-selector")[0];

                    weekSelector.addEventListener(
                        "touchstart",
                        (e) => {
                            this.weekSelector.touchStartX = e.touches[0].clientX;
                        },
                        {
                            passive: true,
                        }
                    );

                    weekSelector.addEventListener(
                        "touchend",
                        (e) => {
                            this.weekSelector.touchEndX = e.changedTouches[0].clientX;
                            this.handleWeekSelectorSwipe();
                        },
                        {
                            passive: true,
                        }
                    );
                }

                handleWeekSelectorSwipe() {
                    const swipeThreshold = 50;
                    const diff = this.weekSelector.touchStartX - this.weekSelector.touchEndX;

                    if (Math.abs(diff) > swipeThreshold) {
                        const direction = diff > 0 ? 1 : -1; // 1 for next week, -1 for previous week
                        this.navigateWeek(direction);
                    }
                }

                navigateWeek(direction) {
                    const currentDate = this.weekSelector.selectedDate;
                    const newDate = new Date(currentDate);
                    newDate.setDate(currentDate.getDate() + direction * 7);

                    // Don't allow future dates
                    const today = new Date();
                    if (newDate > today) {
                        this.showToast("Không thể chọn tuần tương lai! 📅", "warning");
                        return;
                    }

                    // Update selected date
                    const newDateString = this.getLocalDateString(newDate);
                    $("#cycle-date").val(newDateString);
                    this.updateWeekSelector();

                    // Show feedback
                    const weekDirection = direction > 0 ? "tiếp theo" : "trước";
                    this.showToast(`Đã chuyển sang tuần ${weekDirection}`, "info", 2000);
                }

                // ===== PROGRESS RING ANIMATION =====
                updateProgressRing() {
                    const stats = this.calculateCycleStats();
                    const progressRing = document.querySelector(".progress-ring-circle");

                    if (!progressRing || !stats.nextPeriodDate) return;

                    // Calculate progress
                    const today = new Date();
                    const lastPeriod = stats.lastPeriodDate || today;
                    const nextPeriod = stats.nextPeriodDate;

                    const totalDays = Math.floor((nextPeriod - lastPeriod) / (1000 * 60 * 60 * 24));
                    const daysPassed = Math.floor((today - lastPeriod) / (1000 * 60 * 60 * 24));

                    const progress = Math.min(daysPassed / totalDays, 1);
                    const circumference = 2 * Math.PI * 90; // radius = 90
                    const strokeDashoffset = circumference - progress * circumference;

                    // Animate the progress ring
                    progressRing.style.strokeDashoffset = strokeDashoffset;

                    // Add glow effect based on phase
                    const currentPhase = stats.currentPhase;
                    const phaseColors = {
                        menstrual: "#e91e63",
                        follicular: "#10b981",
                        ovulation: "#9c27b0",
                        luteal: "#f59e0b",
                    };

                    if (phaseColors[currentPhase]) {
                        progressRing.style.stroke = phaseColors[currentPhase];
                        progressRing.style.filter = `drop-shadow(0 0 6px ${phaseColors[currentPhase]}80)`;
                    }
                }

                // ===== CALENDAR TOUCH GESTURES =====
                setupCalendarTouchGestures() {
                    const calendarSection = $(".calendar-section")[0];

                    calendarSection.addEventListener(
                        "touchstart",
                        (e) => {
                            this.calendar.touchStartX = e.touches[0].clientX;
                        },
                        {
                            passive: true,
                        }
                    );

                    calendarSection.addEventListener(
                        "touchend",
                        (e) => {
                            this.calendar.touchEndX = e.changedTouches[0].clientX;
                            this.handleCalendarSwipe();
                        },
                        {
                            passive: true,
                        }
                    );
                }

                handleCalendarSwipe() {
                    const diffX = this.calendar.touchStartX - this.calendar.touchEndX;

                    if (Math.abs(diffX) > this.calendar.swipeThreshold) {
                        const direction = diffX > 0 ? 1 : -1;
                        this.navigateMonth(direction);
                    }
                }

                // ===== DAY PREVIEW FUNCTIONALITY =====
                showDayPreview(dayData) {
                    // Remove existing preview
                    this.hideDayPreview();

                    if (!dayData.hasActivities && !dayData.phase) return;

                    const preview = document.createElement("div");
                    preview.className = "day-preview-tooltip";
                    preview.innerHTML = this.generateDayPreviewContent(dayData);

                    document.body.appendChild(preview);

                    // Position tooltip
                    setTimeout(() => {
                        this.positionDayPreview(preview, dayData.dateString);
                    }, 10);
                }

                generateDayPreviewContent(dayData) {
                    let content = `<div class="preview-date">${dayData.date.toLocaleDateString("vi-VN")}</div>`;

                    // Add phase information
                    if (dayData.phase) {
                        const phaseNames = {
                            menstrual: "Kỳ kinh nguyệt",
                            "expected-menstrual": "Dự kiến kinh nguyệt",
                            ovulation: "Rụng trứng",
                            fertile: "Dễ thụ thai",
                        };

                        content += `<div class="preview-phase">${phaseNames[dayData.phase]}</div>`;

                        if (dayData.predictions.confidence) {
                            content += `<div class="preview-confidence">Độ tin cậy: ${dayData.predictions.confidence}%</div>`;
                        }
                    }

                    // Add activities
                    if (dayData.hasActivities) {
                        content += '<div class="preview-activities">';
                        dayData.activities.forEach((activity) => {
                            const typeNames = {
                                "period-start": "🔴 Bắt đầu kinh",
                                symptoms: "📝 Triệu chứng",
                                ovulation: "🥚 Rụng trứng",
                                "sexual-activity": "💕 Hoạt động",
                            };
                            content += `<div class="preview-activity">${typeNames[activity.type] || activity.type}</div>`;
                        });
                        content += "</div>";
                    }

                    return content;
                }

                positionDayPreview(preview, dateString) {
                    const dayElement = $(`.calendar-day[data-date="${dateString}"]`)[0];
                    if (!dayElement) return;

                    const dayRect = dayElement.getBoundingClientRect();
                    const previewRect = preview.getBoundingClientRect();

                    let left = dayRect.left + dayRect.width / 2 - previewRect.width / 2;
                    let top = dayRect.top - previewRect.height - 10;

                    // Adjust if tooltip goes off screen
                    if (left < 10) left = 10;
                    if (left + previewRect.width > window.innerWidth - 10) {
                        left = window.innerWidth - previewRect.width - 10;
                    }

                    if (top < 10) {
                        top = dayRect.bottom + 10;
                        preview.classList.add("tooltip-below");
                    }

                    preview.style.left = `${left}px`;
                    preview.style.top = `${top}px`;
                    preview.classList.add("tooltip-visible");
                }

                hideDayPreview() {
                    const existingPreview = document.querySelector(".day-preview-tooltip");
                    if (existingPreview) {
                        existingPreview.remove();
                    }
                }

                // ===== ENHANCED DASHBOARD MANAGEMENT =====
                updateDashboard() {
                    const startTime = performance.now();

                    // Calculate cycle statistics
                    const stats = this.calculateCycleStats();

                    // Update countdown display
                    this.updateCountdownDisplay(stats);

                    // Update header statistics
                    this.updateHeaderStats(stats);

                    // Update daily insights
                    this.updateDailyInsights(stats);

                    // Update progress indicators
                    this.updateProgressIndicators(stats);

                    // Update cycle phase display
                    this.updatePhaseDisplay(stats);

                    this.performance.dashboardRenderTime = performance.now() - startTime;
                }

                updateCountdownDisplay(stats) {
                    const $countdownDays = $("#countdown-days");
                    const $countdownText = $("#countdown-text");
                    const $countdownPhase = $("#countdown-phase");

                    if (stats.nextPeriodDate && stats.totalCycles > 0) {
                        const today = new Date();
                        const daysUntil = Math.ceil((stats.nextPeriodDate - today) / (1000 * 60 * 60 * 24));

                        // Enhanced countdown display with animations (only if animations enabled)
                        if (this.data.preferences.animationsEnabled) {
                            this.animateCountdownChange($countdownDays, daysUntil);
                        } else {
                            $countdownDays.text(daysUntil);
                        }

                        if (daysUntil > 0) {
                            $countdownText.html("ngày đến<br>chu kỳ tiếp theo");
                            $countdownDays.removeClass("pulse warning");

                            // Add warning for irregular cycles
                            if (!stats.isRegular && stats.confidence < 70) {
                                $countdownDays.addClass("warning");
                                $countdownText.append("<br><small>(ước tính)</small>");
                            }
                        } else if (daysUntil === 0) {
                            $countdownDays.text("0");
                            $countdownText.html("chu kỳ<br>hôm nay!");
                            $countdownDays.addClass("pulse");

                            // Trigger notification
                            this.triggerPeriodNotification();
                        } else {
                            const daysLate = Math.abs(daysUntil);
                            $countdownDays.text(daysLate);
                            $countdownText.html(`ngày<br>trễ hạn`);
                            $countdownDays.addClass("pulse warning");

                            // Show late period message
                            if (daysLate >= 7) {
                                this.showLatePeriodAlert(daysLate);
                            }
                        }

                        // Update confidence indicator
                        this.updateConfidenceIndicator(stats.confidence);
                    } else {
                        $countdownDays.text("-");
                        $countdownText.html("chưa có<br>dữ liệu");
                        $countdownDays.removeClass("pulse warning");
                    }

                    // Update phase display
                    this.updateCountdownPhase(stats, $countdownPhase);
                }

                animateCountdownChange($element, newValue) {
                    const currentValue = parseInt($element.text()) || 0;

                    if (currentValue !== newValue) {
                        // Add flip animation
                        $element.addClass("countdown-changing");

                        setTimeout(() => {
                            $element.text(newValue);
                            setTimeout(() => {
                                $element.removeClass("countdown-changing");
                            }, 150);
                        }, 150);
                    }
                }

                updateCountdownPhase(stats, $phaseElement) {
                    const phaseData = {
                        menstrual: {
                            name: "Kỳ kinh nguyệt",
                            icon: "🔴",
                            color: "#e91e63",
                        },
                        follicular: {
                            name: "Giai đoạn nang trứng",
                            icon: "🌱",
                            color: "#10b981",
                        },
                        ovulation: {
                            name: "Thời kỳ rụng trứng",
                            icon: "🥚",
                            color: "#9c27b0",
                        },
                        luteal: {
                            name: "Giai đoạn hoàng thể",
                            icon: "🌙",
                            color: "#f59e0b",
                        },
                        unknown: {
                            name: "Đang tính toán...",
                            icon: "❓",
                            color: "#6b7280",
                        },
                    };

                    const phase = phaseData[stats.currentPhase] || phaseData.unknown;

                    $phaseElement.text(`${phase.icon} ${phase.name}`);
                    $phaseElement.css("border-color", phase.color);

                    // Add phase-specific styling
                    $phaseElement.removeClass("phase-menstrual phase-follicular phase-ovulation phase-luteal");
                    $phaseElement.addClass(`phase-${stats.currentPhase}`);
                }

                updateConfidenceIndicator(confidence) {
                    const $countdown = $(".countdown-circle");

                    // Remove existing confidence classes
                    $countdown.removeClass("confidence-low confidence-medium confidence-high");

                    // Add confidence class
                    if (confidence >= 80) {
                        $countdown.addClass("confidence-high");
                    } else if (confidence >= 50) {
                        $countdown.addClass("confidence-medium");
                    } else {
                        $countdown.addClass("confidence-low");
                    }

                    // Update tooltip
                    $countdown.attr("title", `Độ tin cậy: ${confidence}%`);
                }

                updateHeaderStats(stats) {
                    // Update cycle day
                    $("#header-cycle-day").text(stats.cycleDay || "-");

                    // Update days to next period
                    if (stats.nextPeriodDate) {
                        const today = new Date();
                        const daysUntil = Math.ceil((stats.nextPeriodDate - today) / (1000 * 60 * 60 * 24));
                        $("#header-next-period").text(daysUntil > 0 ? daysUntil : "0");
                    } else {
                        $("#header-next-period").text("-");
                    }

                    // Add animation for changes (only if animations enabled)
                    if (this.data.preferences.animationsEnabled) {
                        $(".header-stat-item").addClass("stat-updating");
                        setTimeout(() => {
                            $(".header-stat-item").removeClass("stat-updating");
                        }, 300);
                    }
                }

                updateDailyInsights(stats) {
                    const insight = this.ai.getDailyInsight();
                    const $insightText = $("#daily-insight");

                    if (insight && insight.message) {
                        // Animate text change (only if animations enabled)
                        if (this.data.preferences.animationsEnabled) {
                            $insightText.fadeOut(200, () => {
                                $insightText.html(insight.message).fadeIn(200);
                            });
                        } else {
                            $insightText.html(insight.message);
                        }

                        // Update insight icon based on type
                        const $insightIcon = $(".insight-icon");
                        const iconMap = {
                            symptom_pattern: "📊",
                            mood_pattern: "😊",
                            irregularity_warning: "⚠️",
                            general_health: "💚",
                            encouragement: "🌟",
                        };

                        $insightIcon.text(iconMap[insight.type] || "📊");

                        // Add priority styling
                        const $insightCard = $(".insight-card");
                        $insightCard.removeClass("priority-high priority-medium priority-low");
                        $insightCard.addClass(`priority-${insight.priority}`);
                    } else {
                        $insightText.text("Hãy tiếp tục ghi nhận để nhận được thông tin chi tiết hơn! 📝");
                    }
                }

                updateProgressIndicators(stats) {
                    // Update cycle progress
                    if (stats.nextPeriodDate && stats.lastPeriodDate) {
                        const today = new Date();
                        const totalDays = Math.floor((stats.nextPeriodDate - stats.lastPeriodDate) / (1000 * 60 * 60 * 24));
                        const daysPassed = Math.floor((today - stats.lastPeriodDate) / (1000 * 60 * 60 * 24));

                        const progress = Math.min(daysPassed / totalDays, 1) * 100;

                        // Update progress ring
                        this.updateProgressRing();

                        // Update any progress bars
                        $(".cycle-progress-bar .progress-fill").css("width", `${progress}%`);
                    }
                }

                updatePhaseDisplay(stats) {
                    // Update phase-specific recommendations
                    const recommendations = this.getPhaseRecommendations(stats.currentPhase);
                    this.updatePhaseRecommendations(recommendations);

                    // Update phase timeline
                    this.updatePhaseTimeline(stats);
                }

                getPhaseRecommendations(phase) {
                    const recommendations = {
                        menstrual: ["🌡️ Chườm ấm có thể giảm đau bụng", "💧 Uống nhiều nước để bù đắp mất nước", "😴 Nghỉ ngơi đầy đủ và tránh căng thẳng", "🍫 Hạn chế đồ ngọt và caffeine"],
                        follicular: ["🏃‍♀️ Đây là thời điểm tốt để tập thể dục", "🥗 Bổ sung thực phẩm giàu protein", "📚 Tập trung học tập và làm việc hiệu quả", "🌟 Năng lượng cao, hãy tận dụng!"],
                        ovulation: ["💕 Thời kỳ dễ thụ thai cao nhất", "🌡️ Theo dõi nhiệt độ cơ thể", "💧 Chú ý đến chất nhầy cổ tử cung", "❤️ Thời điểm tốt cho các hoạt động xã hội"],
                        luteal: ["🧘‍♀️ Thực hành thiền để giảm căng thẳng", "🥜 Bổ sung magie và vitamin B6", "😴 Ưu tiên giấc ngủ chất lượng", "🍃 Tránh căng thẳng và áp lực"],
                    };

                    return recommendations[phase] || ["💚 Hãy lắng nghe cơ thể và chăm sóc bản thân"];
                }

                updatePhaseRecommendations(recommendations) {
                    // Implementation for phase recommendations display
                    // This could be shown in a expandable section or tooltip
                }

                updatePhaseTimeline(stats) {
                    // Implementation for phase timeline visualization
                    // This could show the current position in the cycle
                }

                // ===== ENHANCED STATISTICS MANAGEMENT =====
                updateStats() {
                    const startTime = performance.now();

                    this.showSectionLoading("stats");

                    // Calculate comprehensive statistics
                    const stats = this.calculateCycleStats();
                    const detailedStats = this.calculateDetailedStats();

                    // Update stat cards with animation
                    this.updateStatCards(stats, detailedStats);

                    // Update charts
                    this.updateAllCharts();

                    // Update trends analysis
                    this.updateTrendsAnalysis(stats);

                    // Update health score
                    this.updateHealthScore(stats);

                    this.hideSectionLoading();
                    this.performance.statsRenderTime = performance.now() - startTime;
                }

                calculateDetailedStats() {
                    const cycles = this.data.cycles;
                    const periodStarts = cycles.filter((c) => c.type === "period-start").sort((a, b) => new Date(a.date) - new Date(b.date));

                    const symptomsData = cycles.filter((c) => c.type === "symptoms");
                    const moodsData = cycles.filter((c) => c.moods && c.moods.length > 0);

                    return {
                        // Cycle analysis
                        shortestCycle: periodStarts.length > 1 ? this.getShortestCycle(periodStarts) : null,
                        longestCycle: periodStarts.length > 1 ? this.getLongestCycle(periodStarts) : null,
                        cycleVariability: this.calculateCycleVariability(periodStarts),

                        // Symptoms analysis
                        totalSymptoms: symptomsData.reduce((sum, entry) => sum + (entry.symptoms?.length || 0), 0),
                        mostCommonSymptom: this.getMostCommonSymptom(symptomsData),
                        symptomFrequency: this.calculateSymptomFrequency(symptomsData),

                        // Mood analysis
                        moodPatterns: this.analyzeMoodPatterns(moodsData),
                        moodStability: this.calculateMoodStability(moodsData),

                        // Tracking consistency
                        trackingStreak: this.calculateTrackingStreak(),
                        dataCompleteness: this.calculateDataCompleteness(),

                        // Health indicators
                        irregularityScore: this.calculateIrregularityScore(periodStarts),
                        wellnessScore: this.calculateWellnessScore(cycles),
                    };
                }

                analyzeMoodPatterns(moodsData) {
                    const moodsByPhase = {
                        menstrual: {},
                        follicular: {},
                        ovulation: {},
                        luteal: {},
                    };

                    const moodNames = {
                        happy: "Vui vẻ",
                        sad: "Buồn bã",
                        angry: "Tức giận",
                        anxious: "Lo lắng",
                        excited: "Phấn khích",
                        calm: "Bình tĩnh",
                        tired: "Mệt mỏi",
                        neutral: "Bình thường",
                    };

                    moodsData.forEach((cycle) => {
                        if (cycle.moods && cycle.moods.length > 0) {
                            const phase = this.determinePhaseForDate(cycle.date) || "unknown";
                            if (moodsByPhase[phase]) {
                                cycle.moods.forEach((mood) => {
                                    moodsByPhase[phase][mood] = (moodsByPhase[phase][mood] || 0) + 1;
                                });
                            }
                        }
                    });

                    // Tìm tâm trạng chủ đạo cho từng giai đoạn
                    const phaseAnalysis = {};
                    Object.keys(moodsByPhase).forEach((phase) => {
                        const phaseMoods = moodsByPhase[phase];
                        const dominantMood = Object.keys(phaseMoods).reduce((a, b) => (phaseMoods[a] > phaseMoods[b] ? a : b), null);

                        phaseAnalysis[phase] = {
                            dominant: dominantMood ? moodNames[dominantMood] : null,
                            count: dominantMood ? phaseMoods[dominantMood] : 0,
                            total: Object.values(phaseMoods).reduce((sum, count) => sum + count, 0),
                        };
                    });

                    return {
                        byPhase: moodsByPhase,
                        analysis: phaseAnalysis,
                    };
                }

                calculateMoodStability(moodsData) {
                    if (moodsData.length < 2) return 0;

                    // Tính điểm cho từng tâm trạng
                    const moodScores = {
                        happy: 5,
                        excited: 4,
                        calm: 4,
                        neutral: 3,
                        tired: 2,
                        anxious: 1,
                        sad: 1,
                        angry: 0,
                    };

                    const scores = moodsData.map((cycle) => {
                        if (!cycle.moods || cycle.moods.length === 0) return 3; // neutral

                        const avgScore = cycle.moods.reduce((sum, mood) => sum + (moodScores[mood] || 3), 0) / cycle.moods.length;
                        return avgScore;
                    });

                    // Tính độ lệch chuẩn
                    const mean = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                    const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
                    const stability = Math.max(0, 100 - Math.sqrt(variance) * 20);

                    return Math.round(stability);
                }

                determinePhaseForDate(dateString) {
                    const stats = this.calculateCycleStats();
                    if (!stats.lastPeriodDate) return "unknown";

                    const targetDate = new Date(dateString);
                    const lastPeriod = new Date(stats.lastPeriodDate);
                    const daysSince = Math.floor((targetDate - lastPeriod) / (1000 * 60 * 60 * 24));

                    if (daysSince <= this.data.settings.averagePeriodLength) {
                        return "menstrual";
                    } else if (daysSince <= Math.floor(stats.averageCycleLength * 0.5)) {
                        return "follicular";
                    } else if (daysSince <= Math.floor(stats.averageCycleLength * 0.6)) {
                        return "ovulation";
                    } else {
                        return "luteal";
                    }
                }

                calculateIrregularityScore(periodStarts) {
                    if (periodStarts.length < 2) return 0;

                    const cycleLengths = [];
                    for (let i = 1; i < periodStarts.length; i++) {
                        const diff = Math.floor((new Date(periodStarts[i].date) - new Date(periodStarts[i - 1].date)) / (1000 * 60 * 60 * 24));
                        if (diff > 0 && diff <= 45) {
                            cycleLengths.push(diff);
                        }
                    }

                    if (cycleLengths.length === 0) return 0;

                    // Tính độ lệch chuẩn
                    const mean = cycleLengths.reduce((a, b) => a + b, 0) / cycleLengths.length;
                    const variance = cycleLengths.reduce((sum, length) => sum + Math.pow(length - mean, 2), 0) / cycleLengths.length;
                    const stdDev = Math.sqrt(variance);

                    // Chuyển đổi thành điểm (0-100, 100 là không đều đặn nhất)
                    return Math.min(100, Math.round(stdDev * 10));
                }

                calculateWellnessScore(cycles) {
                    let score = 50; // Điểm cơ bản

                    // Điểm cho tần suất ghi nhận
                    const trackingConsistency = this.calculateTrackingStreak();
                    score += Math.min(20, trackingConsistency / 5);

                    // Điểm cho triệu chứng
                    const symptomEntries = cycles.filter((c) => c.type === "symptoms").length;
                    const totalCycles = cycles.filter((c) => c.type === "period-start").length;

                    if (totalCycles > 0) {
                        const symptomRatio = symptomEntries / totalCycles;
                        if (symptomRatio > 0.8) score += 10;
                        // Ghi nhận triệu chứng đầy đủ
                        else if (symptomRatio > 0.5) score += 5;
                    }

                    // Trừ điểm cho triệu chứng nghiêm trọng
                    const severeSymptomsCount = cycles.filter((c) => c.symptoms && (c.symptoms.includes("severe-pain") || c.symptoms.includes("heavy-bleeding"))).length;

                    if (severeSymptomsCount > totalCycles * 0.3) {
                        score -= 15; // Triệu chứng nghiêm trọng thường xuyên
                    }

                    return Math.max(0, Math.min(100, Math.round(score)));
                }

                updateStatCards(stats, detailedStats) {
                    // Animate stat cards (only if animations enabled)
                    if (this.data.preferences.animationsEnabled) {
                        $(".stat-card").addClass("stat-updating");
                    }

                    const delay = this.data.preferences.animationsEnabled ? 200 : 0;
                    setTimeout(() => {
                        // Update basic stats
                        this.animateStatValue("#last-cycle-days", stats.averageCycleLength);
                        this.animateStatValue("#last-period-days", stats.averagePeriodLength);
                        this.animateStatValue("#avg-cycle-length", stats.averageCycleLength);
                        this.animateStatValue("#total-cycles-tracked", stats.totalCycles);

                        // Update status indicators
                        this.updateStatStatus(stats, detailedStats);

                        $(".stat-card").removeClass("stat-updating");
                    }, delay);
                }

                animateStatValue(selector, newValue) {
                    const $element = $(selector);
                    const currentValue = parseInt($element.text()) || 0;

                    if (currentValue !== newValue && this.data.preferences.animationsEnabled) {
                        // Counter animation
                        const duration = 800;
                        const startTime = Date.now();

                        const animate = () => {
                            const elapsed = Date.now() - startTime;
                            const progress = Math.min(elapsed / duration, 1);

                            // Easing function
                            const easeOut = 1 - Math.pow(1 - progress, 3);
                            const currentCount = Math.round(currentValue + (newValue - currentValue) * easeOut);

                            $element.text(currentCount);

                            if (progress < 1) {
                                requestAnimationFrame(animate);
                            }
                        };

                        requestAnimationFrame(animate);
                    } else {
                        $element.text(newValue);
                    }
                }

                updateStatStatus(stats, detailedStats) {
                    const statusElements = $(".stat-status");

                    statusElements.each(function (index) {
                        const $status = $(this);
                        let statusText = "BÌNH THƯỜNG";
                        let statusClass = "normal";

                        switch (index) {
                            case 0: // Last cycle
                                if (stats.cycleLengths.length > 0) {
                                    const lastCycle = stats.cycleLengths[stats.cycleLengths.length - 1];
                                    if (lastCycle < 21 || lastCycle > 35) {
                                        statusText = "BẤT THƯỜNG";
                                        statusClass = "irregular";
                                    }
                                }
                                break;

                            case 1: // Period length
                                statusText = "BÌNH THƯỜNG";
                                break;

                            case 2: // Average cycle
                                if (stats.isRegular) {
                                    statusText = "ĐỀU ĐẶN";
                                    statusClass = "normal";
                                } else {
                                    statusText = "KHÔNG ĐỀU";
                                    statusClass = "irregular";
                                }
                                break;

                            case 3: // Total cycles
                                statusText = "ĐÃ THEO DÕI";
                                statusClass = "tracking";
                                break;
                        }

                        $status.text(statusText);
                        $status.removeClass("normal irregular tracking").addClass(statusClass);
                    });
                }

                updateTrendsAnalysis(stats) {
                    // Create trends summary
                    const trendsHtml = this.generateTrendsSummary(stats);

                    // Update trends section if it exists
                    if ($("#trends-summary").length) {
                        $("#trends-summary").html(trendsHtml);
                    }
                }

                generateTrendsSummary(stats) {
                    const trends = [];

                    // Cycle length trend
                    if (stats.trend === "lengthening") {
                        trends.push("📈 Chu kỳ có xu hướng dài hơn");
                    } else if (stats.trend === "shortening") {
                        trends.push("📉 Chu kỳ có xu hướng ngắn hơn");
                    } else {
                        trends.push("📊 Chu kỳ ổn định");
                    }

                    // Regularity trend
                    if (stats.isRegular) {
                        trends.push("✅ Chu kỳ đều đặn");
                    } else {
                        trends.push("⚠️ Chu kỳ chưa đều đặn");
                    }

                    // Confidence trend
                    if (stats.confidence >= 80) {
                        trends.push("🎯 Dự đoán độ tin cậy cao");
                    } else if (stats.confidence >= 50) {
                        trends.push("📊 Dự đoán độ tin cậy trung bình");
                    } else {
                        trends.push("📝 Cần thêm dữ liệu để dự đoán chính xác");
                    }

                    return trends.map((trend) => `<div class="trend-item">${trend}</div>`).join("");
                }

                updateHealthScore(stats) {
                    const score = this.calculateHealthScore(stats);

                    // Update health score display
                    if ($("#health-score").length) {
                        this.animateStatValue("#health-score", score);
                        this.updateHealthScoreColor(score);
                    }
                }

                calculateHealthScore(stats) {
                    let score = 50; // Base score

                    // Regularity bonus
                    if (stats.isRegular) score += 20;

                    // Confidence bonus
                    score += Math.floor(stats.confidence / 5);

                    // Tracking consistency bonus
                    const trackingDays = this.calculateTrackingStreak();
                    score += Math.min(trackingDays / 10, 15);

                    // Variability penalty
                    if (stats.variability > 7) score -= 10;

                    return Math.min(Math.max(score, 0), 100);
                }

                updateHealthScoreColor(score) {
                    const $scoreElement = $("#health-score");

                    $scoreElement.removeClass("score-excellent score-good score-fair score-poor");

                    if (score >= 85) {
                        $scoreElement.addClass("score-excellent");
                    } else if (score >= 70) {
                        $scoreElement.addClass("score-good");
                    } else if (score >= 50) {
                        $scoreElement.addClass("score-fair");
                    } else {
                        $scoreElement.addClass("score-poor");
                    }
                }

                // ===== ENHANCED CHART MANAGEMENT =====
                updateAllCharts() {
                    const startTime = performance.now();

                    // Update charts with delay for smooth rendering (only if animations enabled)
                    if (this.data.preferences.animationsEnabled) {
                        setTimeout(() => this.updateCycleLengthChart(), 50);
                        setTimeout(() => this.updatePeriodLengthChart(), 100);
                        setTimeout(() => this.updateFertilityChart(), 150);
                        setTimeout(() => this.updateSymptomsTimelineChart(), 200);
                    } else {
                        this.updateCycleLengthChart();
                        this.updatePeriodLengthChart();
                        this.updateFertilityChart();
                        this.updateSymptomsTimelineChart();
                    }

                    this.performance.chartRenderTime = performance.now() - startTime;
                }

                updateCycleLengthChart() {
                    const stats = this.calculateCycleStats();
                    const ctx = document.getElementById("cycle-length-chart");
                    if (!ctx) return;

                    // Destroy existing chart
                    if (this.charts.cycleLengthChart) {
                        this.charts.cycleLengthChart.destroy();
                    }

                    const isDark = this.isDarkTheme();
                    const textColor = isDark ? "#f0f0ff" : "#333";
                    const gridColor = isDark ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)";

                    try {
                        this.charts.cycleLengthChart = new Chart(ctx, {
                            type: "line",
                            data: {
                                labels: stats.cycleLengths.map((_, i) => `Chu kỳ ${i + 1}`),
                                datasets: [
                                    {
                                        label: "Độ dài chu kỳ",
                                        data: stats.cycleLengths,
                                        borderColor: "#e91e63",
                                        backgroundColor: "rgba(233, 30, 99, 0.1)",
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 6,
                                        pointHoverRadius: 8,
                                        pointBackgroundColor: stats.cycleLengths.map((length) => {
                                            const avgLength = stats.averageCycleLength;
                                            const diff = Math.abs(length - avgLength);
                                            if (diff <= 2) return "#10b981"; // Green for normal
                                            if (diff <= 4) return "#f59e0b"; // Orange for slightly off
                                            return "#ef4444"; // Red for very different
                                        }),
                                        pointBorderColor: "#fff",
                                        pointBorderWidth: 2,
                                    },
                                    {
                                        label: "Trung bình",
                                        data: new Array(stats.cycleLengths.length).fill(stats.averageCycleLength),
                                        borderColor: "#9c27b0",
                                        borderDash: [5, 5],
                                        fill: false,
                                        pointRadius: 0,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        labels: {
                                            color: textColor,
                                        },
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                return `${context.parsed.y} ngày`;
                                            },
                                            afterLabel: function (context) {
                                                const avg = stats.averageCycleLength;
                                                const diff = context.parsed.y - avg;
                                                if (diff > 0) return `+${diff} ngày so với TB`;
                                                if (diff < 0) return `${diff} ngày so với TB`;
                                                return "Bằng trung bình";
                                            },
                                        },
                                    },
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        min: Math.max(15, Math.min(...stats.cycleLengths) - 5),
                                        max: Math.min(45, Math.max(...stats.cycleLengths) + 5),
                                        ticks: {
                                            color: textColor,
                                            callback: function (value) {
                                                return value + " ngày";
                                            },
                                        },
                                        grid: {
                                            color: gridColor,
                                        },
                                    },
                                    x: {
                                        ticks: {
                                            color: textColor,
                                        },
                                        grid: {
                                            color: gridColor,
                                        },
                                    },
                                },
                                animation: {
                                    duration: this.data.preferences.animationsEnabled ? 1000 : 0,
                                    easing: "easeOutQuart",
                                },
                            },
                        });
                    } catch (error) {
                        console.error("Failed to create cycle length chart:", error);
                    }
                }

                updatePeriodLengthChart() {
                    const ctx = document.getElementById("period-length-chart");
                    if (!ctx) return;

                    // Dữ liệu từ chu kỳ
                    const periodLengths = this.data.cycles
                        .filter((cycle) => cycle.type === "period-start")
                        .map((cycle) => {
                            // Giả định rằng thời gian kinh nguyệt được lưu trong phần tử này
                            return cycle.periodLength || this.data.settings.averagePeriodLength;
                        });

                    const labels = periodLengths.map((_, index) => `Chu kỳ ${index + 1}`);

                    // Tạo biểu đồ
                    if (this.charts.periodLengthChart) {
                        this.charts.periodLengthChart.destroy(); // Xóa biểu đồ cũ
                    }

                    const isDark = this.isDarkTheme();
                    const textColor = isDark ? "#f0f0ff" : "#333";
                    const gridColor = isDark ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)";

                    try {
                        this.charts.periodLengthChart = new Chart(ctx, {
                            type: "bar",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: "Thời gian kinh nguyệt (ngày)",
                                        data: periodLengths,
                                        backgroundColor: "rgba(233, 30, 99, 0.5)",
                                        borderColor: "rgba(233, 30, 99, 1)",
                                        borderWidth: 1,
                                        tension: 0.4,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: textColor,
                                        },
                                    },
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: "Số ngày",
                                            color: textColor,
                                        },
                                        ticks: {
                                            color: textColor,
                                        },
                                        grid: {
                                            color: gridColor,
                                        },
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: "Chu kỳ",
                                            color: textColor,
                                        },
                                        ticks: {
                                            color: textColor,
                                        },
                                        grid: {
                                            color: gridColor,
                                        },
                                    },
                                },
                                animation: {
                                    duration: this.data.preferences.animationsEnabled ? 1000 : 0,
                                },
                            },
                        });
                    } catch (error) {
                        console.error("Failed to create period length chart:", error);
                    }
                }

                updateFertilityChart() {
                    const ctx = document.getElementById("fertility-chart");
                    if (!ctx) return;

                    // Dữ liệu từ chu kỳ
                    const fertilityData = [];
                    const labels = [];

                    // Tính toán khả năng thụ thai dựa trên chu kỳ
                    const stats = this.calculateCycleStats();
                    if (stats.cycleLengths.length > 0) {
                        stats.cycleLengths.forEach((length, index) => {
                            // Tính khả năng thụ thai dựa trên độ dài chu kỳ
                            let fertilityScore = 50; // Base score

                            // Chu kỳ đều đặn = khả năng thụ thai cao hơn
                            if (length >= 25 && length <= 32) {
                                fertilityScore += 30;
                            } else if (length >= 21 && length <= 35) {
                                fertilityScore += 15;
                            }

                            fertilityData.push(Math.min(fertilityScore, 100));
                            labels.push(`Chu kỳ ${index + 1}`);
                        });
                    }

                    // Tạo biểu đồ
                    if (this.charts.fertilityChart) {
                        this.charts.fertilityChart.destroy();
                    }

                    const isDark = this.isDarkTheme();
                    const textColor = isDark ? "#f0f0ff" : "#333";
                    const gridColor = isDark ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.1)";

                    try {
                        this.charts.fertilityChart = new Chart(ctx, {
                            type: "line",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: "Khả năng thụ thai (%)",
                                        data: fertilityData,
                                        backgroundColor: "rgba(16, 185, 129, 0.2)",
                                        borderColor: "rgba(16, 185, 129, 1)",
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 5,
                                        pointHoverRadius: 7,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: textColor,
                                        },
                                    },
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100,
                                        title: {
                                            display: true,
                                            text: "Khả năng thụ thai (%)",
                                            color: textColor,
                                        },
                                        ticks: {
                                            color: textColor,
                                        },
                                        grid: {
                                            color: gridColor,
                                        },
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: "Chu kỳ",
                                            color: textColor,
                                        },
                                        ticks: {
                                            color: textColor,
                                        },
                                        grid: {
                                            color: gridColor,
                                        },
                                    },
                                },
                                animation: {
                                    duration: this.data.preferences.animationsEnabled ? 1000 : 0,
                                },
                            },
                        });
                    } catch (error) {
                        console.error("Failed to create fertility chart:", error);
                    }
                }

                updateSymptomsTimelineChart() {
                    const ctx = document.getElementById("symptoms-timeline-chart");
                    if (!ctx) return;

                    // Dữ liệu triệu chứng
                    const symptomCounts = {};
                    const symptomNames = {
                        cramps: "Đau bụng",
                        backache: "Đau lưng",
                        headache: "Đau đầu",
                        fatigue: "Mệt mỏi",
                        acne: "Mụn",
                        bloating: "Đầy hơi",
                        "tender-breasts": "Căng ngực",
                        nausea: "Buồn nôn",
                        "mood-swings": "Thay đổi tâm trạng",
                        cravings: "Thèm ăn",
                        insomnia: "Mất ngủ",
                        dizziness: "Chóng mặt",
                    };

                    // Đếm tần suất triệu chứng
                    this.data.cycles.forEach((cycle) => {
                        if (cycle.symptoms) {
                            cycle.symptoms.forEach((symptom) => {
                                symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
                            });
                        }
                    });

                    // Chuyển đổi thành mảng cho biểu đồ
                    const labels = Object.keys(symptomCounts).map((key) => symptomNames[key] || key);
                    const data = Object.values(symptomCounts);

                    // Tạo biểu đồ
                    if (this.charts.symptomsTimelineChart) {
                        this.charts.symptomsTimelineChart.destroy();
                    }

                    const isDark = this.isDarkTheme();
                    const textColor = isDark ? "#f0f0ff" : "#333";

                    try {
                        this.charts.symptomsTimelineChart = new Chart(ctx, {
                            type: "doughnut",
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: "Tần suất triệu chứng",
                                        data: data,
                                        backgroundColor: [
                                            "rgba(233, 30, 99, 0.7)",
                                            "rgba(16, 185, 129, 0.7)",
                                            "rgba(156, 39, 176, 0.7)",
                                            "rgba(255, 193, 7, 0.7)",
                                            "rgba(33, 150, 243, 0.7)",
                                            "rgba(255, 87, 34, 0.7)",
                                            "rgba(76, 175, 80, 0.7)",
                                            "rgba(121, 85, 72, 0.7)",
                                            "rgba(158, 158, 158, 0.7)",
                                            "rgba(255, 152, 0, 0.7)",
                                            "rgba(103, 58, 183, 0.7)",
                                            "rgba(205, 220, 57, 0.7)",
                                        ],
                                        borderColor: [
                                            "rgba(233, 30, 99, 1)",
                                            "rgba(16, 185, 129, 1)",
                                            "rgba(156, 39, 176, 1)",
                                            "rgba(255, 193, 7, 1)",
                                            "rgba(33, 150, 243, 1)",
                                            "rgba(255, 87, 34, 1)",
                                            "rgba(76, 175, 80, 1)",
                                            "rgba(121, 85, 72, 1)",
                                            "rgba(158, 158, 158, 1)",
                                            "rgba(255, 152, 0, 1)",
                                            "rgba(103, 58, 183, 1)",
                                            "rgba(205, 220, 57, 1)",
                                        ],
                                        borderWidth: 2,
                                    },
                                ],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: "bottom",
                                        labels: {
                                            color: textColor,
                                            padding: 15,
                                            usePointStyle: true,
                                        },
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                const label = context.label || "";
                                                const value = context.raw;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = Math.round((value / total) * 100);
                                                return `${label}: ${value} lần (${percentage}%)`;
                                            },
                                        },
                                    },
                                },
                                animation: {
                                    duration: this.data.preferences.animationsEnabled ? 1000 : 0,
                                },
                            },
                        });
                    } catch (error) {
                        console.error("Failed to create symptoms timeline chart:", error);
                    }
                }

                // ===== SYMPTOMS ANALYSIS SECTION =====
                updateSymptomsAnalysis() {
                    try {
                        const symptomsData = this.data.cycles.filter((c) => c.type === "symptoms");
                        const totalSymptoms = symptomsData.reduce((sum, entry) => sum + (entry.symptoms?.length || 0), 0);

                        // Update total symptoms count
                        $("#total-symptoms").text(totalSymptoms);

                        if (totalSymptoms > 0) {
                            // Analyze symptoms
                            const symptomCounts = {};
                            symptomsData.forEach((entry) => {
                                if (entry.symptoms) {
                                    entry.symptoms.forEach((symptom) => {
                                        symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
                                    });
                                }
                            });

                            const mostCommon = Object.keys(symptomCounts).reduce((a, b) => (symptomCounts[a] > symptomCounts[b] ? a : b), "");

                            $("#most-common-symptom").text(`Phổ biến nhất: ${this.getSymptomName(mostCommon)}`);

                            // Update top symptoms list
                            this.updateTopSymptomsList(symptomCounts);

                            // Update symptoms timeline chart
                            this.updateSymptomsTimelineChart();
                        } else {
                            $("#most-common-symptom").text("Chưa có dữ liệu");
                            $("#top-symptoms-list").html('<p style="text-align: center; color: #666;">Chưa có dữ liệu triệu chứng</p>');
                        }
                    } catch (error) {
                        console.error("Symptoms analysis failed:", error);
                    }
                }

                updateTopSymptomsList(symptomCounts) {
                    const $container = $("#top-symptoms-list");
                    $container.empty();

                    // Sort symptoms by frequency
                    const sortedSymptoms = Object.entries(symptomCounts)
                        .sort(([, a], [, b]) => b - a)
                        .slice(0, 5); // Top 5 symptoms

                    if (sortedSymptoms.length === 0) {
                        $container.html('<p style="text-align: center; color: #666;">Chưa có dữ liệu triệu chứng</p>');
                        return;
                    }

                    const total = Object.values(symptomCounts).reduce((a, b) => a + b, 0);

                    sortedSymptoms.forEach(([symptom, count], index) => {
                        const percentage = Math.round((count / total) * 100);
                        const symptomName = this.getSymptomName(symptom);

                        const itemHtml = `
                        <div class="symptom-stat-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color); min-width: 20px;">${index + 1}</span>
                                <span style="font-weight: 500;">${symptomName}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: var(--accent-color);">${count} lần</div>
                                <div style="font-size: 0.8rem; color: #666;">${percentage}%</div>
                            </div>
                        </div>
                    `;

                        $container.append(itemHtml);
                    });
                }

                // ===== HISTORY SECTION =====
                updateHistory() {
                    try {
                        const $container = $("#history-timeline");
                        $container.empty();

                        // Get filtered activities
                        const filter = $("#history-filter").val() || "all";
                        let activities = [...this.data.cycles];

                        if (filter !== "all") {
                            activities = activities.filter((activity) => activity.type === filter);
                        }

                        // Sort by date (newest first)
                        activities.sort((a, b) => new Date(b.date) - new Date(a.date));

                        if (activities.length === 0) {
                            $container.html(`
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-clock-rotate-left" style="font-size: 3rem; margin-bottom: 15px; display: block; color: var(--accent-color);"></i>
                                <p>Chưa có hoạt động nào</p>
                                <p style="font-size: 0.9rem;">Hãy bắt đầu ghi nhận chu kỳ của bạn!</p>
                            </div>
                        `);
                            return;
                        }

                        // Group activities by month
                        const groupedActivities = this.groupActivitiesByMonth(activities);

                        // Render timeline
                        Object.keys(groupedActivities).forEach((monthKey) => {
                            const monthActivities = groupedActivities[monthKey];
                            const monthHtml = this.generateMonthTimelineHtml(monthKey, monthActivities);
                            $container.append(monthHtml);
                        });
                    } catch (error) {
                        console.error("History update failed:", error);
                    }
                }

                groupActivitiesByMonth(activities) {
                    const grouped = {};

                    activities.forEach((activity) => {
                        const date = new Date(activity.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;

                        if (!grouped[monthKey]) {
                            grouped[monthKey] = [];
                        }

                        grouped[monthKey].push(activity);
                    });

                    return grouped;
                }

                generateMonthTimelineHtml(monthKey, activities) {
                    const [year, month] = monthKey.split("-");
                    const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];

                    const monthName = monthNames[parseInt(month) - 1];

                    let html = `
                    <div class="timeline-month" style="margin-bottom: 30px;">
                        <h3 style="color: var(--accent-color); margin-bottom: 20px; padding: 10px; background: rgba(233,30,99,0.1); border-radius: 12px; text-align: center;">
                            <i class="fas fa-calendar"></i> ${monthName} ${year}
                        </h3>
                        <div class="timeline-activities">
                `;

                    activities.forEach((activity) => {
                        html += this.generateTimelineActivityHtml(activity);
                    });

                    html += `
                        </div>
                    </div>
                `;

                    return html;
                }

                generateTimelineActivityHtml(activity) {
                    const date = new Date(activity.date);
                    const formattedDate = date.toLocaleDateString("vi-VN", {
                        weekday: "long",
                        day: "2-digit",
                        month: "2-digit",
                    });

                    return `
                    <div class="timeline-activity" style="display: flex; padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border-radius: 12px; border-left: 4px solid var(--accent-color);">
                        <div class="activity-icon" style="font-size: 1.5rem; margin-right: 15px; min-width: 40px;">
                            ${this.getActivityIcon(activity.type)}
                        </div>
                        <div class="activity-content" style="flex: 1;">
                            <div class="activity-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <h4 style="margin: 0; color: var(--accent-color);">${this.getActivityTypeName(activity.type)}</h4>
                                <span style="font-size: 0.8rem; color: #666;">${formattedDate}</span>
                            </div>
                            
                            ${activity.type === "period-start" && activity.flow
                            ? `
                                <p style="margin: 5px 0; font-size: 0.9rem;">
                                    <strong>Lưu lượng:</strong> ${this.getFlowName(activity.flow)}
                                </p>
                            `
                            : ""
                        }
                            
                            ${activity.symptoms && activity.symptoms.length > 0
                            ? `
                                <p style="margin: 5px 0; font-size: 0.9rem;">
                                    <strong>Triệu chứng:</strong> ${activity.symptoms.map((s) => this.getSymptomName(s)).join(", ")}
                                </p>
                            `
                            : ""
                        }
                            
                            ${activity.moods && activity.moods.length > 0
                            ? `
                                <p style="margin: 5px 0; font-size: 0.9rem;">
                                    <strong>Tâm trạng:</strong> ${activity.moods.map((m) => this.getMoodName(m)).join(", ")}
                                </p>
                            `
                            : ""
                        }
                            
                            ${activity.note
                            ? `
                                <p style="margin: 8px 0 0 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; font-style: italic; font-size: 0.9rem;">
                                    "${activity.note}"
                                </p>
                            `
                            : ""
                        }
                        </div>
                    </div>
                `;
                }

                // ===== SETTINGS HANDLERS =====
                setupSettingsHandlers() {
                    console.log("⚙️ Setting up settings handlers...");

                    // Export data handler
                    $("#export-btn")
                        .off("click")
                        .on("click", () => {
                            try {
                                this.exportData();
                            } catch (error) {
                                console.error("Export failed:", error);
                                this.showToast("Lỗi xuất dữ liệu! 😔", "error");
                            }
                        });

                    // Import data handler
                    $("#import-btn")
                        .off("click")
                        .on("click", () => {
                            this.showImportDialog();
                        });

                    // Clear all data handler
                    $("#clear-data-btn")
                        .off("click")
                        .on("click", () => {
                            this.clearAllData();
                        });

                    // Settings change handlers
                    $("#cycle-length-setting")
                        .off("change")
                        .on("change", (e) => {
                            const newLength = parseInt($(e.target).val());
                            if (newLength >= 21 && newLength <= 35) {
                                this.data.settings.averageCycleLength = newLength;
                                this.saveData();
                                this.showToast(`Độ dài chu kỳ: ${newLength} ngày! ⚙️`, "success");
                                this.updateAllSections();
                            } else {
                                this.showToast("Độ dài chu kỳ phải từ 21-35 ngày! ⚠️", "warning");
                                $(e.target).val(this.data.settings.averageCycleLength);
                            }
                        });

                    $("#period-length-setting")
                        .off("change")
                        .on("change", (e) => {
                            const newLength = parseInt($(e.target).val());
                            if (newLength >= 3 && newLength <= 8) {
                                this.data.settings.averagePeriodLength = newLength;
                                this.saveData();
                                this.showToast(`Thời gian kinh: ${newLength} ngày! ⚙️`, "success");
                                this.updateAllSections();
                            } else {
                                this.showToast("Thời gian kinh phải từ 3-8 ngày! ⚠️", "warning");
                                $(e.target).val(this.data.settings.averagePeriodLength);
                            }
                        });

                    // Notification setting
                    $("#notification-switch")
                        .off("change")
                        .on("change", () => {
                            const isEnabled = $("#notification-switch").is(":checked");
                            this.data.settings.notifications = isEnabled;
                            this.saveData();

                            if (isEnabled && isNotificationSupported()) {
                                this.requestNotificationPermission();
                            }

                            this.showToast(`Thông báo đã ${isEnabled ? "bật" : "tắt"}! 🔔`, "info");
                        });

                    // History filter handler
                    $("#history-filter")
                        .off("change")
                        .on("change", () => {
                            this.updateHistory();
                        });

                    // Trends filter handler
                    $("#trends-filter")
                        .off("change")
                        .on("change", () => {
                            this.updateSymptomsAnalysis();
                        });
                }

                updateSettings() {
                    try {
                        // Update form values
                        $("#cycle-length-setting").val(this.data.settings.averageCycleLength);
                        $("#period-length-setting").val(this.data.settings.averagePeriodLength);
                        $("#theme-switch").prop("checked", this.data.settings.theme === "dark");
                        $("#notification-switch").prop("checked", this.data.settings.notifications);
                    } catch (error) {
                        console.error("Settings update failed:", error);
                    }
                }

                // ===== DATA EXPORT/IMPORT =====
                exportData() {
                    try {
                        const completeBackup = {
                            // Dữ liệu chính của ứng dụng
                            cycles: this.data.cycles || [],
                            settings: this.data.settings || {},
                            preferences: this.data.preferences || {},
                            cache: this.data.cache || {},

                            // Dữ liệu từ localStorage (bao gồm cả những gì có thể bị bỏ sót)
                            localStorage: this.getAllLocalStorageData(),

                            // Thống kê và tính toán hiện tại
                            currentStats: this.calculateCycleStats(),
                            detailedStats: this.calculateDetailedStats(),

                            // Thông tin phiên bản và xuất
                            metadata: {
                                exportDate: new Date().toISOString(),
                                version: this.version,
                                userAgent: navigator.userAgent,
                                exportType: "complete",
                                totalItems: this.data.cycles.length,
                                dataIntegrityHash: this.generateDataHash(),
                            },

                            // Cài đặt ứng dụng hiện tại
                            appState: {
                                currentTheme: document.body.className,
                                currentSection: this.state.activeSection,
                                lastCalculation: this.data.cache.lastCalculation,
                                performanceMetrics: this.performance,
                            },

                            // Dữ liệu AI và insights
                            aiData: {
                                insights: this.ai?.insights || [],
                                patterns: this.ai?.patterns || {},
                                recommendations: this.ai?.recommendations || [],
                            },
                        };

                        // Tạo file backup
                        const dataStr = JSON.stringify(completeBackup, null, 2);
                        const dataBlob = new Blob([dataStr], {
                            type: "application/json",
                        });

                        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
                        const fileName = `chu-ky-complete-backup-${timestamp}.json`;

                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(dataBlob);
                        link.download = fileName;

                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // Hiển thị thông tin chi tiết về backup
                        this.showBackupInfo(completeBackup);

                        console.log("📦 Complete backup created:", {
                            size: `${(dataStr.length / 1024).toFixed(2)} KB`,
                            items: completeBackup.cycles.length,
                        });
                    } catch (error) {
                        console.error("❌ Export failed:", error);
                        this.showToast("Lỗi khi xuất dữ liệu! Vui lòng thử lại. 😔", "error");
                    }
                }

                getAllLocalStorageData() {
                    const localStorageData = {};

                    try {
                        // Lấy tất cả keys từ localStorage
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            const value = localStorage.getItem(key);

                            try {
                                // Thử parse JSON, nếu không được thì lưu raw string
                                localStorageData[key] = JSON.parse(value);
                            } catch (e) {
                                localStorageData[key] = value;
                            }
                        }
                    } catch (error) {
                        console.warn("⚠️ Could not access some localStorage data:", error);
                    }

                    return localStorageData;
                }

                generateDataHash() {
                    try {
                        const dataString = JSON.stringify({
                            cycles: this.data.cycles,
                            settings: this.data.settings,
                        });

                        // Simple hash function
                        let hash = 0;
                        for (let i = 0; i < dataString.length; i++) {
                            const char = dataString.charCodeAt(i);
                            hash = (hash << 5) - hash + char;
                            hash = hash & hash; // Convert to 32-bit integer
                        }

                        return hash.toString(36);
                    } catch (error) {
                        return "unknown";
                    }
                }

                showBackupInfo(backupData) {
                    const info = {
                        totalCycles: backupData.cycles.length,
                        totalSettings: Object.keys(backupData.settings).length,
                        totalPreferences: Object.keys(backupData.preferences).length,
                        dataSize: JSON.stringify(backupData).length,
                        exportDate: backupData.metadata.exportDate,
                    };

                    const message = `📦 Sao lưu hoàn tất!\n\n📊 Thống kê backup:\n• ${info.totalCycles} chu kỳ đã lưu\n• ${info.totalSettings} cài đặt\n• ${info.totalPreferences} tùy chọn\n• Kích thước: ${(info.dataSize / 1024).toFixed(
                        2
                    )} KB\n\n💾 File đã được tải xuống!`;

                    this.showToast(message, "success", 8000);
                }

                showImportDialog() {
                    try {
                        const fileInput = document.createElement("input");
                        fileInput.type = "file";
                        fileInput.accept = ".json";
                        fileInput.style.display = "none";

                        fileInput.addEventListener("change", (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                // Kiểm tra loại file
                                if (!file.name.toLowerCase().endsWith(".json")) {
                                    this.showToast("Vui lòng chọn file JSON! 📄", "warning");
                                    return;
                                }

                                // Kiểm tra kích thước file (max 10MB)
                                if (file.size > 10 * 1024 * 1024) {
                                    this.showToast("File quá lớn! Vui lòng chọn file nhỏ hơn 10MB. 📁", "warning");
                                    return;
                                }

                                // Đọc file
                                const reader = new FileReader();

                                reader.onload = (e) => {
                                    try {
                                        const importData = JSON.parse(e.target.result);
                                        this.processImportData(importData);
                                    } catch (error) {
                                        console.error("JSON parse error:", error);
                                        this.showToast("File không hợp lệ! Vui lòng kiểm tra định dạng JSON. 😔", "error");
                                    }
                                };

                                reader.onerror = () => {
                                    this.showToast("Lỗi đọc file! Vui lòng thử lại. 😔", "error");
                                };

                                // Hiển thị loading
                                this.showToast("Đang đọc file... 📖", "info", 2000);

                                // Đọc file as text
                                reader.readAsText(file);
                            }
                        });

                        // Thêm vào DOM và trigger click
                        document.body.appendChild(fileInput);
                        fileInput.click();

                        // Cleanup
                        setTimeout(() => {
                            if (document.body.contains(fileInput)) {
                                document.body.removeChild(fileInput);
                            }
                        }, 1000);
                    } catch (error) {
                        console.error("Show import dialog failed:", error);
                        this.showToast("Lỗi mở hộp thoại nhập file! 😔", "error");
                    }
                }

                processImportData(importData) {
                    try {
                        // Validate dữ liệu import
                        const validation = this.validateImportData(importData);

                        if (!validation.isValid) {
                            this.showToast(`Dữ liệu không hợp lệ: ${validation.errors.join(", ")} 😔`, "error");
                            return;
                        }

                        // Hiển thị thông tin preview
                        this.showImportPreview(importData, validation);
                    } catch (error) {
                        console.error("Process import data failed:", error);
                        this.showToast("Lỗi xử lý dữ liệu import! 😔", "error");
                    }
                }

                validateImportData(importData) {
                    const errors = [];

                    // Kiểm tra cấu trúc cơ bản
                    if (!importData || typeof importData !== "object") {
                        errors.push("Dữ liệu không đúng định dạng");
                        return {
                            isValid: false,
                            errors,
                        };
                    }

                    // Kiểm tra cycles
                    if (importData.cycles && !Array.isArray(importData.cycles)) {
                        errors.push("Dữ liệu chu kỳ không hợp lệ");
                    }

                    // Kiểm tra settings
                    if (importData.settings && typeof importData.settings !== "object") {
                        errors.push("Dữ liệu cài đặt không hợp lệ");
                    }

                    // Kiểm tra version compatibility
                    if (importData.metadata && importData.metadata.version) {
                        const importVersion = importData.metadata.version;
                        const currentVersion = this.version;

                        if (this.compareVersions(importVersion, currentVersion) > 1) {
                            errors.push(`Phiên bản không tương thích (${importVersion} > ${currentVersion})`);
                        }
                    }

                    return {
                        isValid: errors.length === 0,
                        errors,
                        info: {
                            cyclesCount: importData.cycles ? importData.cycles.length : 0,
                            hasSettings: !!importData.settings,
                            hasPreferences: !!importData.preferences,
                            hasAI: !!importData.aiData,
                            hasCache: !!importData.cache,
                            version: importData.metadata?.version || "Unknown",
                            exportDate: importData.metadata?.exportDate || "Unknown",
                        },
                    };
                }

                showImportPreview(importData, validation) {
                    const info = validation.info;

                    const previewMessage = `🔍 PREVIEW DỮ LIỆU IMPORT\n\n📊 Thông tin file:\n• Số chu kỳ: ${info.cyclesCount}\n• Cài đặt: ${info.hasSettings ? "✅" : "❌"}\n• Tùy chọn: ${info.hasPreferences ? "✅" : "❌"}\n• AI Data: ${info.hasAI ? "✅" : "❌"
                        }\n• Cache: ${info.hasCache ? "✅" : "❌"}\n• Phiên bản: ${info.version}\n• Ngày xuất: ${new Date(info.exportDate).toLocaleDateString("vi-VN")}\n\n⚠️ Dữ liệu hiện tại sẽ bị ghi đè!\n• Chu kỳ hiện tại: ${this.data.cycles.length
                        }\n• Cài đặt hiện tại: ${Object.keys(this.data.settings).length} mục\n\nBạn có muốn tiếp tục?`;

                    // Sử dụng confirm với thông tin chi tiết
                    if (confirm(previewMessage)) {
                        this.importData(importData);
                    } else {
                        this.showToast("Đã hủy import dữ liệu! 🚫", "info");
                    }
                }

                compareVersions(version1, version2) {
                    const v1parts = version1.split(".").map(Number);
                    const v2parts = version2.split(".").map(Number);

                    for (let i = 0; i < Math.max(v1parts.length, v2parts.length); i++) {
                        const v1part = v1parts[i] || 0;
                        const v2part = v2parts[i] || 0;

                        if (v1part > v2part) return 1;
                        if (v1part < v2part) return -1;
                    }

                    return 0;
                }

                importData(importData) {
                    if (!confirm("⚠️ CẢNH BÁO: Khôi phục dữ liệu sẽ GHI ĐÈ TẤT CẢ dữ liệu hiện tại!\n\nBạn có chắc chắn muốn tiếp tục?")) {
                        return;
                    }

                    try {
                        console.log("📥 Starting complete data import...");

                        // Khôi phục dữ liệu chính
                        if (importData.cycles && Array.isArray(importData.cycles)) {
                            this.data.cycles = this.validateCyclesData(importData.cycles);
                            console.log(`✅ Restored ${this.data.cycles.length} cycles`);
                        }

                        if (importData.settings) {
                            this.data.settings = {
                                ...this.data.settings,
                                ...importData.settings,
                            };
                            console.log("✅ Restored settings");
                        }

                        if (importData.preferences) {
                            this.data.preferences = {
                                ...this.data.preferences,
                                ...importData.preferences,
                            };
                            console.log("✅ Restored preferences");
                        }

                        if (importData.cache) {
                            this.data.cache = {
                                ...this.data.cache,
                                ...importData.cache,
                            };
                            console.log("✅ Restored cache");
                        }

                        // Khôi phục dữ liệu AI
                        if (importData.aiData) {
                            if (this.ai) {
                                this.ai.insights = importData.aiData.insights || [];
                                this.ai.patterns = importData.aiData.patterns || {};
                                this.ai.recommendations = importData.aiData.recommendations || [];
                                console.log("✅ Restored AI data");
                            }
                        }

                        // Lưu tất cả dữ liệu
                        this.saveData();

                        // Cập nhật giao diện
                        this.updateAllSections();

                        // Áp dụng cài đặt theme
                        if (importData.settings && importData.settings.theme) {
                            this.applyTheme(importData.settings.theme);
                            $("#theme-switch").prop("checked", importData.settings.theme === "dark");
                        }

                        // Áp dụng các cài đặt khác
                        if (importData.settings) {
                            $("#cycle-length-setting").val(importData.settings.averageCycleLength || 28);
                            $("#period-length-setting").val(importData.settings.averagePeriodLength || 5);
                            $("#notification-switch").prop("checked", importData.settings.notifications || false);
                        }

                        // Hiển thị thông tin khôi phục
                        this.showRestoreInfo(importData);
                    } catch (error) {
                        console.error("❌ Import processing failed:", error);
                        this.showToast("Lỗi khi xử lý dữ liệu nhập! Một số dữ liệu có thể đã được khôi phục. 😔", "error");
                    }
                }

                showRestoreInfo(importData) {
                    const info = {
                        version: importData.metadata?.version || "Unknown",
                        exportDate: importData.metadata?.exportDate || "Unknown",
                        totalCycles: importData.cycles?.length || 0,
                        hasAI: !!importData.aiData,
                        hasCache: !!importData.cache,
                    };

                    const message = `🎉 Khôi phục dữ liệu thành công!\n\n📊 Thông tin được khôi phục:\n• ${info.totalCycles} chu kỳ\n• Phiên bản: ${info.version}\n• Ngày xuất: ${new Date(info.exportDate).toLocaleDateString("vi-VN")}\n• AI Data: ${info.hasAI ? "✅" : "❌"
                        }\n• Cache: ${info.hasCache ? "✅" : "❌"}\n\n🔄 Giao diện đã được cập nhật!`;

                    this.showToast(message, "success", 10000);
                }

                clearAllData() {
                    if (confirm("⚠️ CẢNH BÁO: Thao tác này sẽ xóa TẤT CẢ dữ liệu và không thể hoàn tác!\n\nBạn có chắc chắn muốn tiếp tục?")) {
                        if (confirm("Xác nhận lần cuối: Xóa tất cả dữ liệu chu kỳ, cài đặt và sao lưu?")) {
                            try {
                                // Clear all localStorage
                                localStorage.removeItem("cycles");
                                localStorage.removeItem("cycleSettings");
                                localStorage.removeItem("appPreferences");
                                localStorage.removeItem("cycles_backup");
                                localStorage.removeItem("cycleDraft");

                                // Reset data in memory
                                this.data.cycles = [];
                                this.data.settings = {
                                    averageCycleLength: 28,
                                    averagePeriodLength: 5,
                                    theme: "auto",
                                    notifications: false,
                                    language: "vi",
                                    aiInsights: true,
                                    dataBackup: true,
                                };
                                this.data.preferences = {
                                    animationsEnabled: !isIOSShortcuts(),
                                    hapticFeedback: !isIOSShortcuts(),
                                    soundEffects: false,
                                    privacyMode: false,
                                };

                                // Clear cache
                                this.data.cache = {
                                    lastCalculation: null,
                                    predictions: {},
                                    insights: {},
                                };

                                // Save default data
                                this.saveData();

                                // Update UI
                                this.updateAllSections();

                                // Reset form values
                                $("#cycle-length-setting").val(28);
                                $("#period-length-setting").val(5);
                                $("#theme-switch").prop("checked", false);
                                $("#notification-switch").prop("checked", false);

                                this.showToast("Tất cả dữ liệu đã được xóa! Ứng dụng đã reset về trạng thái ban đầu. 🔄", "warning");

                                console.log("🗑️ All data cleared successfully");
                            } catch (error) {
                                console.error("Clear data failed:", error);
                                this.showToast("Lỗi khi xóa dữ liệu! 😔", "error");
                            }
                        }
                    }
                }

                // ===== NOTIFICATION MANAGEMENT =====
                requestNotificationPermission() {
                    if (!isNotificationSupported()) {
                        this.showToast("Trình duyệt không hỗ trợ thông báo! 📱", "warning");
                        $("#notification-switch").prop("checked", false);
                        this.data.settings.notifications = false;
                        this.saveData();
                        return;
                    }

                    if ("Notification" in window) {
                        if (Notification.permission === "default") {
                            Notification.requestPermission().then((permission) => {
                                if (permission === "granted") {
                                    this.showToast("Thông báo đã được bật! 🔔", "success");

                                    // Test notification
                                    new Notification("Chu Kỳ 🌸", {
                                        body: "Thông báo đã được kích hoạt thành công!",
                                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🌸</text></svg>',
                                    });
                                } else {
                                    this.showToast("Quyền thông báo bị từ chối! 🔕", "warning");
                                    $("#notification-switch").prop("checked", false);
                                    this.data.settings.notifications = false;
                                    this.saveData();
                                }
                            });
                        } else if (Notification.permission === "granted") {
                            this.showToast("Thông báo đã được bật từ trước! 🔔", "info");
                        } else {
                            this.showToast("Quyền thông báo bị từ chối! Vui lòng bật trong cài đặt trình duyệt. 🔕", "warning");
                            $("#notification-switch").prop("checked", false);
                            this.data.settings.notifications = false;
                            this.saveData();
                        }
                    }
                }

                triggerPeriodNotification() {
                    if (this.data.settings.notifications && isNotificationSupported() && "Notification" in window && Notification.permission === "granted") {
                        try {
                            new Notification("Chu kỳ hôm nay! 🌸", {
                                body: "Hôm nay là ngày dự kiến kỳ kinh của bạn. Đừng quên ghi nhận!",
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🌸</text></svg>',
                                tag: "period-today",
                                requireInteraction: true,
                            });
                        } catch (e) {
                            // Nếu lỗi thì bỏ qua, không crash app
                        }
                    }

                    // Show in-app notification
                    this.showToast("Hôm nay là ngày dự kiến kỳ kinh! Hãy ghi nhận nếu đã bắt đầu. 🌸", "info", 8000);
                }

                showLatePeriodAlert(daysLate) {
                    const message = daysLate >= 14 ? "Chu kỳ đã trễ hạn khá lâu. Bạn có thể cần tham khảo ý kiến bác sĩ." : "Chu kỳ đã trễ hạn. Hãy tiếp tục theo dõi.";

                    this.showToast(`${message} (${daysLate} ngày) ⏰`, "warning", 6000);
                }

                // ===== DOCTOR REPORT GENERATION =====
                generateDoctorReport() {
                    try {
                        // Thu thập dữ liệu để tạo báo cáo
                        const stats = this.calculateCycleStats();
                        const detailedStats = this.calculateDetailedStats();
                        const reportDate = new Date();

                        // Tính toán thời gian theo dõi
                        const firstCycle = this.data.cycles.length > 0 ? new Date(this.data.cycles.sort((a, b) => new Date(a.date) - new Date(b.date))[0].date) : null;
                        const trackingDays = firstCycle ? Math.floor((reportDate - firstCycle) / (1000 * 60 * 60 * 24)) : 0;

                        // Phân tích triệu chứng
                        const symptomsAnalysis = this.analyzeSymptoms();
                        const moodAnalysis = this.analyzeMoods();

                        // Tạo nội dung báo cáo
                        const reportContent = this.generateReportContent({
                            stats,
                            detailedStats,
                            reportDate,
                            trackingDays,
                            symptomsAnalysis,
                            moodAnalysis,
                        });

                        // Tạo và tải xuống file
                        this.downloadReport(reportContent, "text");

                        this.showToast("Báo cáo cho bác sĩ đã được tạo! 👩‍⚕️📋", "success");
                    } catch (error) {
                        console.error("Lỗi tạo báo cáo:", error);
                        this.showToast("Lỗi khi tạo báo cáo! Vui lòng thử lại. 😔", "error");
                    }
                }

                analyzeSymptoms() {
                    const symptomCounts = {};
                    let totalSymptomEntries = 0;

                    this.data.cycles.forEach((cycle) => {
                        if (cycle.type === "symptoms" && cycle.symptoms) {
                            totalSymptomEntries++;
                            cycle.symptoms.forEach((symptom) => {
                                symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
                            });
                        }
                    });

                    // Tìm triệu chứng phổ biến nhất
                    const mostCommonSymptom = Object.keys(symptomCounts).reduce((a, b) => (symptomCounts[a] > symptomCounts[b] ? a : b), null);

                    // Chuyển đổi tên triệu chứng sang tiếng Việt
                    const symptomNames = {
                        cramps: "Đau bụng kinh",
                        backache: "Đau lưng",
                        headache: "Đau đầu",
                        fatigue: "Mệt mỏi",
                        acne: "Mụn trứng cá",
                        bloating: "Đầy hơi",
                        "tender-breasts": "Căng ngực",
                        nausea: "Buồn nôn",
                        "mood-swings": "Thay đổi tâm trạng",
                        cravings: "Thèm ăn",
                        insomnia: "Mất ngủ",
                        dizziness: "Chóng mặt",
                    };

                    return {
                        totalEntries: totalSymptomEntries,
                        mostCommon: mostCommonSymptom ? symptomNames[mostCommonSymptom] || mostCommonSymptom : null,
                        mostCommonCount: mostCommonSymptom ? symptomCounts[mostCommonSymptom] : 0,
                        allSymptoms: Object.keys(symptomCounts)
                            .map((symptom) => ({
                                name: symptomNames[symptom] || symptom,
                                count: symptomCounts[symptom],
                                percentage: Math.round((symptomCounts[symptom] / totalSymptomEntries) * 100),
                            }))
                            .sort((a, b) => b.count - a.count),
                    };
                }

                analyzeMoods() {
                    const moodCounts = {};
                    let totalMoodEntries = 0;

                    this.data.cycles.forEach((cycle) => {
                        if (cycle.moods && cycle.moods.length > 0) {
                            totalMoodEntries++;
                            cycle.moods.forEach((mood) => {
                                moodCounts[mood] = (moodCounts[mood] || 0) + 1;
                            });
                        }
                    });

                    const moodNames = {
                        happy: "Vui vẻ",
                        sad: "Buồn bã",
                        angry: "Tức giận",
                        anxious: "Lo lắng",
                        excited: "Phấn khích",
                        calm: "Bình tĩnh",
                        tired: "Mệt mỏi",
                        neutral: "Bình thường",
                    };

                    const dominantMood = Object.keys(moodCounts).reduce((a, b) => (moodCounts[a] > moodCounts[b] ? a : b), null);

                    return {
                        totalEntries: totalMoodEntries,
                        dominant: dominantMood ? moodNames[dominantMood] || dominantMood : null,
                        dominantCount: dominantMood ? moodCounts[dominantMood] : 0,
                        allMoods: Object.keys(moodCounts)
                            .map((mood) => ({
                                name: moodNames[mood] || mood,
                                count: moodCounts[mood],
                                percentage: Math.round((moodCounts[mood] / totalMoodEntries) * 100),
                            }))
                            .sort((a, b) => b.count - a.count),
                    };
                }

                generateReportContent(data) {
                    const { stats, detailedStats, reportDate, trackingDays, symptomsAnalysis, moodAnalysis } = data;

                    // Format ngày
                    const formatDate = (date) => {
                        return date ? new Date(date).toLocaleDateString("vi-VN") : "N/A";
                    };

                    // Xác định tính đều đặn
                    const regularityStatus = stats.isRegular ? "Đều đặn" : "Không đều đặn";
                    const confidenceLevel = stats.confidence >= 80 ? "Cao" : stats.confidence >= 50 ? "Trung bình" : "Thấp";

                    // Phân tích xu hướng
                    const trendAnalysis = stats.trend === "lengthening" ? "Chu kỳ có xu hướng dài hơn" : stats.trend === "shortening" ? "Chu kỳ có xu hướng ngắn hơn" : "Chu kỳ ổn định";

                    // Giai đoạn hiện tại
                    const phaseNames = {
                        menstrual: "Kỳ kinh nguyệt",
                        follicular: "Giai đoạn nang trứng",
                        ovulation: "Thời kỳ rụng trứng",
                        luteal: "Giai đoạn hoàng thể",
                        unknown: "Chưa xác định",
                    };

                    return `
        ╔══════════════════════════════════════════════════════════════════════════════╗
        ║                           BÁO CÁO CHU KỲ KINH NGUYỆT                         ║
        ║                              CHO BÁC SĨ CHUYÊN KHOA                          ║
        ╚══════════════════════════════════════════════════════════════════════════════╝
        
        📋 THÔNG TIN CHUNG
        ═══════════════════════════════════════════════════════════════════════════════
        • Ngày tạo báo cáo: ${formatDate(reportDate)}
        • Thời gian theo dõi: ${trackingDays} ngày (${Math.round(trackingDays / 30)} tháng)
        • Tổng số chu kỳ đã theo dõi: ${stats.totalCycles}
        • Độ tin cậy dự đoán: ${stats.confidence}% (${confidenceLevel})
        • Phiên bản ứng dụng: ${this.version}
        
        🩸 THÔNG TIN CHU KỲ
        ═══════════════════════════════════════════════════════════════════════════════
        • Độ dài chu kỳ trung bình: ${stats.averageCycleLength} ngày
        • Thời gian kinh nguyệt trung bình: ${stats.averagePeriodLength} ngày
        • Tính đều đặn: ${regularityStatus}
        • Độ biến thiên: ${stats.variability ? stats.variability.toFixed(1) : "N/A"} ngày
        • Xu hướng: ${trendAnalysis}
        
        📅 LỊCH SỬ CHU KỲ GẦN ĐÂY
        ═══════════════════════════════════════════════════════════════════════════════
        • Ngày kinh cuối: ${formatDate(stats.lastPeriodDate)}
        • Ngày chu kỳ hiện tại: ${stats.cycleDay || "N/A"}
        • Ngày dự kiến chu kỳ tiếp theo: ${formatDate(stats.nextPeriodDate)}
        • Giai đoạn hiện tại: ${phaseNames[stats.currentPhase] || "Chưa xác định"}
        
        ${stats.cycleLengths && stats.cycleLengths.length > 0
                            ? `
        📊 CHI TIẾT ĐỘ DÀI CHU KỲ (${Math.min(6, stats.cycleLengths.length)} chu kỳ gần nhất)
        ═══════════════════════════════════════════════════════════════════════════════
        ${stats.cycleLengths
                                .slice(-6)
                                .map((length, index) => `• Chu kỳ ${stats.cycleLengths.length - 5 + index}: ${length} ngày`)
                                .join("\n")}
        
        • Chu kỳ ngắn nhất: ${Math.min(...stats.cycleLengths)} ngày
        • Chu kỳ dài nhất: ${Math.max(...stats.cycleLengths)} ngày
        `
                            : "• Chưa có đủ dữ liệu chu kỳ để phân tích"
                        }
        
        🩺 PHÂN TÍCH TRIỆU CHỨNG
        ═══════════════════════════════════════════════════════════════════════════════
        • Tổng số lần ghi nhận triệu chứng: ${symptomsAnalysis.totalEntries}
        • Triệu chứng thường gặp nhất: ${symptomsAnalysis.mostCommon || "Chưa có dữ liệu"}
        ${symptomsAnalysis.mostCommon ? `  (${symptomsAnalysis.mostCommonCount} lần - ${Math.round((symptomsAnalysis.mostCommonCount / symptomsAnalysis.totalEntries) * 100)}%)` : ""}
        
        ${symptomsAnalysis.allSymptoms.length > 0
                            ? `
        📈 TOP TRIỆU CHỨNG THƯỜNG GẶP:
        ${symptomsAnalysis.allSymptoms
                                .slice(0, 5)
                                .map((symptom, index) => `${index + 1}. ${symptom.name}: ${symptom.count} lần (${symptom.percentage}%)`)
                                .join("\n")}
        `
                            : ""
                        }
        
        😊 PHÂN TÍCH TÂM TRẠNG
        ═══════════════════════════════════════════════════════════════════════════════
        • Tổng số lần ghi nhận tâm trạng: ${moodAnalysis.totalEntries}
        • Tâm trạng chủ đạo: ${moodAnalysis.dominant || "Chưa có dữ liệu"}
        ${moodAnalysis.dominant ? `  (${moodAnalysis.dominantCount} lần - ${Math.round((moodAnalysis.dominantCount / moodAnalysis.totalEntries) * 100)}%)` : ""}
        
        ${this.data.cycles.filter((c) => c.type === "sexual-activity").length > 0
                            ? `
        💕 HOẠT ĐỘNG TÌNH DỤC
        ═══════════════════════════════════════════════════════════════════════════════
        • Tổng số lần ghi nhận: ${this.data.cycles.filter((c) => c.type === "sexual-activity").length}
        • Có sử dụng biện pháp bảo vệ: ${this.data.cycles.filter((c) => c.type === "sexual-activity" && c.activity === "protected").length} lần
        • Không sử dụng biện pháp bảo vệ: ${this.data.cycles.filter((c) => c.type === "sexual-activity" && c.activity === "unprotected").length} lần
        `
                            : ""
                        }
        
        ⚠️ CÁC DẤU HIỆU BẤT THƯỜNG (nếu có)
        ═══════════════════════════════════════════════════════════════════════════════
        ${this.detectAbnormalities(stats, detailedStats)}
        
        💡 KHUYẾN NGHỊ CHUYÊN MÔN
        ═══════════════════════════════════════════════════════════════════════════════
        ${this.generateMedicalRecommendations(stats, symptomsAnalysis, moodAnalysis)}
        
        📈 ĐÁNH GIÁ TỔNG THỂ
        ═══════════════════════════════════════════════════════════════════════════════
        • Điểm sức khỏe sinh sản: ${this.calculateHealthScore(stats)}/100
        • Mức độ theo dõi: ${this.getTrackingLevel(trackingDays, stats.totalCycles)}
        • Chất lượng dữ liệu: ${stats.confidence >= 70 ? "Tốt" : stats.confidence >= 40 ? "Trung bình" : "Cần cải thiện"}
        
        ═══════════════════════════════════════════════════════════════════════════════
        📱 Báo cáo được tạo từ ứng dụng "Chu Kỳ" v${this.version}
        🌐 Ứng dụng theo dõi chu kỳ kinh nguyệt thông minh
        📧 Để biết thêm thông tin, vui lòng liên hệ với nhà phát triển
        ═══════════════════════════════════════════════════════════════════════════════
        
        GHI CHÚ QUAN TRỌNG:
        • Báo cáo này chỉ mang tính chất tham khảo
        • Không thay thế cho việc khám và tư vấn trực tiếp với bác sĩ
        • Dữ liệu dựa trên thông tin tự ghi nhận của người dùng
        • Khuyến nghị tham khảo ý kiến bác sĩ chuyên khoa để có chẩn đoán chính xác
        `;
                }

                detectAbnormalities(stats, detailedStats) {
                    const abnormalities = [];

                    // Chu kỳ quá ngắn hoặc quá dài
                    if (stats.averageCycleLength < 21) {
                        abnormalities.push("• Chu kỳ trung bình ngắn hơn bình thường (<21 ngày)");
                    }
                    if (stats.averageCycleLength > 35) {
                        abnormalities.push("• Chu kỳ trung bình dài hơn bình thường (>35 ngày)");
                    }

                    // Biến thiên lớn
                    if (stats.variability > 8) {
                        abnormalities.push("• Chu kỳ có biến thiên lớn (>8 ngày), có thể không đều đặn");
                    }

                    // Kinh nguyệt quá ngắn hoặc quá dài
                    if (stats.averagePeriodLength < 3) {
                        abnormalities.push("• Thời gian kinh nguyệt ngắn hơn bình thường (<3 ngày)");
                    }
                    if (stats.averagePeriodLength > 7) {
                        abnormalities.push("• Thời gian kinh nguyệt dài hơn bình thường (>7 ngày)");
                    }

                    return abnormalities.length > 0 ? abnormalities.join("\n") : "• Không phát hiện dấu hiệu bất thường rõ ràng";
                }

                generateMedicalRecommendations(stats, symptomsAnalysis, moodAnalysis) {
                    const recommendations = [];

                    // Khuyến nghị chung
                    recommendations.push("• Tiếp tục theo dõi chu kỳ đều đặn để có dữ liệu chính xác");

                    if (stats.totalCycles < 3) {
                        recommendations.push("• Cần theo dõi ít nhất 3-6 chu kỳ để có đánh giá chính xác");
                    }

                    if (!stats.isRegular) {
                        recommendations.push("• Khám và tư vấn về chu kỳ không đều đặn");
                        recommendations.push("• Kiểm tra hormone nếu cần thiết");
                    }

                    if (symptomsAnalysis.mostCommon) {
                        if (symptomsAnalysis.mostCommon.includes("Đau")) {
                            recommendations.push("• Tham khảo ý kiến bác sĩ về các triệu chứng đau thường xuyên");
                        }
                    }

                    if (moodAnalysis.dominant && ["Buồn bã", "Lo lắng", "Tức giận"].includes(moodAnalysis.dominant)) {
                        recommendations.push("• Theo dõi và tư vấn về các vấn đề tâm lý liên quan đến chu kỳ");
                    }

                    // Khuyến nghị lối sống
                    recommendations.push("• Duy trì chế độ ăn uống cân bằng, giàu sắt và canxi");
                    recommendations.push("• Tập thể dục đều đặn, tránh căng thẳng");
                    recommendations.push("• Ngủ đủ giấc (7-8 tiếng/đêm)");

                    if (stats.confidence < 50) {
                        recommendations.push("• Ghi nhận dữ liệu chi tiết hơn để tăng độ chính xác dự đoán");
                    }

                    return recommendations.join("\n        ");
                }

                getTrackingLevel(trackingDays, totalCycles) {
                    if (trackingDays < 30) return "Mới bắt đầu";
                    if (trackingDays < 90) return "Ngắn hạn";
                    if (trackingDays < 180) return "Trung hạn";
                    return "Dài hạn";
                }

                downloadReport(content, type = "text") {
                    const timestamp = new Date().toISOString().split("T")[0];
                    const filename = `bao-cao-chu-ky-${timestamp}.txt`;

                    const blob = new Blob([content], {
                        type: "text/plain;charset=utf-8",
                    });
                    const url = URL.createObjectURL(blob);

                    const link = document.createElement("a");
                    link.href = url;
                    link.download = filename;
                    link.style.display = "none";

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    URL.revokeObjectURL(url);
                }

                // ===== UTILITY FUNCTIONS =====
                updateAllSections() {
                    try {
                        this.updateDashboard();
                        if (this.state.activeSection === "stats") {
                            this.updateStats();
                        } else if (this.state.activeSection === "symptoms-analysis") {
                            this.updateSymptomsAnalysis();
                        } else if (this.state.activeSection === "history") {
                            this.updateHistory();
                        } else if (this.state.activeSection === "settings") {
                            this.updateSettings();
                        }
                    } catch (error) {
                        console.error("Update all sections failed:", error);
                    }
                }

                getLocalDateString(dateInput) {
                    if (typeof dateInput === "string") return dateInput;
                    if (dateInput instanceof Date) {
                        const year = dateInput.getFullYear();
                        const month = String(dateInput.getMonth() + 1).padStart(2, "0");
                        const day = String(dateInput.getDate()).padStart(2, "0");
                        return `${year}-${month}-${day}`;
                    }
                    return dateInput;
                }

                createLocalDate(dateString) {
                    if (!dateString) return new Date();
                    const [year, month, day] = dateString.split("-").map(Number);
                    return new Date(year, month - 1, day);
                }

                formatDateDisplay(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString("vi-VN");
                }

                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" });
                }

                getActivityIcon(type) {
                    const icons = {
                        "period-start": "🔴",
                        "period-end": "⚪",
                        symptoms: "📝",
                        ovulation: "🥚",
                        "sexual-activity": "💕",
                    };
                    return icons[type] || "📅";
                }

                getActivityTypeName(type) {
                    const names = {
                        "period-start": "Bắt đầu kinh nguyệt",
                        "period-end": "Kết thúc kinh nguyệt",
                        symptoms: "Triệu chứng",
                        ovulation: "Rụng trứng",
                        "sexual-activity": "Hoạt động tình dục",
                    };
                    return names[type] || "Hoạt động";
                }

                getFlowName(flow) {
                    const flows = {
                        light: "Nhẹ",
                        medium: "Vừa",
                        heavy: "Nhiều",
                    };
                    return flows[flow] || flow;
                }

                getSymptomName(symptom) {
                    const symptoms = {
                        cramps: "Đau bụng",
                        backache: "Đau lưng",
                        headache: "Đau đầu",
                        fatigue: "Mệt mỏi",
                        acne: "Mụn",
                        bloating: "Đầy hơi",
                        "tender-breasts": "Căng ngực",
                        nausea: "Buồn nôn",
                        "mood-swings": "Thay đổi tâm trạng",
                        cravings: "Thèm ăn",
                        insomnia: "Mất ngủ",
                        dizziness: "Chóng mặt",
                    };
                    return symptoms[symptom] || symptom;
                }

                getMoodName(mood) {
                    const moods = {
                        happy: "Vui vẻ",
                        sad: "Buồn",
                        angry: "Tức giận",
                        anxious: "Lo lắng",
                        excited: "Phấn khích",
                        calm: "Bình tĩnh",
                        tired: "Mệt mỏi",
                        neutral: "Bình thường",
                    };
                    return moods[mood] || mood;
                }

                getCurrentPhaseForDate(date, stats) {
                    if (!stats.lastPeriodDate) return "unknown";
                    const daysSince = Math.floor((date - stats.lastPeriodDate) / (1000 * 60 * 60 * 24));
                    if (daysSince <= this.data.settings.averagePeriodLength) {
                        return "menstrual";
                    } else if (daysSince <= Math.floor(stats.averageCycleLength * 0.5)) {
                        return "follicular";
                    } else if (daysSince <= Math.floor(stats.averageCycleLength * 0.6)) {
                        return "ovulation";
                    } else {
                        return "luteal";
                    }
                }

                updateSymptomCount() {
                    const count = $(".symptom-item.selected").length;
                    if (count > 0) {
                        $(".symptoms-section .form-label").html(`
                        <i class="fas fa-notes-medical"></i>
                        Triệu chứng (${count} đã chọn):
                    `);
                    }
                }

                updateMoodCount() {
                    const count = $(".mood-item.selected").length;
                    if (count > 0) {
                        $(".mood-section .form-label").html(`
                        <i class="fas fa-smile"></i>
                        Tâm trạng (${count} đã chọn):
                    `);
                    }
                }

                isDarkTheme() {
                    return document.body.classList.contains("theme-dark") || (document.body.classList.contains("theme-auto") && window.matchMedia("(prefers-color-scheme: dark)").matches);
                }

                // ===== LOADING SCREENS =====
                showLoadingScreen() {
                    try {
                        const loadingMessages = ["Đang khởi tạo ứng dụng...", "Đang tải dữ liệu chu kỳ...", "Đang chuẩn bị giao diện...", "Đang tính toán thống kê..."];

                        let messageIndex = 0;
                        const $loadingText = $("#loading-screen .loading-text div:last-child");

                        // Cycle through loading messages (only if animations enabled)
                        if (this.data.preferences.animationsEnabled) {
                            this.loadingMessageInterval = setInterval(() => {
                                messageIndex = (messageIndex + 1) % loadingMessages.length;
                                $loadingText.fadeOut(200, () => {
                                    $loadingText.text(loadingMessages[messageIndex]).fadeIn(200);
                                });
                            }, 1500);
                        }
                    } catch (error) {
                        console.error("Show loading failed:", error);
                    }
                }

                hideLoadingScreen() {
                    try {
                        if (this.loadingMessageInterval) {
                            clearInterval(this.loadingMessageInterval);
                        }

                        const $loadingScreen = $("#loading-screen");
                        const $mainApp = $("#main-app");

                        // Fade out loading screen (with or without animation)
                        if (this.data.preferences.animationsEnabled) {
                            $loadingScreen.addClass("loading-fade-out");
                            setTimeout(() => {
                                $loadingScreen.hide();
                                $mainApp.show().addClass("app-entering");
                                setTimeout(() => {
                                    $mainApp.removeClass("app-entering");
                                }, 800);
                            }, 500);
                        } else {
                            $loadingScreen.hide();
                            $mainApp.show();
                        }
                    } catch (error) {
                        console.error("Hide loading failed:", error);
                    }
                }

                // ===== ENHANCED PWA SETUP =====
                setupPWA() {
                    console.log("📱 Setting up PWA features...");
                    this.setupAutoBackup();
                    this.setupOfflineDetection();
                    this.setupBackgroundSync();
                }

                setupAutoBackup() {
                    // Thiết lập sao lưu tự động hàng ngày
                    setInterval(() => {
                        this.saveData();
                        console.log("📦 Dữ liệu đã được sao lưu tự động");
                    }, 24 * 60 * 60 * 1000); // 24 giờ
                }

                scheduleAutoBackup() {
                    // Hủy timer cũ nếu có
                    if (this.autoBackupTimer) {
                        clearTimeout(this.autoBackupTimer);
                    }

                    // Tạo backup ngay lập tức
                    this.createAutoBackup();

                    // Lên lịch backup tiếp theo (mỗi 30 phút)
                    this.autoBackupTimer = setTimeout(() => {
                        this.scheduleAutoBackup();
                    }, 30 * 60 * 1000); // 30 phút
                }

                createAutoBackup() {
                    try {
                        const backupData = {
                            cycles: this.data.cycles,
                            settings: this.data.settings,
                            preferences: this.data.preferences,
                            timestamp: new Date().toISOString(),
                            version: this.version,
                        };

                        localStorage.setItem("cycles_backup", JSON.stringify(backupData));
                        console.log("📦 Backup created successfully");
                    } catch (error) {
                        console.error("❌ Failed to create backup:", error);
                    }
                }

                setupOfflineDetection() {
                    window.addEventListener("online", () => {
                        this.state.isOnline = true;
                        this.showToast("Đã kết nối internet! 🌐", "success");
                    });

                    window.addEventListener("offline", () => {
                        this.state.isOnline = false;
                        this.showToast("Mất kết nối internet! Ứng dụng vẫn hoạt động offline. 📱", "warning");
                    });
                }

                setupBackgroundSync() {
                    // Background sync for data persistence
                    if ("serviceWorker" in navigator && "sync" in window.ServiceWorkerRegistration.prototype) {
                        // Register for background sync
                        console.log("📡 Background sync supported");
                    }
                }

                // ===== ENHANCED TOAST NOTIFICATION SYSTEM =====
                showToast(message, type = "info", duration = 4000) {
                    try {
                        // Remove existing toasts of the same type
                        $(`.toast-notification.${type}`).remove();

                        const toastId = `toast-${Date.now()}`;
                        const toast = $(`
                        <div class="toast-notification ${type}" id="${toastId}">
                            <div class="toast-content">
                                <div class="toast-icon">${this.getToastIcon(type)}</div>
                                <div class="toast-message">${message}</div>
                                <button class="toast-close" aria-label="Đóng">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="toast-progress">
                                <div class="toast-progress-bar"></div>
                            </div>
                        </div>
                    `);

                        // Add to DOM with animation
                        $("body").append(toast);

                        // Trigger entrance animation
                        setTimeout(() => toast.addClass("toast-visible"), 10);

                        // Start progress bar animation
                        const $progressBar = toast.find(".toast-progress-bar");
                        setTimeout(() => {
                            $progressBar.css("transition", `width ${duration}ms linear`);
                            $progressBar.css("width", "100%");
                        }, 100);

                        // Auto remove
                        const autoRemoveTimer = setTimeout(() => {
                            this.removeToast(toastId);
                        }, duration);

                        // Manual close handler
                        toast.find(".toast-close").on("click", () => {
                            clearTimeout(autoRemoveTimer);
                            this.removeToast(toastId);
                        });

                        // Click to dismiss (except for error/warning types)
                        if (!["error", "warning"].includes(type)) {
                            toast.on("click", () => {
                                clearTimeout(autoRemoveTimer);
                                this.removeToast(toastId);
                            });
                        }

                        // Add haptic feedback
                        this.triggerHapticFeedback(type === "error" ? "error" : "light");

                        // Stack management - limit to 3 toasts
                        const $allToasts = $(".toast-notification");
                        if ($allToasts.length > 3) {
                            this.removeToast($allToasts.first().attr("id"));
                        }
                    } catch (error) {
                        console.error("Toast failed:", error);
                    }
                }

                getToastIcon(type) {
                    const icons = {
                        info: "💡",
                        success: "✅",
                        warning: "⚠️",
                        error: "❌",
                    };
                    return icons[type] || "💡";
                }

                removeToast(toastId) {
                    const $toast = $(`#${toastId}`);
                    if ($toast.length) {
                        $toast.removeClass("toast-visible").addClass("toast-removing");
                        setTimeout(() => $toast.remove(), 300);
                    }
                }

                // ===== UTILITY FUNCTIONS =====
                debounce(func, wait, immediate = false) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            if (!immediate) func.apply(this, args);
                        };
                        const callNow = immediate && !timeout;
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                        if (callNow) func.apply(this, args);
                    };
                }

                triggerHapticFeedback(type = "light") {
                    if (!this.data.preferences.hapticFeedback) return;

                    if (navigator.vibrate) {
                        const patterns = {
                            light: [50],
                            medium: [100],
                            heavy: [200],
                            success: [50, 50, 100],
                            error: [100, 50, 100, 50, 100],
                        };

                        navigator.vibrate(patterns[type] || patterns.light);
                    }
                }

                // ===== MISSING UTILITY FUNCTIONS =====
                getShortestCycle(periodStarts) {
                    const lengths = this.calculateCycleLengthsFromStarts(periodStarts);
                    return lengths.length > 0 ? Math.min(...lengths) : null;
                }

                getLongestCycle(periodStarts) {
                    const lengths = this.calculateCycleLengthsFromStarts(periodStarts);
                    return lengths.length > 0 ? Math.max(...lengths) : null;
                }

                calculateCycleLengthsFromStarts(periodStarts) {
                    const lengths = [];
                    for (let i = 1; i < periodStarts.length; i++) {
                        const diff = Math.floor((new Date(periodStarts[i].date) - new Date(periodStarts[i - 1].date)) / (1000 * 60 * 60 * 24));
                        if (diff > 0 && diff <= 45) {
                            lengths.push(diff);
                        }
                    }
                    return lengths;
                }

                calculateCycleVariability(periodStarts) {
                    const lengths = this.calculateCycleLengthsFromStarts(periodStarts);
                    if (lengths.length < 2) return 0;

                    const mean = lengths.reduce((a, b) => a + b, 0) / lengths.length;
                    const variance = lengths.reduce((sum, length) => sum + Math.pow(length - mean, 2), 0) / lengths.length;
                    return Math.sqrt(variance);
                }

                getMostCommonSymptom(symptomsData) {
                    const symptomCounts = {};

                    symptomsData.forEach((entry) => {
                        if (entry.symptoms) {
                            entry.symptoms.forEach((symptom) => {
                                symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
                            });
                        }
                    });

                    return Object.keys(symptomCounts).reduce((a, b) => (symptomCounts[a] > symptomCounts[b] ? a : b), null);
                }

                calculateSymptomFrequency(symptomsData) {
                    const symptomCounts = {};
                    let totalEntries = symptomsData.length;

                    symptomsData.forEach((entry) => {
                        if (entry.symptoms) {
                            entry.symptoms.forEach((symptom) => {
                                symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
                            });
                        }
                    });

                    // Convert to percentages
                    const frequencies = {};
                    Object.keys(symptomCounts).forEach((symptom) => {
                        frequencies[symptom] = Math.round((symptomCounts[symptom] / totalEntries) * 100);
                    });

                    return frequencies;
                }

                calculateTrackingStreak() {
                    // Calculate consecutive days of tracking
                    const today = new Date();
                    let streak = 0;

                    for (let i = 0; i < 365; i++) {
                        const checkDate = new Date(today);
                        checkDate.setDate(today.getDate() - i);
                        const dateString = this.getLocalDateString(checkDate);

                        const hasData = this.data.cycles.some((c) => c.date === dateString);

                        if (hasData) {
                            streak++;
                        } else if (i > 7) {
                            // Allow for gaps in recent days
                            break;
                        }
                    }

                    return streak;
                }

                calculateDataCompleteness() {
                    // Calculate what percentage of expected data is present
                    const periodStarts = this.data.cycles.filter((c) => c.type === "period-start");
                    if (periodStarts.length === 0) return 0;

                    const firstPeriod = new Date(periodStarts[0].date);
                    const today = new Date();
                    const daysSinceFirst = Math.floor((today - firstPeriod) / (1000 * 60 * 60 * 24));

                    const expectedEntries = Math.floor(daysSinceFirst / 7); // Expect at least weekly entries
                    const actualEntries = this.data.cycles.length;

                    return Math.min(Math.round((actualEntries / expectedEntries) * 100), 100);
                }

                // ===== ENHANCED ERROR HANDLING =====
                handleInitializationError(error) {
                    try {
                        console.error("Initialization failed:", error);

                        document.getElementById("loading-screen").innerHTML = `
                        <div style="text-align: center; color: white; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: #ff6b6b;"></i>
                            <h2>Lỗi khởi tạo ứng dụng</h2>
                            <p style="margin: 1rem 0;">Đã xảy ra lỗi khi khởi tạo ứng dụng.</p>
                            <button onclick="location.reload()" style="padding: 0.8rem 2rem; background: #ff6b6b; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem;">
                                Tải lại ứng dụng
                            </button>
                        </div>
                    `;
                    } catch (e) {
                        console.error("Error handling failed:", e);
                    }
                }

                handleDataError(error) {
                    console.error("Data error:", error);

                    // Try to recover from backup
                    this.recoverFromBackup().then((recovered) => {
                        if (!recovered) {
                            this.showToast("Lỗi dữ liệu! Đã khôi phục cài đặt mặc định. 🔄", "warning");
                            this.resetToDefaults();
                        }
                    });
                }

                async recoverFromBackup() {
                    try {
                        const backup = localStorage.getItem("cycles_backup");
                        if (backup) {
                            const backupData = JSON.parse(backup);
                            this.data.cycles = this.validateCyclesData(backupData.cycles || []);
                            this.saveData();
                            console.log("📦 Recovered from backup");
                            return true;
                        }
                    } catch (error) {
                        console.error("Backup recovery failed:", error);
                    }
                    return false;
                }

                resetToDefaults() {
                    this.data.cycles = [];
                    this.data.settings = {
                        averageCycleLength: 28,
                        averagePeriodLength: 5,
                        theme: "auto",
                        notifications: false,
                        language: "vi",
                        aiInsights: true,
                        dataBackup: true,
                    };
                    this.saveData();
                }

                // ===== SETUP MISSING FUNCTIONS =====
                setupEventListeners() {
                    console.log("Setting up event listeners...");
                    // Event listeners are set up in individual setup methods
                }

                setupTouchGestures() {
                    console.log("Touch gestures initialized");
                    // Touch gestures are set up in calendar and form methods
                }

                setupTooltipsAndHelp() {
                    console.log("Tooltips and help system initialized");
                    // Can be extended with actual tooltip implementation
                }

                setupAccessibility() {
                    console.log("Accessibility features initialized");
                    // Can be extended with ARIA labels and keyboard navigation
                }

                setupPerformanceUI() {
                    console.log("Performance monitoring UI initialized");
                    // Can be extended with performance metrics display
                }

                setupPerformanceMonitoring() {
                    console.log("Performance monitoring initialized");
                    // Performance metrics are tracked in this.performance object
                }

                loadCachedData() {
                    console.log("Cached data loaded");
                    // Cache is managed in calculateCycleStats method
                }

                showWelcomeMessage() {
                    if (this.data.cycles.length === 0) {
                        setTimeout(() => {
                            this.showToast("Chào mừng bạn đến với Chu Kỳ! Hãy bắt đầu ghi nhận chu kỳ của bạn. 🌸", "info", 6000);
                        }, 2000);
                    }
                }

                checkAchievements() {
                    // Check for tracking milestones
                    const totalEntries = this.data.cycles.length;
                    const milestones = [1, 5, 10, 25, 50, 100];

                    milestones.forEach((milestone) => {
                        if (totalEntries === milestone) {
                            this.showToast(`🎉 Chúc mừng! Bạn đã ghi nhận ${milestone} hoạt động!`, "success", 5000);
                        }
                    });
                }

                showFormHelp() {
                    // Can be extended with contextual help
                    console.log("Form help displayed");
                }
            }

            // ===== AI INSIGHTS CLASS =====
            class AIInsights {
                constructor() {
                    this.insights = [];
                    this.patterns = {};
                    this.recommendations = [];
                }

                async initialize(cycles) {
                    try {
                        console.log("🤖 Initializing AI insights...");
                        this.analyzeCycles(cycles);
                        this.generateInsights();
                        this.generateRecommendations();
                    } catch (error) {
                        console.error("AI initialization failed:", error);
                    }
                }

                analyzeCycles(cycles) {
                    // Pattern recognition for symptoms
                    this.analyzeSymptomPatterns(cycles);

                    // Mood correlation analysis
                    this.analyzeMoodPatterns(cycles);

                    // Cycle irregularity detection
                    this.analyzeIrregularities(cycles);

                    // Seasonal patterns
                    this.analyzeSeasonalPatterns(cycles);
                }

                analyzeSymptomPatterns(cycles) {
                    const symptomsByPhase = {
                        menstrual: {},
                        follicular: {},
                        ovulation: {},
                        luteal: {},
                    };

                    cycles
                        .filter((c) => c.type === "symptoms" && c.symptoms)
                        .forEach((cycle) => {
                            const phase = this.determinePhaseForDate(cycle.date, cycles);
                            if (phase && symptomsByPhase[phase]) {
                                cycle.symptoms.forEach((symptom) => {
                                    symptomsByPhase[phase][symptom] = (symptomsByPhase[phase][symptom] || 0) + 1;
                                });
                            }
                        });

                    this.patterns.symptoms = symptomsByPhase;
                }

                analyzeMoodPatterns(cycles) {
                    const moodsByPhase = {
                        menstrual: {},
                        follicular: {},
                        ovulation: {},
                        luteal: {},
                    };

                    cycles
                        .filter((c) => c.type === "symptoms" && c.moods)
                        .forEach((cycle) => {
                            const phase = this.determinePhaseForDate(cycle.date, cycles);
                            if (phase && moodsByPhase[phase]) {
                                cycle.moods.forEach((mood) => {
                                    moodsByPhase[phase][mood] = (moodsByPhase[phase][mood] || 0) + 1;
                                });
                            }
                        });

                    this.patterns.moods = moodsByPhase;
                }

                analyzeIrregularities(cycles) {
                    const periodStarts = cycles.filter((c) => c.type === "period-start").sort((a, b) => new Date(a.date) - new Date(b.date));

                    const irregularities = [];

                    for (let i = 1; i < periodStarts.length; i++) {
                        const daysDiff = Math.floor((new Date(periodStarts[i].date) - new Date(periodStarts[i - 1].date)) / (1000 * 60 * 60 * 24));

                        if (daysDiff < 21) {
                            irregularities.push({
                                type: "short_cycle",
                                date: periodStarts[i].date,
                                days: daysDiff,
                                severity: daysDiff < 15 ? "high" : "medium",
                            });
                        } else if (daysDiff > 35) {
                            irregularities.push({
                                type: "long_cycle",
                                date: periodStarts[i].date,
                                days: daysDiff,
                                severity: daysDiff > 45 ? "high" : "medium",
                            });
                        }
                    }

                    this.patterns.irregularities = irregularities;
                }

                analyzeSeasonalPatterns(cycles) {
                    const seasonalData = {
                        spring: { cycles: 0, avgLength: 0, symptoms: {} },
                        summer: { cycles: 0, avgLength: 0, symptoms: {} },
                        autumn: { cycles: 0, avgLength: 0, symptoms: {} },
                        winter: { cycles: 0, avgLength: 0, symptoms: {} },
                    };

                    this.patterns.seasonal = seasonalData;
                }

                generateInsights() {
                    this.insights = [];

                    // Generate insights based on patterns
                    this.generateSymptomInsights();
                    this.generateMoodInsights();
                    this.generateIrregularityInsights();
                    this.generateTrendInsights();
                }

                generateSymptomInsights() {
                    const symptoms = this.patterns.symptoms;

                    Object.keys(symptoms).forEach((phase) => {
                        const phaseSymptoms = symptoms[phase];
                        const mostCommon = Object.keys(phaseSymptoms).reduce((a, b) => (phaseSymptoms[a] > phaseSymptoms[b] ? a : b), "");

                        if (mostCommon && phaseSymptoms[mostCommon] >= 3) {
                            this.insights.push({
                                type: "symptom_pattern",
                                phase,
                                symptom: mostCommon,
                                frequency: phaseSymptoms[mostCommon],
                                message: this.getSymptomInsightMessage(phase, mostCommon),
                                priority: "medium",
                            });
                        }
                    });
                }

                generateMoodInsights() {
                    const moods = this.patterns.moods;

                    Object.keys(moods).forEach((phase) => {
                        const phaseMoods = moods[phase];
                        const dominant = Object.keys(phaseMoods).reduce((a, b) => (phaseMoods[a] > phaseMoods[b] ? a : b), "");

                        if (dominant && phaseMoods[dominant] >= 3) {
                            this.insights.push({
                                type: "mood_pattern",
                                phase,
                                mood: dominant,
                                frequency: phaseMoods[dominant],
                                message: this.getMoodInsightMessage(phase, dominant),
                                priority: "low",
                            });
                        }
                    });
                }

                generateIrregularityInsights() {
                    const irregularities = this.patterns.irregularities;

                    if (irregularities.length > 0) {
                        const recent = irregularities.filter((i) => {
                            const date = new Date(i.date);
                            const threeMonthsAgo = new Date();
                            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                            return date >= threeMonthsAgo;
                        });

                        if (recent.length >= 2) {
                            this.insights.push({
                                type: "irregularity_warning",
                                count: recent.length,
                                message: "Bạn đã có một số chu kỳ không đều đặn gần đây. Hãy theo dõi thêm và tham khảo ý kiến bác sĩ nếu cần.",
                                priority: "high",
                            });
                        }
                    }
                }

                generateTrendInsights() {
                    this.insights.push({
                        type: "general_health",
                        message: "Việc theo dõi chu kỳ đều đặn giúp bạn hiểu rõ hơn về sức khỏe sinh sản.",
                        priority: "low",
                    });
                }

                generateRecommendations() {
                    this.recommendations = [
                        {
                            type: "lifestyle",
                            title: "Chế độ ăn uống",
                            description: "Bổ sung thực phẩm giàu sắt trong kỳ kinh nguyệt",
                            priority: "medium",
                        },
                        {
                            type: "exercise",
                            title: "Vận động",
                            description: "Tập yoga nhẹ có thể giảm đau bụng kinh",
                            priority: "low",
                        },
                        {
                            type: "tracking",
                            title: "Theo dõi",
                            description: "Ghi nhận triệu chứng hàng ngày để có dự đoán chính xác hơn",
                            priority: "high",
                        },
                    ];
                }

                getDailyInsight() {
                    const highPriority = this.insights.filter((i) => i.priority === "high");
                    const mediumPriority = this.insights.filter((i) => i.priority === "medium");
                    const lowPriority = this.insights.filter((i) => i.priority === "low");

                    if (highPriority.length > 0) {
                        return highPriority[Math.floor(Math.random() * highPriority.length)];
                    } else if (mediumPriority.length > 0) {
                        return mediumPriority[Math.floor(Math.random() * mediumPriority.length)];
                    } else if (lowPriority.length > 0) {
                        return lowPriority[Math.floor(Math.random() * lowPriority.length)];
                    }

                    return {
                        type: "encouragement",
                        message: "Hôm nay là một ngày tuyệt vời để chăm sóc bản thân! 🌸",
                        priority: "low",
                    };
                }

                getSymptomInsightMessage(phase, symptom) {
                    const messages = {
                        menstrual: {
                            cramps: "Đau bụng thường xuyên trong kỳ kinh. Hãy thử chườm ấm hoặc tập thở sâu.",
                            fatigue: "Mệt mỏi trong kỳ kinh là bình thường. Hãy nghỉ ngơi đầy đủ.",
                            headache: "Đau đầu có thể do thay đổi hormone. Uống đủ nước và nghỉ ngơi.",
                        },
                        ovulation: {
                            "tender-breasts": "Căng ngực quanh thời kỳ rụng trứng là dấu hiệu bình thường.",
                            bloating: "Đầy hơi có thể xảy ra do thay đổi hormone khi rụng trứng.",
                        },
                    };

                    return messages[phase]?.[symptom] || `Bạn thường có ${symptom} trong giai đoạn ${phase}.`;
                }

                getMoodInsightMessage(phase, mood) {
                    const messages = {
                        luteal: {
                            anxious: "Lo lắng trước kỳ kinh là phổ biến. Hãy thử thiền hoặc tập thở.",
                            sad: "Buồn bã trước kỳ kinh có thể do PMS. Hoạt động nhẹ nhàng có thể giúp ích.",
                        },
                        menstrual: {
                            tired: "Mệt mỏi trong kỳ kinh là bình thường. Hãy lắng nghe cơ thể và nghỉ ngơi.",
                        },
                    };

                    return messages[phase]?.[mood] || `Tâm trạng ${mood} thường xuất hiện trong giai đoạn ${phase}.`;
                }

                determinePhaseForDate(date, cycles) {
                    // Implementation to determine cycle phase for a specific date
                    return "menstrual"; // Simplified for now
                }
            }

            // ===== DOCUMENT READY =====
            $(document).ready(function () {
                try {
                    // Setup basic form interactions
                    $(document).on("click", ".symptom-item, .mood-item, .activity-option", function () {
                        $(this).toggleClass("selected");
                    });

                    $(document).on("click", "#show-all-symptoms", function () {
                        $("#symptoms-grid .symptom-item.hidden").removeClass("hidden");
                        $(this).hide();
                    });

                    $(document).on("click", "#show-all-moods", function () {
                        $("#mood-grid .mood-item.hidden").removeClass("hidden");
                        $(this).hide();
                    });

                    // Day detail modal close handler
                    $("#day-detail-close").on("click", () => {
                        $("#day-detail-modal").removeClass("active");
                    });

                    // Initialize the app
                    window.cycleTracker = new CycleTracker();

                    console.log("✅ App initialization completed");
                } catch (error) {
                    console.error("❌ Document ready failed:", error);

                    // Fallback error display
                    setTimeout(() => {
                        if (!window.cycleTracker || !window.cycleTracker.isInitialized) {
                            document.body.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #e91e63;">
                                <h2>🌸 Chu Kỳ</h2>
                                <p>Đang tải ứng dụng...</p>
                                <button onclick="location.reload()" style="padding: 10px 20px; background: #e91e63; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Tải lại
                                </button>
                            </div>
                        `;
                        }
                    }, 3000);
                }
            });
        </script>
    </body>
</html>